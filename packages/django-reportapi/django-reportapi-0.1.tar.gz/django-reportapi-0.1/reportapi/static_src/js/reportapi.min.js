var TIMEOUT_PROGRESS=1000;window.TEMPLATES={};_.mixin(_.str.exports());function isEmpty(b){for(var a in b){return false}return true}delay=(function(){var a=0;return function(c,b){if(DEBUG){console.log("function:delay "+b)}clearTimeout(a);a=setTimeout(c,b)}})();function generatorID(d,g){if(DEBUG){console.log("function:generatorID")}var b=[],e="i",a=1000,f=9999,c=Math.floor(Math.random()*(f-a+1))+a;e+=$.now()+String(c);if(d){b.push(d)}b.push(e);if(g){b.push(g)}return validatorID(b)}function validatorID(a){if($.type(a)==="array"){a=a.join("_")}if(DEBUG){console.log("function:validatorID")}return a.replace(/[\.,\:,\/, ,\(,\),=,?]/g,"-")}function handlerHideAlert(){if(DEBUG){console.log("function:handlerHideAlert")}$(".alert").alert("close");$("#alert-place").css("z-index","-1000")}function handlerShowAlert(c,a,d,b){if(DEBUG){console.log("function:handlerShowAlert")}b=b||5000;console.log(c);if(!a){a="alert-danger"}html=TEMPLATES.alert({msg:c,type:a});$("#alert-place").css("z-index","1000").html(html);$(window).scrollTop(0);$(".alert").alert();if(d){delay(d,b)}else{delay(handlerHideAlert,b)}return false}function jsonAPI(a,f,d,b,c){if(DEBUG){console.log("function:jsonAPI")}if(!a){a={method:"reportapi.get_scheme"}}if(!f){f=function(h,g,i){}}var e=$.ajax({type:"POST",async:!b,timeout:c||AJAX_TIMEOUT,url:REPORTAPI_API_URL,data:{jsonData:$.toJSON(a),language:window.LANGUAGE_CODE},dataType:"json"}).fail(function(i,g,h){if(i.getResponseHeader("Location")){location=i.getResponseHeader("Location").replace(/\?.*$/,"?next="+window.location.pathname);window.location.replace(location);console.log("1:"+i.getResponseHeader("Location"))}else{console.log("ERROR:"+i.responseText);if(i.responseText){handlerShowAlert(_(i.responseText).truncate(255),"alert-danger")}}}).done(function(h,g,i){if(d){if(DEBUG){console.log(d)}}if((h.status>=300)&&(h.status<400)&&(h.data.Location!=undefined)){redirect=function(){location=h.data.Location.replace(/\?.*$/,"?next="+window.location.pathname);window.location.replace(location)};if(h.message){handlerShowAlert(h.message,"alert-danger",redirect)}else{redirect()}}else{if(h.status>=400){handlerShowAlert(h.message,"alert-danger")}else{if(DEBUG){o=new Object;$.extend(true,o,h.data);console.log($.toJSON(h.message))}return f(h,g,i)}}});return e}function handlerCreateReport(a){if(DEBUG){console.log("function:handlerCreateReport")}filters={};$.each(window.REPORT.filters,function(c,d){if(d.condition||d.value!=null){filters[d.name]={condition:d.condition,value:d.value}}});args={method:"reportapi.create_document",section:window.REPORT.section,name:window.REPORT.name,filters:filters,force:a,};cb=function(d,c,e){handlerStartProgress(d.data)};var b=jsonAPI(args,cb);return b}function eventCreateReport(a){if(DEBUG){console.log("function:eventCreateReport")}handlerCreateReport()}function eventRecreateReport(a){if(DEBUG){console.log("function:eventRecreateReport")}handlerCreateReport(true)}function handlerCheckProcess(){if(DEBUG){console.log("function:handlerCheckProcess")}args={method:"reportapi.document_info",id:window.REPORT.id,};cb=function(c,b,d){$obj=$(".progress .progress-bar");max=Number($obj.attr("aria-valuemax"));now=Number($obj.attr("aria-valuetransitiongoal"));if(c.data.end){clearInterval(window.REPORT.process);window.REPORT.process=undefined;$obj.attr("aria-valuetransitiongoal",max).progressbar();url=c.data.url+window.REPORT.format.toLowerCase()+"/";$(".action-download").attr("href",url).prop("disabled",false).show();$(".action-preview").attr("onClick","handlerShowDocument('"+c.data.url+"', 'document-"+c.data.id+"')").prop("disabled",false).show();$(".progress").removeClass("progress-striped").removeClass("active").hide();$obj.attr("aria-valuetransitiongoal",0).progressbar();if(window.REPORT.create_force){$(".action-create-report:visible").hide();$(".action-recreate-report:hidden").show()}else{$(".action-create-report").prop("disabled",true)}}else{if(now>=max){$(".progress").addClass("progress-striped").addClass("active")}else{$obj.attr("aria-valuetransitiongoal",TIMEOUT_PROGRESS+now).progressbar()}}};var a=jsonAPI(args,cb);return a}function handlerStartProgress(a){if(DEBUG){console.log("function:handlerStartProgress")}$(".action-create-report").prop("disabled",true);$(".progress .progress-bar").attr("aria-valuemax",a.timeout||5000).attr("aria-valuetransitiongoal",0).progressbar();$(".progress").show();window.REPORT.id=a.id;window.REPORT.timeout=a.timeout;window.REPORT.process=setInterval(function(){handlerCheckProcess()},window.TIMEOUT_PROGRESS)}function handlerSetSelectizers(a){if(DEBUG){console.log("function:handlerSetSelectizers")}a=a||$("body");$.each(a.find('select[data-type="object"]'),function(c,b){data=$(b).data()||{};type=data.type;filter_name=b.name;if(filter_name){filter=window.REPORT.filters[filter_name];unicode_key=filter.unicode_key||"__unicode__";$(b).selectize({valueField:"pk",labelField:unicode_key,searchField:unicode_key,create:false,maxItems:(filter.condition=="range")?2:undefined,render:{option:function(e,d){return'<div><span class="pull-right"> #'+d(e.pk)+"</span><span>"+d(e[unicode_key])+"</span></div>"}},load:function(d,e){$.ajax({type:"POST",timeout:window.AJAX_TIMEOUT,url:REPORTAPI_API_URL,data:{jsonData:$.toJSON({method:"reportapi.object_search",section:window.REPORT.section||null,name:window.REPORT.name,filter_name:filter_name,query:d,}),language:window.LANGUAGE_CODE},dataType:"json",error:function(){e()},success:function(f){console.log(f);e(f.data.object_list)}})},onChange:function(d){filter.value=d||null;handlerCheckRequiredValue()},onClear:function(){filter.value=null;handlerCheckRequiredValue()}})}})}function handlerMaskInputs(a){if(DEBUG){console.log("function:handlerMaskInputs")}a=a||$("body");$.mask.definitions["1"]="[0-1]";$.mask.definitions["2"]="[0-2]";$.mask.definitions["3"]="[0-3]";$.mask.definitions["5"]="[0-5]";$.each(a.find("[data-mask]"),function(b,c){$item=$(c);data=$(c).data();$item.mask(data.mask,{completed:function(){report=REPORT.filters[this.context.name];report.value=this.val();if(report.condition=="range"){report.value=report.value.split(RANGE_SPLIT)}}})});return true}function handlerCheckRequiredValue(){if(DEBUG){console.log("function:handlerCheckRequiredValue")}completed=true;$.each(REPORT.filters,function(a,b){if((b.required)&&(b.value===null||b.value===undefined)){completed=false}});if(completed){$(".action-create-report").prop("disabled",false)}else{$(".action-create-report").prop("disabled",true)}return completed}function eventChangeValue(a){if(DEBUG){console.log("function:eventChangeValue")}value=$(a.target).val();report=REPORT.filters[a.target.name];if(a.target.type=="checkbox"){report.value=a.target.checked}else{report.value=value||null}$(".progress:visible").hide();$(".progress:visible .progress-bar").attr("aria-valuetransitiongoal",0).progressbar();$(".action-preview:visible").hide();$(".action-download:visible").hide();$(".action-recreate-report:visible").hide();$(".action-create-report:hidden").show();handlerCheckRequiredValue()}function eventConditionChange(a){if(DEBUG){console.log("function:eventConditionChange")}filter_name=$(a.target).data()["name"];filter=REPORT.filters[filter_name];filter.condition=a.target.value||null;console.log(filter.condition);if(filter.condition in {isnull:0,empty:0}){filter.value=false}else{if(!filter.condition||filter.type=="object"){filter.value=null}else{filter.value=$("#value-"+filter_name).val()||null}}html=TEMPLATES.filter({data:filter});$("#valuebox-"+filter_name).html(html);handlerSetSelectizers($("#valuebox-"+filter_name));handlerMaskInputs($("#valuebox-"+filter_name));$(".progress:visible").hide();$(".progress:visible .progress-bar").attr("aria-valuetransitiongoal",0).progressbar();$(".action-preview:visible").hide();$(".action-download:visible").hide();$(".action-recreate-report:visible").hide();$(".action-create-report:hidden").show();handlerCheckRequiredValue();return true}function keyDownIsControl(a){if(DEBUG){console.log("function:keyDownIsControl")}if((a.which==8)||(a.which==9)||(a.which==13)||(a.which==27)||(a.which>=33&&a.which<=46)||(a.which>=112&&a.which<=145)){return true}return false}function eventKeyDownOnDateTime(a){if(DEBUG){console.log("function:eventKeyDownOnDateTime")}prepare=function(b){value=b.target.value||"";console.log(value,b.charCode)};if(keyDownIsControl(a)){return true}else{if(a.which>=48&&a.which<=57){prepare(a);return true}}return false}function eventKeyDownOnNumber(a){adddot=function(b){value=b.target.value||"";if(value.length<1){b.target.value="0."}else{if(value.indexOf(".")<0){b.target.value=b.target.value+"."}}};if((a.which>=48&&a.which<=57)||keyDownIsControl(a)){return true}else{if(a.which==188||a.which==190){adddot(a);return false}}return false}function handlerShowDocument(a,b){if(DEBUG){console.log("function:handlerShowDocument")}var c=window.open(a,b,"height=500,width=800,resizable=yes,scrollbars=yes");c.focus()}function handlerShowDocument(a,b){if(DEBUG){console.log("function:handlerShowDocument")}var c=window.open(a,b,"height=500,width=800,resizable=yes,scrollbars=yes");c.focus()}function handlerShowAdditionalFilters(){if(DEBUG){console.log("function:handlerShowAdditionalFilters")}$(".additional-filter").show();$("button.action-hide-additional").show();$("button.action-show-additional").hide();return true}function handlerHideAdditionalFilters(){if(DEBUG){console.log("function:handlerHideAdditionalFilters")}$(".additional-filter").hide();$("button.action-hide-additional").hide();$("button.action-show-additional").show();return true}function handlerTemplates(){if(DEBUG){console.log("function:handlerTemplates")}TEMPLATES.alert=_.template($("#underscore-alert").html());TEMPLATES.filter=_.template($("#underscore-filter").html());return true}function handlerBindinds(){if(DEBUG){console.log("function:handlerBindinds")}$("body").on("click",'button.close[data-dismiss="alert"]',function(){$("#alert-place").css("z-index","-1000")});$("body").on("change",'select[id^="condition-"]',eventConditionChange);$("body").on("keydown",'input[data-validate="number"]',eventKeyDownOnNumber);$("body").on("change",'input[id^="value-"]',eventChangeValue);$("body").on("click",".action-hide-additional",handlerHideAdditionalFilters);$("body").on("click",".action-show-additional",handlerShowAdditionalFilters);$("body").on("click",".action-create-report",eventCreateReport);$("body").on("click",".action-recreate-report",eventRecreateReport);return true}$(document).ready(function(a){if(DEBUG){console.log("function:$(document).ready")}handlerTemplates();a("alert").alert();a(".dropdown-toggle").dropdown();handlerBindinds();handlerHideAdditionalFilters()});
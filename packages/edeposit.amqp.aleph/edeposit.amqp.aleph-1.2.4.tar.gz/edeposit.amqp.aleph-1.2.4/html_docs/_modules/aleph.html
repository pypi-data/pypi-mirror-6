<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>aleph</title>
    
    <link rel="stylesheet" href="../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
      <div class="header"><img class="rightlogo" src="../_static/nkp_logo.png" alt="Logo"/><h1 class="heading"><a href="../index.html">
          <span></span></a></h1>
        <h2 class="heading"><span>aleph</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for aleph</h1><div class="highlight"><pre>
<span class="c">#! /usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">#</span>
<span class="c"># Interpreter version: python 2.7</span>
<span class="c">#</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Query workflow</span>
<span class="sd">==============</span>

<span class="sd">To query Aleph, just create one of the Queries - :class:`ISBNQuery` for example</span>
<span class="sd">and put it into :class:`aleph.datastructures.requests.SearchRequest` wrapper.</span>
<span class="sd">Then encode it by calling :func:`serialize` and send the message to the Aleph&#39;s</span>
<span class="sd">exchange::</span>

<span class="sd">    isbnq = ISBNQuery(&quot;80-251-0225-4&quot;)</span>
<span class="sd">    request = SearchRequest(isbnq)</span>

<span class="sd">    amqp.send(</span>
<span class="sd">        message    = serialize(request),</span>
<span class="sd">        properties = &quot;..&quot;,</span>
<span class="sd">        exchange   = &quot;ALEPH&#39;S_EXCHANGE&quot;</span>
<span class="sd">    )</span>

<span class="sd">and you will get back AMQP message, and after decoding with fromAMQPMessage()</span>
<span class="sd">also SearchResult.</span>

<span class="sd">Note:</span>
<span class="sd">    You don&#39;t have to import all structures from :class:`datastructures`, they</span>
<span class="sd">    should be automatically imported and made global in ``__init__.py``.</span>

<span class="sd">If you want to just get count of how many items is there in Aleph, just wrap</span>
<span class="sd">the ISBNQuery with :class:`CountRequest`::</span>

<span class="sd">    isbnq = ISBNQuery(&quot;80-251-0225-4&quot;)</span>
<span class="sd">    request = CountRequest(isbnq)</span>

<span class="sd">    # rest is same..</span>

<span class="sd">and you will get back (after decoding)</span>
<span class="sd">:class:`aleph.datastructures.results.CountResult`.</span>

<span class="sd">Note:</span>
<span class="sd">    You should always use CountRequest instead of just calling ``len()` to</span>
<span class="sd">    SearchResult.records - it doesn&#39;t put that much load to Aleph. Also Aleph</span>
<span class="sd">    is restricted to 150 requests per second.</span>

<span class="sd">Here is ASCII flow diagram for you::</span>

<span class="sd"> ISBNQuery      ----.                                 ,--&gt; CountResult</span>
<span class="sd"> AuthorQuery    ----|                                 |       `- num_of_records</span>
<span class="sd"> PublisherQuery ----|                                 |</span>
<span class="sd"> GenericQuery   ----|      ISBNValidationRequest      |--&gt; SearchResult</span>
<span class="sd">                    |                |                |       `- AlephRecord</span>
<span class="sd">                    V                |                |</span>
<span class="sd">       Count/Search/ExportRequest    |                |--&gt; ISBNValidationResult</span>
<span class="sd">                    |                |                |        - ISBN</span>
<span class="sd">                    V                |                |</span>
<span class="sd">                    |                |                |--&gt; ExportResult</span>
<span class="sd">                    V                |                |</span>
<span class="sd">               serialize()&lt;----------&#39;           deserialize()</span>
<span class="sd">                    |                                 ^</span>
<span class="sd">                    V             Client              |</span>
<span class="sd">               AMQPMessage ------&gt; AMQP -------&gt; AMQPMessage</span>
<span class="sd">                                  |    ^</span>
<span class="sd">                                  V    |</span>
<span class="sd">                                  |    ^</span>
<span class="sd">                                  V    |</span>
<span class="sd">                                  |    ^</span>
<span class="sd">                                  V    |</span>
<span class="sd">               AMQPMessage &lt;------ AMQP &lt;-------- AMQPMessage</span>
<span class="sd">                    |             Service              ^</span>
<span class="sd">                    |                                  |</span>
<span class="sd">                    V                                  |</span>
<span class="sd">           reactToAMQPMessage() ............... magic_happens()</span>

<span class="sd">Neat, isn&#39;t it?</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c">#= Imports ====================================================================</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>


<span class="kn">import</span> <span class="nn">isbn</span>
<span class="kn">import</span> <span class="nn">aleph</span>
<span class="kn">import</span> <span class="nn">export</span>
<span class="kn">import</span> <span class="nn">settings</span>
<span class="kn">import</span> <span class="nn">convertors</span>
<span class="kn">from</span> <span class="nn">datastructures</span> <span class="kn">import</span> <span class="o">*</span>


<span class="c">#= Queries ====================================================================</span>
<span class="k">class</span> <span class="nc">_QueryTemplate</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class is here to just save some effort by using common ancestor with</span>
<span class="sd">    same .getSearchResult() and .getCountResult() definition.</span>

<span class="sd">    You probably shouldn&#39;t use it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">getSearchResult</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">doc_id</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">base</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getIDs</span><span class="p">():</span>
            <span class="n">xml</span> <span class="o">=</span> <span class="n">aleph</span><span class="o">.</span><span class="n">downloadMARCXML</span><span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="n">library</span><span class="p">)</span>

            <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">AlephRecord</span><span class="p">(</span>
                    <span class="n">base</span><span class="p">,</span>
                    <span class="n">library</span><span class="p">,</span>
                    <span class="n">doc_id</span><span class="p">,</span>
                    <span class="n">xml</span><span class="p">,</span>
                    <span class="n">convertors</span><span class="o">.</span><span class="n">toEPublication</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">SearchResult</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getCountResult</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CountResult</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getCount</span><span class="p">())</span>


<div class="viewcode-block" id="GenericQuery"><a class="viewcode-back" href="../api/aleph.html#aleph.GenericQuery">[docs]</a><span class="k">class</span> <span class="nc">GenericQuery</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;GenericQuery&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;base&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;phrase&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;considerSimilar&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;field&#39;</span><span class="p">]),</span>
                   <span class="n">_QueryTemplate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used for generic queries to aleph.</span>

<span class="sd">    Args:</span>
<span class="sd">        base (str)</span>
<span class="sd">        phrase (str)</span>
<span class="sd">        considerSimilar (bool)</span>
<span class="sd">        field (str)</span>

<span class="sd">    For details of base/phrase/.. parameters, see :func:`aleph.searchInAleph`.</span>
<span class="sd">    All parameters also serves as properties.</span>

<span class="sd">    This is used mainly if you want to search by your own parameters and don&#39;t</span>
<span class="sd">    want to use prepared wrappers (:class:`AuthorQuery`/:class:`ISBNQuery`/..).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_getIDs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">aleph</span><span class="o">.</span><span class="n">getDocumentIDs</span><span class="p">(</span>
            <span class="n">aleph</span><span class="o">.</span><span class="n">searchInAleph</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">considerSimilar</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">field</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getCount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">aleph</span><span class="o">.</span><span class="n">searchInAleph</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">considerSimilar</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field</span>
        <span class="p">)[</span><span class="s">&quot;no_entries&quot;</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="ISBNQuery"><a class="viewcode-back" href="../api/aleph.html#aleph.ISBNQuery">[docs]</a><span class="k">class</span> <span class="nc">ISBNQuery</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;ISBNQuery&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;ISBN&quot;</span><span class="p">,</span> <span class="s">&quot;base&quot;</span><span class="p">]),</span> <span class="n">_QueryTemplate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query Aleph to get books by ISBN.</span>

<span class="sd">    Args:</span>
<span class="sd">        ISBN (str)</span>
<span class="sd">        base (str, optional): if not set, ``settings.ALEPH_DEFAULT_BASE`` is</span>
<span class="sd">                              used</span>

<span class="sd">    Note:</span>
<span class="sd">        ISBN is not unique, so you can get back lot of books with same ISBN.</span>
<span class="sd">        Some books also have two or more ISBNs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ISBN</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ALEPH_DEFAULT_BASE</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ISBNQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ISBN</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getIDs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">aleph</span><span class="o">.</span><span class="n">getISBNsIDs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ISBN</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getCount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">aleph</span><span class="o">.</span><span class="n">getISBNCount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ISBN</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="AuthorQuery"><a class="viewcode-back" href="../api/aleph.html#aleph.AuthorQuery">[docs]</a><span class="k">class</span> <span class="nc">AuthorQuery</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;AuthorQuery&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;author&quot;</span><span class="p">,</span> <span class="s">&quot;base&quot;</span><span class="p">]),</span>
                  <span class="n">_QueryTemplate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query Aleph to get books by Author.</span>

<span class="sd">    Args:</span>
<span class="sd">        author (str): Author&#39;s name/lastname in UTF</span>
<span class="sd">        base (str, optional): if not set, ``settings.ALEPH_DEFAULT_BASE`` is</span>
<span class="sd">                              used</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">author</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ALEPH_DEFAULT_BASE</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">AuthorQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">author</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getIDs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">aleph</span><span class="o">.</span><span class="n">getAuthorsBooksIDs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getCount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">aleph</span><span class="o">.</span><span class="n">getAuthorsBooksCount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="PublisherQuery"><a class="viewcode-back" href="../api/aleph.html#aleph.PublisherQuery">[docs]</a><span class="k">class</span> <span class="nc">PublisherQuery</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;PublisherQuery&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;publisher&quot;</span><span class="p">,</span> <span class="s">&quot;base&quot;</span><span class="p">]),</span>
                     <span class="n">_QueryTemplate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query Aleph to get books by Publisher.</span>

<span class="sd">    Args:</span>
<span class="sd">        publisher (str): publisher&#39;s name in UTF</span>
<span class="sd">        base (str, optional): if not set, ``settings.ALEPH_DEFAULT_BASE`` is</span>
<span class="sd">                              used</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">publisher</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ALEPH_DEFAULT_BASE</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">PublisherQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">publisher</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getIDs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">aleph</span><span class="o">.</span><span class="n">getPublishersBooksIDs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getCount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">aleph</span><span class="o">.</span><span class="n">getPublishersBooksCount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>


<span class="c">#= Variables ==================================================================</span></div>
<span class="n">QUERY_TYPES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ISBNQuery</span><span class="p">,</span>
    <span class="n">AuthorQuery</span><span class="p">,</span>
    <span class="n">PublisherQuery</span><span class="p">,</span>
    <span class="n">GenericQuery</span>
<span class="p">]</span>

<span class="n">REQUEST_TYPES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">SearchRequest</span><span class="p">,</span>
    <span class="n">CountRequest</span><span class="p">,</span>
    <span class="n">ExportRequest</span><span class="p">,</span>
    <span class="n">ISBNValidationRequest</span>
<span class="p">]</span>


<span class="c">#= Interface for an external world ============================================</span>
<div class="viewcode-block" id="serialize"><a class="viewcode-back" href="../api/aleph.html#aleph.serialize">[docs]</a><span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Serialize class hierarchy into JSON.</span>

<span class="sd">    Args:</span>
<span class="sd">        data (any): any python type serializable to JSON, with added support of</span>
<span class="sd">                    namedtuples</span>

<span class="sd">    Returns:</span>
<span class="sd">        unicode: JSON string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">convertors</span><span class="o">.</span><span class="n">toJSON</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="deserialize"><a class="viewcode-back" href="../api/aleph.html#aleph.deserialize">[docs]</a><span class="k">def</span> <span class="nf">deserialize</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deserialize classes from JSON data.</span>

<span class="sd">    Args:</span>
<span class="sd">        data (str): python data serialized to JSON</span>

<span class="sd">    Returns:</span>
<span class="sd">        any: any python typ (make sure you have namedtuples imported)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">convertors</span><span class="o">.</span><span class="n">fromJSON</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

</div>
<span class="k">def</span> <span class="nf">_iiOfAny</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">classes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns true, if `instance` is instance of any (_iiOfAny) of the `classes`.</span>

<span class="sd">    This function doesn&#39;t use isinstance() check, it just compares the</span>
<span class="sd">    classnames.</span>

<span class="sd">    This can be generaly dangerous, but it is really useful when you are</span>
<span class="sd">    comparing class serialized in one module and deserialized in another.</span>

<span class="sd">    This causes, that module paths in class internals are different and</span>
<span class="sd">    isinstance() and type() comparsions thus fails.</span>

<span class="sd">    Use this function instead, if you wan&#39;t to check what type is your</span>
<span class="sd">    deserialized message.</span>

<span class="sd">    Args:</span>
<span class="sd">        instance (object): class instance you want to know the type</span>
<span class="sd">        classes (list): classes, or just the class you want to compare - func</span>
<span class="sd">                        automatically converts nonlist/nontuple parameters to</span>
<span class="sd">                        list</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if `instance` is instance of any of the `classes`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]:</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">classes</span><span class="p">]</span>

    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="n">x</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">classes</span><span class="p">))</span>


<span class="c">#= Functions ==================================================================</span>
<div class="viewcode-block" id="reactToAMQPMessage"><a class="viewcode-back" href="../api/aleph.html#aleph.reactToAMQPMessage">[docs]</a><span class="k">def</span> <span class="nf">reactToAMQPMessage</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">response_callback</span><span class="p">,</span> <span class="n">UUID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    React to given (AMQP) message. Return data thru given callback function.</span>

<span class="sd">    Args:</span>
<span class="sd">        message (str or Request class): message encoded in JSON by serialize()</span>
<span class="sd">                                        or any of the Request class from</span>
<span class="sd">                                        :class:`aleph.datastructures.requests`</span>
<span class="sd">        response_callback (func): function has to take two parameters -</span>
<span class="sd">                                  message&#39;s body (serialized response class)</span>
<span class="sd">                                  and UUID</span>
<span class="sd">        UUID (str): unique ID of received message</span>

<span class="sd">    Note:</span>
<span class="sd">        Function take care of sending the response over AMQP, or whatever you</span>
<span class="sd">        use.</span>

<span class="sd">    Returns:</span>
<span class="sd">        result of `response_callback()` call.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: if bad type of `message` structure is given.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="k">else</span> <span class="n">message</span>

    <span class="c"># TODO: pridat podporu exportnich typu</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_iiOfAny</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">REQUEST_TYPES</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s">&quot;Unknown type of request: &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;&#39;!&quot;</span>
        <span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">_iiOfAny</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">CountRequest</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_iiOfAny</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">QUERY_TYPES</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">getCountResult</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">_iiOfAny</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">SearchRequest</span><span class="p">)</span> <span class="ow">and</span> <span class="n">_iiOfAny</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">QUERY_TYPES</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">getSearchResult</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">_iiOfAny</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ExportRequest</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Not implemented yet.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">_iiOfAny</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ISBNValidationRequest</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">ISBNValidationResult</span><span class="p">(</span><span class="n">isbn</span><span class="o">.</span><span class="n">is_valid_isbn</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">ISBN</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">_iiOfAny</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ExportRequest</span><span class="p">):</span>
        <span class="n">export</span><span class="o">.</span><span class="n">exportEPublication</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">epublication</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">ExportResult</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">epublication</span><span class="o">.</span><span class="n">ISBN</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s">&quot;Unknown type of request: &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;&#39; or query: &#39;&quot;</span> <span class="o">+</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;&#39;!&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response_callback</span><span class="p">(</span><span class="n">serialize</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="n">UUID</span><span class="p">)</span></div>
</pre></div>

      </div>
      <div class="bottomnav">
      
        <p>
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2014 E-deposit team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>
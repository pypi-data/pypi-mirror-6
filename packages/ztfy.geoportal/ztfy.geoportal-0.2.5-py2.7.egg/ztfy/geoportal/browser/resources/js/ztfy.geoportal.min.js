(function(a){if(typeof(a.ZTFY)=="undefined"){a.ZTFY={}}a.ZTFY.geoportal={open:function(b,c){Geoportal=undefined;OpenLayers=undefined;a.ZTFY.dialog.open(c+"?prefix="+b);return false},initPlugin:function(c){if(window.__Geoportal$timer===undefined){var b=null}a.ZTFY.geoportal.initMap(c)},initMap:function(b){if(typeof(OpenLayers)==="undefined"||typeof(Geoportal)==="undefined"){setTimeout(a.ZTFY.geoportal.initMap,300,b);return}Geoportal.GeoRMHandler.getConfig([a(b).data("geoportal-api-key")],null,null,{onContractsComplete:function(){a(a.ZTFY.geoportal).data("geoportal-config",this);a.ZTFY.geoportal.loadMap(b)}})},loadMap:function(b){var c=a.ZTFY.geoportal.initViewer(b)},initViewer:function(t,c,r,u){Geoportal.GeoXYForm=OpenLayers.Class({containerId:null,buttonId:null,imgButton:null,lonId:null,latId:null,vectorProjection:"IGNF:RGF93G",precision:1000000,marker:null,container:null,button:null,Lon:null,Lat:null,initialize:function(v){OpenLayers.Util.extend(this,v);if(typeof(this.vectorProjection)=="string"){this.vectorProjection=new OpenLayers.Projection(this.vectorProjection)}this.container=parent.document.getElementById(this.containerId);this.button=parent.document.getElementById(this.buttonId);this.Lon=parent.document.getElementById(this.lonId);this.Lat=parent.document.getElementById(this.latId)},getXInput:function(){return this.Lon},getYInput:function(){return this.Lat},getX:function(){if(this.Lon){return parseFloat(this.Lon.value)}return NaN},getY:function(){if(this.Lat){return parseFloat(this.Lat.value)}return NaN},setX:function(v){if(this.Lon&&!isNaN(parseFloat(v))){this.Lon.value=v}},setY:function(v){if(this.Lat&&!isNaN(parseFloat(v))){this.Lat.value=v}},getPrecision:function(){return this.precision?this.precision:1000000},getNativeProjection:function(){return this.vectorProjection},CLASS_NAME:"Geoportal.GeoXYForm"});var e={mode:"normal",territory:c||"FXX",projection:r||null,displayProjection:u||"IGNF:RGF93G"};var n;if(typeof(t)=="string"){n=t;t=a('DIV[id="'+n+'"]')}else{n=a(t).attr("id")}var j=a(t).data("geoportal-api-key");var d=new Geoportal.Viewer.Default(n,OpenLayers.Util.extend(e,window.gGEOPORTALRIGHTSMANAGEMENT===undefined?{apiKey:apiKey}:gGEOPORTALRIGHTSMANAGEMENT));d.addGeoportalLayers(["ORTHOIMAGERY.ORTHOPHOTOS","GEOGRAPHICALGRIDSYSTEMS.MAPS"],{});d.map.getLayersByName("ORTHOIMAGERY.ORTHOPHOTOS")[0].visibility=false;d.map.getLayersByName("GEOGRAPHICALGRIDSYSTEMS.MAPS")[0].setOpacity(0.8);var t=a(t).get(0);a.data(t,"ztfy.geoportal.viewer",d);var o="location-widgets-longitude";var s="location-widgets-latitude";var l={containerId:n,lonId:o,latId:s,vectorProjection:new OpenLayers.Projection("EPSG:4326"),precision:1000000,marker:"/--static--/ztfy.geoportal/img/pin.png"};var b=new Geoportal.GeoXYForm(l);d.setVariable("gpForm",b);var i=null;if(b.marker){i=new OpenLayers.StyleMap({"default":OpenLayers.Util.extend({externalGraphic:b.marker,graphicOpacity:1,graphicWidth:14,graphicHeight:14,graphicXOffset:0,graphicYOffset:-14,fill:false},OpenLayers.Feature.Vector["default"]),temporary:OpenLayers.Util.extend({display:"none"},OpenLayers.Feature.Vector.temporary)})}var q=a.ZTFY.dialog.dialogs;if(q.length>0){var f=q[q.length-1].src;var p=a.ZTFY.getQueryVar(f,"prefix");if(p){p=p.replace(/\./g,"-");o=p+"-longitude";s=p+"-latitude"}}var h={containerId:t,lonId:o,latId:s,vectorProjection:new OpenLayers.Projection("EPSG:4326"),precision:1000000,marker:"/--static--/ztfy.geoportal/img/pin.png"};var g=new Geoportal.GeoXYForm(h);d.setVariable("gpParentForm",g);var k=new OpenLayers.Layer.Vector("POINT_XY",{projection:b.vectorProjection,displayInLayerSwitcher:false,calculateInRange:function(){return true},styleMap:i});d.getMap().addLayer(k);var m=new OpenLayers.Control.DrawFeature(k,OpenLayers.Handler.Point,{autoActivate:true,callbacks:{done:function(w){this.layer.destroyFeatures();var v=new OpenLayers.Feature.Vector(w,{pictoUrl:"/--static--/ztfy.geoportal/img/pin.png"});v.state=OpenLayers.State.INSERT;this.layer.addFeatures([v]);a.ZTFY.geoportal.updateXYForm(v)}},handlerOptions:{persist:false,layerOptions:{projection:b.vectorProjection}}});d.getMap().addControl(m);OpenLayers.Event.observe(b.getXInput(),"change",a.ZTFY.geoportal.updateFeature);OpenLayers.Event.observe(b.getYInput(),"change",a.ZTFY.geoportal.updateFeature);a.ZTFY.geoportal.updateFeature();return d},getViewer:function(b){if(typeof(b)=="string"){var b=a("DIV[id="+b+"]").get(0)}return a.data(b,"ztfy.geoportal.viewer")},updateXYForm:function(e,d){if(!e||!e.geometry||!e.geometry.x||!e.geometry.y){return}var h=a.ZTFY.geoportal.getViewer("mapviewer");var g=e.geometry.clone();var c=h.getVariable("gpForm");g.transform(h.getMap().getProjection(),c.getNativeProjection());var f=c.getPrecision();c.setX(Math.round(g.x*f)/f);c.setY(Math.round(g.y*f)/f);var b=h.getVariable("gpParentForm");if(b){var f=b.getPrecision();b.setX(Math.round(g.x*f)/f);b.setY(Math.round(g.y*f)/f)}delete g},updateFeature:function(c,b){var e=a.ZTFY.geoportal.getViewer("mapviewer");var f=e.getMap().getLayersByName("POINT_XY")[0];var j=f.features[0];var d=e.getVariable("gpForm");var i=d.getX();var h=d.getY();if(!isNaN(i)&&!isNaN(h)){f.destroyFeatures();var g=new OpenLayers.Geometry.Point(i,h);g.transform(d.getNativeProjection(),e.getMap().getProjection());j=new OpenLayers.Feature.Vector(g);j.state=OpenLayers.State.INSERT;f.addFeatures(j);e.getMap().setCenterAtLonLat(i,h,15)}a.ZTFY.geoportal.updateXYForm(j);return true},hideControls:function(b){b.lyrSwCntrl.showControls("none");b.toolBoxCntrl.showControls("none");b.infoCntrl.minimizeControl()},setPosition:function(g,b,c,e,d){var f=g.map;f.setCenterAtLonLat(b.lon,b.lat);if(c){if(!d){var d=c.getDataExtent()}if(d){var e=f.getZoomForExtent(d.transform(f.getDisplayProjection(),c.projection),true)}}if(!e){var e=10}f.setCenterAtLonLat(b.lon,b.lat,e)}}})(jQuery);
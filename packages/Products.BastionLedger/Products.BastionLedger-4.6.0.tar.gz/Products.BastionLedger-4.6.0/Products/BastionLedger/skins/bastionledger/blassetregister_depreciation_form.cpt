<html xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="bastionledger">
 
<body>
 
    <div metal:fill-slot="main"
         tal:define="errors options/state/getErrors;
                   utool context/@@plone_portal_state/portal_url;">

      <h1><img src="" alt="" tal:define="icon python:context.getIcon(1)"
               tal:attributes="src string:${utool}/${icon}"/>&nbsp;
          <span tal:replace="context/title_or_id"/> Depreciation Worksheet</h1>

      <form name="edit_form"  action="."  method="post" 
            tal:define="date_start request/date_start | python: context.applied_to + 1;
                        date_end request/date_end | python: DateTime();
                        dep_amt python: context.depreciationAmount((date_start,date_end));
                        global cost_to_date python: 0;
                        global dep_to_date python: 0;
                        global total_book_value python: 0"
            tal:attributes="action string:${context/getId}/${template/getId}" >

          <table summary="" class="visualNoPrint">
             <tr>
                <td class="label">From</td>
            
                <td tal:define="inputvalue date_start;
                                formname string:edit_form;
                                show_hm python: False;
                                inputname string:date_start;">
                   <span metal:use-macro="here/calendar_macros/macros/calendarDatePickerBox"/>
                </td>
                <td class="label">To</td>
                <td tal:define="inputvalue date_end;
                                formname string:edit_form;
                                show_hm python: False;
                                inputname string:date_end;">
                   <span metal:use-macro="here/calendar_macros/macros/calendarDatePickerBox"/>
                </td>
                <td>
                   <input class="context"  type="submit" name="form.button.Calculate"
                          value="Calculate"  i18n:attributes="value" />
                   <input class="standalone"  type="submit" name="form.button.Apply"
                          value="  Apply  "  i18n:attributes="value" />
                </td>
             </tr>
          </table>

          <br/>

          <table summary="" border="0" cellpadding="2" cellspacing="0" width="100%">
            <tr>
               <td width="25"></td>
               <td><label>Name</label></td>
               <td><label>Method</label></td>
               <td><label>Last Deprec.</label></td>
               <td align="right"><label>Cost to Date</label></td>
               <td align="right"><label>Deprec. to Date</label></td>
               <td align="right"><label>Depreciation</label></td>
               <td align="right"><label>Book Value</label></td>
            </tr>
            <tal:block tal:repeat="item python: context.objectValues('BLAsset')">
               <tr class="row-hilite"
                   tal:define="depreciation python: item.depreciation((date_start, date_end));
                               total_cost item/totalCost;
                               book_value python: total_cost - item.depreciation_to_date - depreciation;
                               global cost_to_date python: total_cost + cost_to_date;
                               global dep_to_date python: item.depreciation_to_date + dep_to_date;
                               global total_book_value python: book_value + total_book_value"
                   tal:attributes="class python: repeat['item'].index % 2 and 'even' or 'odd'">
                   <td>
                      <a href="" tal:attributes="href string:${item/absolute_url}/manage_workspace">
                          <img src="" alt="" border="0"  tal:define="icon python:item.getIcon(1)" 
                               tal:attributes="src string:${utool}/${icon}; alt item/meta_type"/>
                      </a>
                   </td>
                   <td>
                       <a href="" tal:attributes="href item/absolute_url" tal:content="item/title_or_id"/>
                   </td>
                   <td tal:content="item/depreciation_method"/>
                   <td tal:content="python: item.last_depreciation_run.strftime('%Y/%m/%d')"/>
                   <td align="right" nowrap tal:content="total_cost"/>
                   <td align="right" nowrap tal:content="item/depreciation_to_date"/>
                   <td align="right" nowrap tal:content="depreciation"/>
                   <td align="right" nowrap tal:content="book_value"/>
               </tr>
           </tal:block>
            <tr>
               <td colspan="8"><hr/></td>
            </tr>
            <tr>
               <td colspan="5" align="right" nowrap>
                   <span class="label" tal:content="cost_to_date"/>
               </td>
               <td align="right" nowrap>
                   <span class="label" tal:content="dep_to_date"/>
               </td>
               <td align="right" nowrap>
                   <span class="label" tal:content="dep_amt"/>
               </td>
               <td align="right" nowrap>
                   <span class="label" tal:content="total_book_value"/>
               </td>
            </tr>
         </table>

         <tal:post tal:condition="python: dep_amt > 0">
            <br/>
            <br/>
            <div class="label">Depreciation Transaction</div>

            <table summary="">
               <tr>
                 <td><img src="" tal:attributes="src string:${utool}/blentry.gif" alt="Entry"></td>
                 <td tal:define="dep_exp python: context.Ledger.accountValues(tags='dep_exp')[0]"
                     tal:content="dep_exp/prettyTitle"/>
                 <td tal:content="dep_amt"/>
                 <td/>
               </tr>
               <tr>
                 <td><img src="" tal:attributes="src string:${utool}/blentry.gif" alt="Entry"></td>
                 <td tal:define="dep_exp python: context.Ledger.accountValues(tags='accum_dep')[0]"
                     tal:content="dep_exp/prettyTitle"/>
                 <td/>
                 <td tal:content="dep_amt"/>
               </tr>
               <tr>
                 <td colspan="4" class="visualNoPrint">
                    <input class="context"
                           
                           type="submit"
                           name="form.button.Post"
                           value="Post"
                           i18n:attributes="value" />
                  </td>
               </tr>
             </table>

             <input type="hidden" name="form.submitted" value="1" />
          </tal:post>
      </form>

      <div tal:replace="structure provider:plone.belowcontentbody">
           Document actions (print, sendto etc)
      </div>

    </div>
 
</body>
</html>

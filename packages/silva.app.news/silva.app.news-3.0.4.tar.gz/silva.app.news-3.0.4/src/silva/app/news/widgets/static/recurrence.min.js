(function($,infrae){function parse_recurrence_data(value){var items=value.split(";"),data={};return $.each(items||[],function(index,item){var pair=item.split("=");data[pair[0]]=pair[1]}),data}function daySort(x,y){var ref=["MO","TU","WE","TH","FR","SA","SU"];return $.inArray(x,ref)-$.inArray(y,ref)}function sortInt(x,y){return x-y}function format(string,param){return string.replace("%s",param+"")}function pluralize(data,count){if(isNaN(count))return data[0];var c=parseInt(count);return c>1?format(data[1],c):data[0]}function humanJoin(list,term){var result=list[0],i=1;for(i;list.length-1>i;i++)result+=", "+list[i];return 1!=list.length&&(result+=" "+term+" "+list[list.length-1]),result}function joinDayNames(list,translations){return humanJoin($.map(list.sort(daySort),function(x){return translations.dayNames[x]}),translations.listterm)}function joinDayNumbers(list,translations){return humanJoin(list.sort(sortInt),translations.listterm)}function joinMonthNumbers(list,translations){return humanJoin($.map(list.sort(sortInt),function(x){return translations.monthNames[x-1]}),translations.listterm)}function humanize(data,translations){if(void 0===data.FREQ)return translations.notset;var sentence=pluralize(translations[data.FREQ],data.INTERVAL);return data.BYMONTH&&(sentence+=" "+format(translations.BYMONTH,joinMonthNumbers(data.BYMONTH.split(","),translations))),data.BYSETPOS?(sentence+=" "+translations.BYSETPOS[data.BYSETPOS],data.BYDAY&&(sentence+=" "+joinDayNames(data.BYDAY.split(","),translations)),data.BYMONTHDAY&&(sentence+=" "+joinDayNumbers(data.BYMONTHDAY.split(","),translations)),sentence):(data.BYDAY&&(sentence+=" "+format(translations.BYDAY,joinDayNames(data.BYDAY.split(","),translations))),data.BYMONTHDAY&&(sentence+=" "+format(translations.BYMONTHDAY,joinDayNumbers(data.BYMONTHDAY.split(","),translations))),sentence)}$.widget("ui.dailyrecurrence",{options:{interval:1,mainDivId:"ui-dailyrecurrence-main"},destroy:function(){$.Widget.prototype.destroy.apply(this,arguments)},freq:function(){var freq="FREQ=DAILY";return this.options.interval&&!isNaN(this.options.interval)&&(freq+=";INTERVAL="+this.options.interval),freq},_create:function(){var self=this;this.element.bind("freqsync",function(){self.reset.apply(self)}),this._build(),this._attachEvents()},_build:function(){var dom=$('<div id="'+this.options.mainDivId+'" />'),base=dom;base.addClass("ui-dailyrecurrence ui-widget ui-widget-content ui-helper-clearfix ui-corner-all");var every=$('<div>every<input size="3" type="text" name="interval"/> day(s)</div>');every.appendTo(base),base.appendTo(this.element),this.interval_input=$(every.find("input")),this.interval_input.val(this.options.interval)},_attachEvents:function(){var handler=this;this.interval_input.change(function(){handler._setOption("interval",handler.interval_input.val()),handler._freq_change()})},_freq_change:function(event){this._trigger("freqchange",event,{freq:this.freq()})},reset:function(){this._freq_change()},update:function(data){"DAILY"==data.FREQ&&(data.INTERVAL&&(this.options.interval=data.INTERVAL),this._freq_change(),this._setState())},_setState:function(){this.interval_input.val(this.options.interval)}}),$.extend($.ui.dailyrecurrence,{getter:["freq","reset"],setter:"update"}),$.widget("ui.weeklyrecurrence",{weekDays:["SU","MO","TU","WE","TH","FR","SA"],options:{interval:1,days:[],debug:!1,firstDay:3,dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],mainDivId:"ui-weeklyrecurrence-main"},destroy:function(){$.Widget.prototype.destroy.apply(this,arguments)},_create:function(){var self=this;this.element.bind("freqsync",function(){self.reset.apply(self)}),this._build()},_build:function(){var content=$(this._generateDom());this.element.empty().append(content)},freq:function(){var freq="FREQ=WEEKLY",days=this.options.days;return this.options.interval&&(freq+=";INTERVAL="+this.options.interval),0==days.length?freq:freq+=";BYDAY="+days.join(",")},reset:function(){this._freq_change()},update:function(data){return"WEEKLY"!=data.FREQ?(data={},void 0):(this.options.interval=data.INTERVAL||1,this.options.days=data.BYDAY?data.BYDAY.split(","):[],this._freq_change(),this._setState(),void 0)},dayChanged:function(event,element){element=$(element),element.toggleClass("ui-state-active");var value=element.data("ui-wr:daynum"),days=this.options.days||[];if(element.hasClass("ui-state-active"))-1==$.inArray(value,days)&&this._setOption("days",days.concat([value]));else{var pos=$.inArray(value,days);-1!=pos&&days.splice(pos,1)}this._freq_change(event)},intervalChanged:function(event,input){this._setOption("interval",input.val()),this._freq_change(event)},_freq_change:function(event){this._trigger("freqchange",event,{freq:this.freq()})},_setState:function(){this.interval_input.val(this.options.interval);var days_elements=this.element.find("a.ui-state-default"),self=this;$.each(days_elements,function(index,element){var el=$(element),day=el.data("ui-wr:daynum");-1!=$.inArray(day,self.options.days)?el.addClass("ui-state-active"):el.removeClass("ui-state-active")})},_createDayElement:function(value,name){var handler=this,dom=$('<td><a href="#" class="ui-state-default">'+name+"</a></td>"),el=$(dom[0]).find("a");return el.data("ui-wr:daynum",WEEKDAYS[value]),el.click(function(event){var el=$(this);return handler.dayChanged.apply(handler,[event,el]),!1}),-1!=$.inArray(WEEKDAYS[value],this.options.days)&&el.addClass("ui-state-active"),dom},_createInput:function(){var handler=this,dom=$('<div class="ui-weeklyrecurrence-every">every<input size="2" value="'+this.options.interval+'" type="text" /> weeks on</div>'),input=$(dom.find("input"));return this.interval_input=input,input.change(function(event){var input=$(this);handler.intervalChanged.apply(handler,[event,input])}),dom},_generateDom:function(){var dom=$('<div id="'+this.options.mainDivId+'" />');$(dom[0]).addClass("ui-weeklyrecurrence ui-widget ui-widget-content ui-helper-clearfix ui-corner-all"),this._createInput(this.options.interval).appendTo(dom);for(var table=$("<table>"),tbody=$("<tbody>"),tr=$("<tr>"),i=0;7>i;i++){var index=(i+this.options.firstDay)%7,day=this.options.dayNames[index],td=this._createDayElement(index,day);td.appendTo(tr)}return tr.appendTo(tbody),tbody.appendTo(table),table.appendTo(dom),dom}}),$.extend($.ui.weeklyrecurrence,{getter:["freq","reset"],setter:"update"});var WEEKDAYS=["SU","MO","TU","WE","TH","FR","SA"];$.widget("ui.monthlyrecurrence",{options:{interval:1,mode:"each",days:[],debug:!1,firstDay:0,weekEndDay:6,dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],mainDivId:"ui-monthlyrecurrence-main"},destroy:function(){$.Widget.prototype.destroy.apply(this,arguments)},_create:function(){var self=this;this.element.bind("freqsync",function(){self.reset.apply(self)}),this._build(),this._attachEvents()},freq:function(){return"each"==this.options.mode?this._getFreqEach():this._getFreqOnthe()},mode:function(){return this.options.mode},days:function(){return this.options.days},_freq_change:function(event){this._trigger("freqchange",event,{freq:this.freq()})},_getFreqEach:function(){var days=this.options.days||[],freq="FREQ=MONTHLY";return this.options.interval&&!isNaN(this.options.interval)&&(freq+=";INTERVAL="+this.options.interval),days.length>0&&(freq+=";BYMONTHDAY="+days.join(",")),freq},_getFreqOnthe:function(){this.options.pos,this.options.on;var freq="FREQ=MONTHLY";return this.options.interval&&!isNaN(this.options.interval)&&(freq+=";INTERVAL="+this.options.interval),this.options.pos&&this.options.on&&(freq+=";BYSETPOS="+this.options.pos,freq+=";BYDAY="+this.options.on),freq},_getDay:function(daylike){var pos=$.inArray(daylike,WEEKDAYS);if(-1!=pos)return daylike;var binding={day:function(){return"1"},weekendday:function(){return WEEKDAYS[this.options.weekEndDay]},weekday:function(){return WEEKDAYS[this.options.firstDay]}};return binding[daylike].apply(this)},reset:function(){this._freq_change()},update:function(data){return"MONTHLY"!=data.FREQ?(data={},void 0):(this._set_each_mode(),this.options.interval=data.INTERVAL||"1",data.BYDAY&&(this.options.on=data.BYDAY,this._set_onthe_mode()),data.BYSETPOS&&(this.options.pos=data.BYSETPOS),data.BYMONTHDAY&&(this.options.days=data.BYMONTHDAY.split(",")),this._freq_change(),this._setState(),void 0)},_set_each_mode:function(){this.select_pos.attr("disabled",!0),this.select_on.attr("disabled",!0),this.days_table.removeClass("disabled"),this._setOption("mode","each")},_set_onthe_mode:function(){this.select_pos.attr("disabled",!1),this.select_on.attr("disabled",!1),this.days_table.addClass("disabled"),this._setOption("mode","onthe")},radioEachChanged:function(event){this._set_each_mode(),this._freq_change(event)},radioOntheChanged:function(event){this._set_onthe_mode(),this.posChanged(),this._freq_change(event)},dayChanged:function(event,target,value){var days=this.options.days;value+="";var pos=$.inArray(value,days);-1==pos?(this._setOption("days",days.concat([value])),target.addClass("ui-state-active")):(days.splice(pos,1),target.removeClass("ui-state-active")),this._freq_change(event)},posChanged:function(event){this._setOption("on",this.select_on.val()),this._setOption("pos",this.select_pos.val()),this._freq_change(event)},intervalChanged:function(event){this._setOption("interval",this.interval_input.val()),this._freq_change(event)},_attachEvents:function(){var handler=this;this.radio_each.change(function(event){event.target.checked&&handler.radioEachChanged.apply(handler,[event,$(this)])}),this.radio_onthe.change(function(event){event.target.checked&&handler.radioOntheChanged.apply(handler,[event,$(this)])}),this.days_table.click(function(event){if("onthe"!=handler.options.mode){var target=$(event.target);if(target.data("ui-mr:day")){var value=target.data("ui-mr:day");handler.dayChanged.apply(handler,[event,target,value])}}}),this.select_pos.change(function(event){handler.posChanged.apply(handler,[event,$(this)])}),this.select_on.change(function(event){handler.posChanged.apply(handler,[event,$(this)])}),this.interval_input.change(function(event){handler.intervalChanged.apply(handler,[event,$(this)])})},_setState:function(){var self=this;this.radio_each.attr("checked","each"==this.options.mode),this.radio_onthe.attr("checked","each"!=this.options.mode),this.interval_input.val(this.options.interval),$.each(this.days_table.find("td.ui-mr-day"),function(index,element){var el=$(element),day=el.data("ui-mr:day")+"";-1!=$.inArray(day,self.options.days)?el.addClass("ui-state-active"):el.removeClass("ui-state-active")}),$.each(this.select_on.attr("options")||[],function(index,element){var opt=$(element);opt.attr("selected",opt.val()==self.options.on)}),$.each(this.select_pos.attr("options")||[],function(index,element){var opt=$(element);opt.attr("selected",opt.val()==self.options.pos)})},_build:function(){var dom=$('<div id="'+this.options.mainDivId+'" />'),base=dom;base.addClass("ui-monthlyrecurrence ui-widget ui-widget-content ui-helper-clearfix ui-corner-all");var every=$('<div>every<input size="3" type="text" name="interval"/> month(s)</div>'),radio_each=$('<div><input checked="true" type="radio" name="ui-mr-radio" />each</div>'),each_days=$('<div class="ui-mr-days" />');this._buildEachGrid(each_days);var radio_onthe=$('<div><input type="radio" name="ui-mr-radio" />on the</div>'),onthe_part=$('<div class="ui-mr-days" />');this._buildOnthe(onthe_part),every.appendTo(base),radio_each.appendTo(base),each_days.appendTo(base),radio_onthe.appendTo(base),onthe_part.appendTo(base),base.appendTo(this.element),this.radio_each=$(radio_each.find("input")),this.radio_onthe=$(radio_onthe.find("input")),this.interval_input=$(every.find("input")),this.interval_input.val(this.options.interval)},_buildEachGrid:function(root){root=$(root);var table=$("<table><tr/><table/>"),base=$(table.find("tr"));table=$(table[0]);for(var i=0;31>i;i++){if(0==i%6){var tr=$("<tr/>");tr.appendTo(table),base=tr}var value=i+1,td=$('<td class="ui-mr-day ui-state-default">'+value+"</td>");td.data("ui-mr:day",value+""),td.appendTo(base)}table.appendTo(root),this.days_table=table},_buildOnthe:function(root){root=$(root);var select_pos=$('<select name="first" />'),options=$('<option value="1">first</option><option value="2">second</options><option value="3">third</option><option value="4">fourth</option><option value="-1">last</option>');options.appendTo(select_pos),select_pos.appendTo(root),options=$('<option value="SU">Sunday</option><option value="MO">Monday</option><option value="TU">Tuesday</option><option value="WE">Wednesday</option><option value="TH">Thursday</option><option value="FR">Friday</option><option value="SA">Saturday</option><option value="day">day</option><option value="weekday">weekday</option><option value="weekendday">weekend day</option>');var select_on=$('<select name="on" />');options.appendTo(select_on),select_on.appendTo(root),this.select_pos=select_pos,this.select_on=select_on;var disabled="onthe"!=this.options.mode;this.select_pos.attr("disabled",disabled),this.select_on.attr("disabled",disabled)}}),$.extend($.ui.monthlyrecurrence,{getter:["freq","reset"],setter:"update"}),$.widget("ui.yearlyrecurrence",{options:{interval:1,monthes:[],mode:null,on:null,pos:null,mainDivId:"ui-yearlyrecurrence-main",monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]},_create:function(){var self=this;this.element.bind("freqsync",function(){self.reset.apply(self)}),this._build(),this._attachEvents()},_build:function(){var dom=$('<div id="'+this.options.mainDivId+'" />');dom.addClass("ui-monthlyrecurrence ui-widget ui-widget-content ui-helper-clearfix ui-corner-all");for(var every=$('<div>every<input size="3" type="text" name="interval"/> year(s)</div>'),table=$("<table><tr/><table/>"),base=$(table.find("tr")),i=0;12>i;i++){if(0==i%3){var tr=$("<tr/>");tr.appendTo(table),base=tr}var value=this.options.monthNames[i],td=$('<td class="ui-yr-month ui-state-default">'+value+"</td>");td.data("ui-yr:month",i+1+""),td.appendTo(base)}every.appendTo(dom),table.appendTo(dom),this.every_input=$(every.find("input")),this.every_input.val(this.options.interval),this.monthes_table=table;var radio_onthe=$('<div><input type="checkbox" name="ui-mr-radio" />on the</div>');radio_onthe.appendTo(dom),this.radio_onthe=$(radio_onthe.find("input")),this._buildOnthe(dom),dom.appendTo(this.element)},_buildOnthe:function(root){root=$(root);var select_pos=$('<select name="first" />'),options=$('<option value="1">first</option><option value="2">second</options><option value="3">third</option><option value="4">fourth</option><option value="-1">last</option>');options.appendTo(select_pos),select_pos.appendTo(root),options=$('<option value="SU">Sunday</option><option value="MO">Monday</option><option value="TU">Tuesday</option><option value="WE">Wednesday</option><option value="TH">Thursday</option><option value="FR">Friday</option><option value="SA">Saturday</option><option value="day">day</option><option value="weekday">weekday</option><option value="weekendday">weekend day</option>');var select_on=$('<select name="on" />');options.appendTo(select_on),select_on.appendTo(root),this.select_pos=select_pos,this.select_on=select_on;var disabled="onthe"!=this.options.mode;this.select_pos.attr("disabled",disabled),this.select_on.attr("disabled",disabled)},_attachEvents:function(){var handler=this;this.monthes_table.click(function(event){var target=$(event.target);if(target.data("ui-yr:month")){var value=target.data("ui-yr:month");handler.monthChanged.apply(handler,[event,target,value])}}),this.radio_onthe.change(function(event){handler.posChanged.apply(handler,[event])}),this.select_pos.change(function(event){handler.posChanged.apply(handler,[event])}),this.select_on.change(function(event){handler.posChanged.apply(handler,[event])}),this.every_input.change(function(event){handler.everyChanged.apply(handler,[event])})},everyChanged:function(event){this.options.interval=this.every_input.val(),this._freq_change(event)},posChanged:function(event){this.options.mode=this.radio_onthe.attr("checked")&&"onthe"||null,this.options.on=this.select_on.val(),this.options.pos=this.select_pos.val();var disabled="onthe"!=this.options.mode;this.select_on.attr("disabled",disabled),this.select_pos.attr("disabled",disabled),this._freq_change(event)},monthChanged:function(event,target,value){var monthes=this.options.monthes;value+="";var pos=$.inArray(value,monthes);-1==pos?(this.options.monthes=monthes.concat([value]),target.addClass("ui-state-active")):(monthes.splice(pos,1),target.removeClass("ui-state-active")),this._freq_change(event)},freq:function(){var freq="FREQ=YEARLY";return this.options.interval&&!isNaN(this.options.interval)&&(freq+=";INTERVAL="+this.options.interval),0==this.options.monthes.length?freq:(freq+=";BYMONTH="+this.options.monthes.join(","),"onthe"==this.options.mode&&this.options.on&&this.options.pos&&(freq+=";BYDAY="+this.options.on,freq+=";BYSETPOS="+this.options.pos),freq)},_freq_change:function(event){this._trigger("freqchange",event,{freq:this.freq()})},reset:function(){this._freq_change()},update:function(data){"YEARLY"==data.FREQ&&(data.INTERVAL&&(this.options.interval=data.INTERVAL),data.BYMONTH&&(this.options.monthes=data.BYMONTH.split(",")),data.BYDAY&&(this.options.on=data.BYDAY,this.options.mode="onthe"),data.BYSETPOS&&(this.options.pos=data.BYSETPOS,this.options.mode="onthe"),this._setState())},_setState:function(){this.radio_onthe.attr("checked","onthe"==this.options.mode),this.select_on.val(this.options.on),this.select_pos.val(this.options.pos),this.every_input.val(this.options.interval);var monthes=this.monthes_table.find("td.ui-yr-month"),self=this;$.each(monthes,function(index,element){var el=$(element),month=el.data("ui-yr:month")+"";-1!=$.inArray(month,self.options.monthes)?el.addClass("ui-state-active"):el.removeClass("ui-state-active")}),$.each(this.select_on.attr("options")||[],function(index,element){var opt=$(element);opt.attr("selected",opt.val()==self.options.on)}),$.each(this.select_pos.attr("options")||[],function(index,element){var opt=$(element);opt.attr("selected",opt.val()==self.options.pos)})}}),$.extend($.ui.yearlyrecurrence,{getter:["freq","reset"],setter:"update"});var humanize_translations={monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],dayNames:{MO:"Monday",TU:"Tuesday",WE:"Wednesday",TH:"Thursday",FR:"Friday",SA:"Saturday",SU:"Sunday",day:"day",weekendday:"weekend day",weekday:"week day"},DAILY:["each day","every %s day"],WEEKLY:["each week","every %s week"],MONTHLY:["each month","every %s month"],YEARLY:["each year","every %s year"],BYDAY:"on %s",BYMONTHDAY:"on the %s",BYSETPOS:{1:"on the first",2:"on the second",3:"on the third",4:"on the fourth","-1":"on last"},BYMONTH:"in %s",listterm:"and",notset:"no recurence set."};$(".recurrence-popup-button").live("click",function(){function updateInputWidget(){var value=widget.data("recurrence-value");input.val(value),widget.find(".recurrence-sentence").text(humanize(parse_recurrence_data(value),humanize_translations))}var widget=$(this).closest(".recurrence-widget"),input=widget.find("input.recurrence-data"),$popup=$("#"+widget.attr("id")+"-popup").clone();widget.data("recurrence-value",input.val()+""),$popup.find(".sentence-val").text(humanize(parse_recurrence_data(input.val()+""),humanize_translations)),updateInputWidget();var select=$popup.find("select"),daily=$popup.find("div.daily-widget"),weekly=$popup.find("div.weekly-widget"),monthly=$popup.find("div.monthly-widget"),yearly=$popup.find("div.yearly-widget");daily.dailyrecurrence(),weekly.weeklyrecurrence(),monthly.monthlyrecurrence(),yearly.yearlyrecurrence();var handler=function(event,data){widget.data("recurrence-value",data.freq);var sentence=humanize(parse_recurrence_data(data.freq+""),humanize_translations);$popup.find(".sentence-val").text(sentence)};daily.bind("dailyrecurrencefreqchange",handler),weekly.bind("weeklyrecurrencefreqchange",handler),monthly.bind("monthlyrecurrencefreqchange",handler),yearly.bind("yearlyrecurrencefreqchange",handler),select.change(function(){var widget_class=select.val()+"";if($.each($popup.find(".widget"),function(index,element){$(element).hide()}),""!=widget_class){var el=$popup.find("div."+widget_class);el.show(),el.trigger($.Event("freqsync"))}}),$.each($popup.find(".widget"),function(index,element){$(element).hide()});var data=parse_recurrence_data(widget.data("recurrence-value"));switch(data.FREQ){case"DAILY":daily.dailyrecurrence("update",data),select.val("daily-widget"),daily.show();break;case"WEEKLY":weekly.weeklyrecurrence("update",data),select.val("weekly-widget"),weekly.show();break;case"MONTHLY":monthly.monthlyrecurrence("update",data),select.val("monthly-widget"),monthly.show();break;case"YEARLY":yearly.yearlyrecurrence("update",data),select.val("yearly-widget"),yearly.show();break;default:select.val("")}$popup.dialog({autoOpen:!1,modal:!1,width:300,height:375,buttons:{Cancel:function(){$(this).dialog("close")},Clear:function(){widget.data("recurrence-value",""),updateInputWidget(),$(this).dialog("close")},Ok:function(){updateInputWidget(),$(this).dialog("close")}}}),$popup.bind("dialogclose",function(){$popup.remove()}),infrae.ui.ShowDialog($popup)}),$(document).on("loadwidget-smiform",".form-fields-container",function(event){$(this).find(".recurrence-widget").each(function(){var $widget=$(this),$input=$widget.find("input.recurrence-data"),value=$input.val()+"";$widget.find(".recurrence-sentence").text(humanize(parse_recurrence_data(value),humanize_translations))}),event.stopPropagation()})})(jQuery,infrae);
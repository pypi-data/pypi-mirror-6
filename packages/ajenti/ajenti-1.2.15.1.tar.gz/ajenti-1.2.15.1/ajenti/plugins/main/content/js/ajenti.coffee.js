// Generated by CoffeeScript 1.4.0
(function() {
  var TabManager, _escape;

  window.WEB_SOCKET_SWF_LOCATION = '/static/main/WebSocketMain.swf';

  window.Stream = (function() {

    function Stream() {}

    Stream.prototype.start = function() {
      this.socket = ajentiConnectSocket('/stream');
      this.socket.on('connect', function() {
        return $('#connection-error').hide();
      });
      this.socket.on('auth-error', function() {
        console.log('Authentication lost!');
        return location.reload();
      });
      this.socket.on('disconnect', function() {
        return $('#connection-error').show();
      });
      this.socket.on('init', function(data) {
        data = JSON.parse(data);
        console.group('Welcome to Ajenti');
        console.log('version', data.version);
        console.log('running on', data.platform);
        console.log('your session:', data.session);
        $('title').text(data.hostname);
        console.groupEnd();
        Feedback.configure(data.feedback, data.platform, data.version, data.edition);
        return Feedback.emit('Login');
      });
      this.socket.on('ui', function(ui) {
        console.group('Received update');
        console.log('Transfer size', ui.length);
        profiler.start('Decompressing');
        ui = RawDeflate.inflate(RawDeflate.Base64.decode(ui));
        profiler.stop();
        console.log('Payload size', ui.length);
        ui = JSON.parse(ui);
        console.log('JSON data:', ui);
        UI.clear();
        profiler.start('UI inflating');
        ui = UI.inflate(ui);
        profiler.stop();
        profiler.start('UI replacement');
        UI.replace(ui);
        profiler.stop();
        console.log('Total elements:', UI._total_elements);
        console.groupEnd();
        return Loading.hide();
      });
      this.socket.on('ack', function() {
        return Loading.hide();
      });
      this.socket.on('update-request', function() {
        UI.checkForUpdates();
        UI.sendUpdates(true);
        return Loading.show();
      });
      this.socket.on('progress-message', function(m) {
        console.log('...', m);
        Loading.show();
        return Loading.setMessage(m);
      });
      this.socket.on('crash', function(data) {
        data = JSON.parse(data);
        console.log('CRASH:', data);
        ajentiCrash(data);
        return Loading.hide();
      });
      this.socket.on('security-error', function() {
        console.log('SECURITY ERROR');
        ajentiSecurityError();
        return Loading.hide();
      });
      this.socket.on('notify', function(data) {
        data = JSON.parse(data);
        return Notificator.notify(data.type, data.text);
      });
      this.socket.on('openTab', function(data) {
        data = JSON.parse(data);
        return Tabs.addTab(data.url, data.title);
      });
      this.socket.on('closeTab', function(data) {
        data = JSON.parse(data);
        return Tabs.closeTab(data.url);
      });
      this.socket.on('debug', function(data) {
        var d;
        data = JSON.parse(data);
        console.group('Profiling');
        for (d in data.profiles) {
          console.log(d, data.profiles[d]);
        }
        return console.groupEnd();
      });
      return $('#connection-error').hide();
    };

    Stream.prototype.send = function(message) {
      console.log('Sending updates', message);
      this.socket.send(JSON.stringify(message));
      return Loading.show();
    };

    Stream.prototype.emit_ui_update = function(updates) {
      return this.send({
        type: 'ui_update',
        content: updates
      });
    };

    return Stream;

  })();

  window.UIManager = (function() {

    function UIManager(stream) {
      this.stream = stream;
      this.ui = null;
      this.pendingUpdates = [];
      this.updaterTimeout = null;
    }

    UIManager.prototype.inflate = function(json) {
      var child, children, cls, typeid, _fn, _i, _len, _ref,
        _this = this;
      children = [];
      this._total_elements += 1;
      if (json.visible === true) {
        _ref = json.children;
        _fn = function(child) {
          return children.push(_this.inflate(child));
        };
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          child = _ref[_i];
          _fn(child);
        }
      }
      typeid = json.typeid.replace(':', '__');
      cls = Controls[typeid];
      if (!cls) {
        cls = Controls["default"];
      }
      return new cls(this, json, children);
    };

    UIManager.prototype.clear = function() {
      this._total_elements = 0;
      if (this.ui) {
        this.ui.broadcast('destruct');
      }
      $('.root *').unbind();
      $.cleanData($('.root *'));
      $('.root *').safeRemove();
      return delete this.ui;
    };

    UIManager.prototype.replace = function(ui) {
      var dom;
      $('.ui-tooltip').remove();
      this.ui = ui;
      dom = $$(ui.html);
      $('.root').append(dom);
      profiler.start('DOM setup');
      profiler.setupDomStats = {};
      ui.setupDom(dom);
      console.log(profiler.setupDomStats);
      profiler.stop();
      return aoConnector.reportHeight($('body')[0].scrollHeight);
    };

    UIManager.prototype.extractUpdates = function(control, target) {
      var child, updates, _i, _len, _ref, _results,
        _this = this;
      updates = control.extractUpdates();
      if (updates) {
        target.push(updates);
      }
      _ref = control.children;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        child = _ref[_i];
        _results.push((function(child) {
          return _this.extractUpdates(child, target);
        })(child));
      }
      return _results;
    };

    UIManager.prototype.checkForUpdates = function() {
      var update, updates, _i, _len, _results,
        _this = this;
      updates = [];
      this.extractUpdates(this.ui, updates);
      _results = [];
      for (_i = 0, _len = updates.length; _i < _len; _i++) {
        update = updates[_i];
        _results.push((function(update) {
          return _this.queueUpdate(update);
        })(update));
      }
      return _results;
    };

    UIManager.prototype.queueUpdate = function(update) {
      return this.pendingUpdates.push(update);
    };

    UIManager.prototype.sendUpdates = function(force) {
      var _this = this;
      if (force == null) {
        force = false;
      }
      if (this.updaterTimeout) {
        clearTimeout(this.updaterTimeout);
      }
      return this.updaterTimeout = setTimeout(function() {
        if (force || _this.pendingUpdates.length > 0) {
          _this.stream.emit_ui_update(_this.pendingUpdates);
        }
        _this.pendingUpdates = [];
        return _this.updaterTimeout = null;
      }, 50);
    };

    UIManager.prototype.event = function(control, event, params) {
      var update;
      this.checkForUpdates();
      update = {
        type: 'event',
        uid: control.uid,
        event: event,
        params: params != null ? params : null
      };
      this.queueUpdate(update);
      return this.sendUpdates();
    };

    UIManager.prototype.restoreTheme = function() {
      if (getCookie('ajenti-theme') === 'dark') {
        return this.toggleTheme();
      }
    };

    UIManager.prototype.toggleTheme = function() {
      $('html').toggleClass('ui-dark');
      $('html').toggleClass('ui-light');
      if ($('html').hasClass('ui-dark')) {
        return setCookie('ajenti-theme', 'dark');
      } else {
        return setCookie('ajenti-theme', 'light');
      }
    };

    return UIManager;

  })();

  window.LoadingDim = (function() {

    function LoadingDim(dom) {
      this.dom = dom;
      this.dom.show();
    }

    LoadingDim.prototype.hide = function() {
      var _this = this;
      this.setMessage('');
      $('.hide-when-loaded').hide();
      $('body').removeClass('loading');
      return this.dom.stop().fadeTo(125, 0, function() {
        return _this.dom.hide();
      });
    };

    LoadingDim.prototype.show = function() {
      $('body').addClass('loading');
      return this.dom.show().stop().fadeTo(500, 1);
    };

    LoadingDim.prototype.setMessage = function(m) {
      return this.dom.find('.message').text(m);
    };

    return LoadingDim;

  })();

  TabManager = (function() {

    function TabManager() {
      var _this = this;
      this.mainTab = $('#tab-ajenti');
      this.tabHeadersDom = $('#tab-headers');
      this.tabsDom = $('#tabs');
      this.tabHeadersDom.find('a').click(function() {
        return _this.goHome();
      });
      this.goHome();
      this.openTabs = {};
    }

    TabManager.prototype.goHome = function() {
      this.tabsDom.find('>*').hide();
      this.mainTab.show();
      this.tabHeadersDom.find('a').removeClass('active');
      return this.tabHeadersDom.find('a:first').addClass('active');
    };

    TabManager.prototype.addTab = function(url, title) {
      var dom, headerDom,
        _this = this;
      if (this.openTabs[url]) {
        this.openTabs[url].click();
        return;
      }
      dom = $("<div class=\"tab\"><iframe src=\"" + url + "\" /></div>");
      this.tabsDom.append(dom);
      headerDom = $("<a href=\"#\">" + title + "<span class=\"close\"><i class=\"icon-remove\"></span></a></a>");
      this.tabHeadersDom.append(headerDom);
      this.openTabs[url] = headerDom;
      this.openTabs[url].dom = dom;
      headerDom.click(function() {
        _this.tabsDom.find('>*').hide();
        dom.show();
        setTimeout(function() {
          return dom.find('iframe')[0].contentWindow.focus();
        }, 100);
        _this.tabHeadersDom.find('a').removeClass('active');
        return headerDom.addClass('active');
      });
      headerDom.find('.close').click(function() {
        return _this.closeTab(url);
      });
      return headerDom.click();
    };

    TabManager.prototype.closeTab = function(url) {
      this.openTabs[url].dom.remove();
      this.openTabs[url].remove();
      delete this.openTabs[url];
      return this.goHome();
    };

    return TabManager;

  })();

  $(function() {
    window.Loading = new LoadingDim($('#loading'));
    window.Tabs = new TabManager();
    if (window.UI) {
      UI.restoreTheme();
      return $('#ui-theme-toggle').click(function() {
        return UI.toggleTheme();
      });
    }
  });

  window.Controls = {};

  window.Control = (function() {

    function Control(ui, properties, children) {
      var child, children_html, _base, _base1, _i, _len, _ref, _ref1, _ref2;
      this.ui = ui;
      this.properties = properties;
      if ((_ref = (_base = window.Control).lastUID) == null) {
        _base.lastUID = -1;
      }
      if ((_ref1 = this.properties) == null) {
        this.properties = {};
      }
      if ((_ref2 = (_base1 = this.properties).visible) == null) {
        _base1.visible = true;
      }
      if (this.properties.uid) {
        this.uid = this.properties.uid;
      } else {
        this.uid = window.Control.lastUID--;
      }
      this.dom = null;
      this.children = [];
      this.changed = false;
      profiler.start('Generating DOM');
      this.html = this.createDom();
      if (this.dom) {
        console.log('Bad control:', this);
      }
      if (!this.html.trim) {
        this.html = '';
        return;
      }
      this.html = this.html.trim();
      if (!this.noUID) {
        this.html = this.html.insert(this.html.indexOf('>'), " id=\"uid-" + this.uid + "\"");
      }
      profiler.stop();
      children_html = '';
      if (children) {
        for (_i = 0, _len = children.length; _i < _len; _i++) {
          child = children[_i];
          this.children.push(child);
          if (!child.dom) {
            children_html += this.wrapChild(child);
          }
        }
      }
      this.html = this.html.replace('<children>', children_html);
    }

    Control.prototype.s = function(value) {
      return ('' + value).replace(/&/g, '&amp;').replace(/'/g, '&apos;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    };

    Control.prototype.createDom = function() {
      return "";
    };

    Control.prototype.setupDom = function(dom) {
      var child, key, _base, _i, _len, _ref, _ref1;
      if (this.dom) {
        return;
      }
      if (!dom) {
        dom = $$(this.html);
      }
      this.dom = dom;
      if (this.properties.visible !== true && this.dom && this.dom.style) {
        this.dom.style.display = 'none';
      }
      _ref = this.children;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        child = _ref[_i];
        if (child.dom) {
          this.append(child);
        } else {
          if (Control.prototype.setupDom !== child.constructor.prototype.setupDom) {
            key = child.constructor.name;
            if ((_ref1 = (_base = profiler.setupDomStats)[key]) == null) {
              _base[key] = 0;
            }
            profiler.setupDomStats[key] += 1;
          }
          child.setupDom(document.getElementById('uid-' + child.properties.uid));
        }
      }
      return this;
    };

    Control.prototype.destruct = function() {};

    Control.prototype.detectUpdates = function() {
      return {};
    };

    Control.prototype.markChanged = function() {
      if (!this.changed) {
        $(this.dom).before("<div class=\"changed-badge\">\n    <span title=\"Not saved yet\">*</span>\n</div>");
      }
      this.changed = true;
      return $(this.dom).addClass('changed');
    };

    Control.prototype.wrapChild = function(child) {
      return child.html;
    };

    Control.prototype.wrapChildLive = function(child) {
      return child.dom;
    };

    Control.prototype.onBroadcast = function(msg) {};

    Control.prototype.broadcast = function(msg) {
      var c, _i, _len, _ref, _results,
        _this = this;
      this.onBroadcast(msg);
      _ref = this.children;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        c = _ref[_i];
        _results.push((function(c) {
          return c.broadcast(msg);
        })(c));
      }
      return _results;
    };

    Control.prototype.extractUpdates = function() {
      var k, updates, _fn,
        _this = this;
      updates = this.detectUpdates();
      if (!this.uid || $.isEmptyObject(updates)) {
        return null;
      }
      _fn = function(k) {
        return _this.properties[k] = updates[k];
      };
      for (k in updates) {
        _fn(k);
      }
      return {
        type: 'update',
        uid: this.uid,
        properties: updates
      };
    };

    Control.prototype.append = function(child) {
      var wrapper;
      if (!this.childContainer) {
        this.childContainer = $($(this.dom).find2('.--child-container')[0]);
      }
      wrapper = this.wrapChildLive(child);
      if (wrapper instanceof jQuery) {
        wrapper = wrapper[0];
      }
      if (wrapper) {
        return this.childContainer.append(wrapper);
      }
    };

    Control.prototype.publish = function() {
      this.ui.checkForUpdates();
      return this.ui.sendUpdates();
    };

    Control.prototype.event = function(event, params) {
      var localHandler;
      this.ui.checkForUpdates();
      localHandler = this['on_' + event];
      if (localHandler) {
        if (!localHandler(params)) {
          return false;
        }
      }
      if (!this.uid || this.properties.client) {
        return false;
      }
      this.ui.event(this, event, params);
      return true;
    };

    Control.prototype._int_to_px = function(i) {
      if (/^[0-9]+$/.test(i)) {
        return i + 'px';
      }
      if (i === null || i === 'auto') {
        return 'auto';
      }
      return i + '';
    };

    Control.prototype.cancel = function(event) {
      event.preventDefault();
      return event.stopPropagation();
    };

    return Control;

  })();

  _escape = function(s) {
    return s.replace(/</g, '&lt;');
  };

  window.ajentiConnectSocket = function(uri) {
    return io.connect(uri, {
      resource: 'ajenti:socket'
    });
  };

  window.ajentiCrash = function(info) {
    $('#crash').fadeIn();
    $('#crash-traceback').html(_escape(info.message + "\n" + info.traceback));
    return $('#crash-report textarea').val(info.report);
  };

  window.ajentiCrashResume = function(info) {
    return $('#crash').fadeOut();
  };

  window.ajentiCrashShowReport = function() {
    var _this = this;
    $('#crash-traceback').toggle('blind');
    $('#crash-report').toggle('blind');
    return setTimeout(function() {
      return $('#crash-report textarea').focus()[0].select();
    }, 1000);
  };

  window.ajentiSecurityError = function() {
    return $('#security-error').fadeIn();
  };

  window.ajentiSecurityResume = function(info) {
    return $('#security-error').fadeOut();
  };

  $.fn.safeRemove = function() {
    return this.each(function(i, e) {
      if (e.parentNode) {
        return e.parentNode.removeChild(e);
      }
    });
  };

  $.fn.find2 = function(selector) {
    return this.find(selector).add(this.filter(selector));
  };

  String.prototype.trim = function() {
    return String(this).replace(/^\s+|\s+$/g, '');
  };

  String.prototype.insert = function(index, string) {
    if (index > 0) {
      return this.substring(0, index) + string + this.substring(index, this.length);
    } else {
      return string + this;
    }
  };

  $(function() {
    if (location.protocol === 'https:' || location.hostname === 'localhost') {
      return $('#ssl-alert').hide();
    }
  });

  if (/Android|webOS|iPad|IEMobile/i.test(navigator.userAgent)) {
    $(function() {
      $('html').addClass('mode-tablet');
      return FastClick.attach(document.body);
    });
  }

  window.$$ = function(html, container) {
    var div;
    if (container == null) {
      container = 'div';
    }
    div = document.createElement(container);
    div.innerHTML = html;
    return div.childNodes[0];
  };

}).call(this);

<html xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="bastionledger">
 
  <metal:border fill-slot="top_slot">
    <tal:border define="dummy python:request.set('enable_border',1)" />
  </metal:border>

<body>
  <div metal:fill-slot="main"
       tal:define="utool context/@@plone_portal_state/portal_url;
                   toLocalizedTime nocall: context/toLocalizedTime;
		   ceiling_date python: modules['Products.BastionLedger.utils'].ceiling_date;
                   all request/historicals | nothing;
                   now python: ceiling_date(DateTime());
                   effective python: request.has_key('effective') and ceiling_date(request['effective']) or now;
                   currency request/currency | context/base_currency;
                   opening_dt python: context.openingDate(effective);
                   opening_bal python: context.openingBalance(effective);
                   debits python: request.has_key('form.button.Filter') and request.query.has_key('debit') or True;
                   credits python: request.has_key('form.button.Filter') and request.query.has_key('credit') or True;
                   ledger request/query/ledger | nothing;
		   accno request/query/accno | python:[];
                   query python: context.makeAdvQuery(request.get('query', {}));
                   statuses request/statuses | python: ('posted', 'reversed', 'postedreversal');
                   entries python: all and context.entryValues((DateTime('3000/01/01'), DateTime(0)), statuses) or (not request.has_key('date') or effective > opening_dt) and context.entryValues((opening_dt, effective), statuses, query) or context.entryValues(effective, statuses, query);
                   entries python: context.applyFilter(request.get('query', {}), entries)">

      <h1><img src="" alt="" tal:define="icon python:context.getIcon(1)" 
               tal:attributes="src string:${utool}/${icon}">&nbsp;<span tal:replace="context/prettyTitle"/> as at <span tal:replace="python: toLocalizedTime(effective)"/></h1>


      <form action="" name="search_form" id="date_form" method="post"
            tal:attributes="action string:${template/getId}"
            tal:define="inputvalue python: modules['Products.BastionLedger.utils'].floor_date(effective);
                        formname string:search_form;
                        show_hm python: False;
                        inputname string:effective;">

      <div class="visualNoPrint">
             <span class="reviewHistory" metal:define-macro="history">
                <dl id="viewing" class="collapsible inline collapsedOnLoad">
                    <dt class="collapsibleHeader">Historicals</dt>
                    <dd class="collapsibleContent">
               
                 <tal:forwards tal:condition="python: effective <= now + 1 and context.hasForwards(effective)">
                    <a href="view?effective:date=3000/01/01" title="Future dated transactions">
                      forwards<span class="arrowUpAlternative">&#9650;</span>
                    </a><br/>
                 </tal:forwards>
                 <tal:historicals tal:define="historicals context/historicalDates"
                                  tal:condition="historicals">
                    <div class="period" tal:repeat="dt historicals">
                         <tal:dt tal:define="dt_ok python: dt.strftime('%Y/%m/%d')">
                            <a href="?effective:date="
                               tal:attributes="href string:view?effective:date=${dt_ok}" tal:content="dt_ok"/>
                         </tal:dt>
                    </div>
                    <div class="period" tal:condition="historicals">
                        <a href="?effective:date="
                           tal:attributes="href string:view?historicals=all">---all---</a>
                    </div>
                  </tal:historicals>
               </dd>
               </dl>
             </span>

             <span class="reviewHistory" metal:define-macro="details">
                <dl id="viewing" class="collapsible inline collapsedOnLoad">
                    <dt class="collapsibleHeader">Details</dt>
                    <dd class="collapsibleContent">
                       <table cellpadding="2" cellspacing="" summary="">
                          <tr><th>Type</th>
                              <td tal:content="context/type"/></tr>
                          <tr><th>Subtype</th>
                              <td tal:content="context/subtype"/></tr>
                          <tr tal:define="controls context/controlLedgers"
                              tal:condition="controls">
                              <th valign="top">Ledgers</th>
                              <td><a tal:repeat="ledger context/controlLedgers"
                                     tal:attributes="href ledger/absolute_url"
                                     tal:content="ledger/Title"/><br>
                              </td>
                          </tr>
                          <tr tal:define="tags context/allTags"
                              tal:condition="tags">
                              <th>Associations</th>
                              <td tal:content="python: ' '.join(tags)"/>
                          </tr>
                       </table>
                    </dd>
                </dl>
             </span>

             <span class="reviewHistory" metal:define-macro="filter">
                <dl id="viewing" class="collapsible inline collapsedOnLoad">
                    <dt class="collapsibleHeader">Filter</dt>
                    <dd class="collapsibleContent">
                         <div class="label">As At</div>
                         <div metal:use-macro="here/calendar_macros/macros/calendarDatePickerBox"/>

                         <div>
                            <span class="label">Entry is against Account</span><br/>
                            <select name="query.accno:record:list:ignore_empty" multiple size="3">
                                <option tal:repeat="account context/Ledger/accountValues"
                                        tal:content="account/prettyTitle"
                                        tal:attributes="value account/getId;
                                                        selected python: account.getId() in accno and 1 or 0"/>
                            </select>
                         </div>

                         <div tal:define="ledgers python: filter(lambda x: x.getId() != context.blLedger().getId(), context.ledgerValues())"
                              tal:condition="ledgers">
                            <span class="label">Entry is against Ledger</span><br/>
                            <select name="query.ledger:record:ignore_empty">
                                <option value=""></option>
                                <option tal:repeat="ledger ledgers"
                                        tal:content="ledger/Title"
                                        tal:attributes="value ledger/getId;
                                                        selected python: ledger.getId() == ledger and 1 or 0"/>
                            </select>
                         </div>

                         <div class="label">Description contains</div>
                         <div>
                             <input type="text" name="query.desc:record:ignore_empty" value="" 
                                    tal:attributes="value query/desc | nothing"/>
                         </div>
                         <div>
                             <input type="checkbox" name="query.debit:record:boolean" value="1"
                                    tal:attributes="checked debits | nothing"/> <span class="label">Debit</span>&nbsp;&nbsp;&nbsp;
                             <input type="checkbox" name="query.credit:record:boolean" value="1"
                                    tal:attributes="checked credits | nothing"/><span class="label">Credit</span>
                         </div>
                         <div tal:condition="context/isFCA">
                            <span class="label">Currency</span><br/>
                            <select name="query.currency:record">
                                <option tal:repeat="cur python:(context.defaultCurrency(), context.base_currency)"
                                        tal:content="cur" 
                                        tal:attributes="selected python: currency==cur and 1 or 0"/>
                            </select>
                         </div>
                         <div>
                             <input class="context" type="submit" name="form.button.Filter" value=" Search "/>
                         </div>
                         <br/>
                    </dd>
                </dl>
             </span>
          </div>

          <div width="100%" valign="top" align="right">
             <div align="left" tal:define="attachments context/attachmentValues" tal:condition="attachments">

                <tal:block tal:repeat="attachment attachments">
                   <img src="trombone.gif" alt="Attachment">
                   <a href="" tal:attributes="href string:attachments/${attachment/getId}"
                      tal:content="attachment/getId"/>
                </tal:block>
             </div>
          </div>

          <metal:statement metal:define-macro="statement">

          <div tal:define="d context/Description" tal:condition="d" tal:replace="d"/>
          <br/>

          <table summary="" border="0" cellpadding="2" cellspacing="0" width="100%"
                 tal:define="global balance python: context.balance(effective=effective,currency=currency);
                             global debit_total python: context.zeroAmount(currency);
                             global credit_total python: context.zeroAmount(currency);">
             <tr class="row">
                <td class="field">&nbsp;</td>
                <td class="field"><strong>Entered</strong></td>
                <td class="field"><strong>Date</strong></td>
                <td class="field"><strong>Description</strong></td>
                <td class="field" align="right"><strong>Debit</strong></td>
                <td class="field" align="right"><strong>Credit</strong></td>
                <td class="field" align="right"><strong>Balance</strong></td>
             </tr>
             <tr tal:repeat="entry entries"
                 tal:attributes="class python: repeat['entry'].odd() and 'odd' or 'even'">
                    <tal:entry tal:define="txn python: entry.blTransaction()">
                       <td align="left" nowrap>
                           <a href="" tal:attributes="href entry/absolute_url" tal:on-error="string:">
                              <img src="" alt="Entry" tal:define="icon python:entry.getIcon(1)" 
                                   tal:attributes="src string:${utool}/${icon}" border="0"/>
                           </a>
                           <img src="" tal:attributes="src string:${utool}/trombone.gif"
                                tal:condition="python: txn and txn.hasAttachments()"/>
                       </td>
                       <td class="field" tal:content="entry/Creator"/>
                       <td class="field" tal:define="e python: txn and txn.effective_date or effective"
                                         tal:content="python: e.strftime('%Y/%m/%d')"/>
                       <td class="field" align="left">
                           <a href="" tal:condition="python: txn" 
                                      tal:attributes="href txn/absolute_url"
                                      tal:content="entry/Title"/>
                           <a href="" tal:condition="python: not txn and entry.isControlEntry()"
                                      tal:attributes="href entry/blLedgerUrl"
                                      tal:content="entry/Title"/>
                       </td>
                       <tal:amounts tal:define="amount python: entry.amountAs(currency)">
                          <tal:debit tal:condition="entry/isDebit">
                              <td class="field" align="right" nowrap tal:content="amount"/>
                              <td class="field">&nbsp;</td>
                              <tal:compute tal:define="global debit_total python: debit_total + amount"/>
                          </tal:debit>
                          <tal:credit tal:condition="entry/isCredit">
                              <td class="field">&nbsp;</td>
                              <td class="field" align="right" nowrap tal:content="python: abs(amount)"/>
                              <tal:compute tal:define="global credit_total python: credit_total - amount"/>
                          </tal:credit>
                          <td class="field" align="right" nowrap  tal:content="balance"/>
                          <tal:compute tal:define="global balance python: balance - amount"/>
                       </tal:amounts>
                    </tal:entry>
                </tr>
                <tr tal:condition="python: not all">
                   <td class="field" colspan="2"/>
                   <td class="field" tal:content="python: opening_dt.strftime('%Y/%m/%d')"/>
                   <td class="field">Opening Balance</td>
                   <td class="field" colspan="3" align="right" nowrap tal:content="opening_bal"/>
                </tr>
                <tr tal:condition="entries">
                   <td colspan="8"><hr/></td>
                </tr>
                <tr tal:condition="entries">
                    <td class="field" colspan="4"/>
                    <td class="field" align="right" nowrap>
                       <i tal:content="debit_total"/>
                    </td>
                    <td class="field" align="right" nowrap>
                       <i tal:content="python: abs(credit_total)"/>
                    </td>
                    <td class="field"/>
                </tr>
          </table>
         </metal:statement>
        </form>

        <br/>

        <form action="" name="edit_form"  method="post" class="visualNoPrint"
             tal:condition="python: context.SecurityCheckPermission('BastionLedger: Operate')"
             tal:attributes="action string:${template/getId}"
             tal:define="errors options/state/getErrors">

            <div tal:define="error errors/email|nothing;
                             Email request/email | python: getattr(context.aq_inner, 'email', '')"
                 tal:attributes="class python:error and 'field error' or 'field'">

                <div tal:content="error">Validation error output</div>

                <input type="text" name="email" size="50" value=""
                       tal:attributes="value Email"/>

                 <input class="context"
                        
                        type="submit"
                        name="form.button.Email"
                        value="Email"
                        i18n:attributes="value" />

            </div>

            <input type="hidden" name="form.submitted" value="1" />

        </form>

      <div tal:replace="structure provider:plone.belowcontentbody">
           Document actions (print, sendto etc)
      </div>
   </div>
 
</body>
</html>

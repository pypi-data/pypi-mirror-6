

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>How to set up ‘live’ logging with pywws &mdash; pywws 13.12.dev1117 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '13.12.dev1117',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/pywws_logo.ico"/>
    <link rel="top" title="pywws 13.12.dev1117 documentation" href="../index.html" />
    <link rel="up" title="User guides" href="index.html" />
    <link rel="next" title="How to integrate pywws with various weather services" href="integration.html" />
    <link rel="prev" title="How to set up ‘hourly’ logging with pywws" href="hourlylogging.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="integration.html" title="How to integrate pywws with various weather services"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="hourlylogging.html" title="How to set up ‘hourly’ logging with pywws"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">pywws 13.12.dev1117 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">User guides</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="how-to-set-up-live-logging-with-pywws">
<h1>How to set up &#8216;live&#8217; logging with pywws<a class="headerlink" href="#how-to-set-up-live-logging-with-pywws" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>There are two quite different modes of operation with pywws.
Traditionally <a class="reference internal" href="../api/pywws.Hourly.html#module-pywws.Hourly" title="pywws.Hourly"><tt class="xref py py-mod docutils literal"><span class="pre">Hourly</span></tt></a> would be run at regular intervals (usually an hour) from cron.
This is suitable for fairly static websites, but more frequent updates can be useful for sites such as Weather Underground (<a class="reference external" href="http://www.wunderground.com/">http://www.wunderground.com/</a>).
The newer <a class="reference internal" href="../api/pywws.LiveLog.html#module-pywws.LiveLog" title="pywws.LiveLog"><tt class="xref py py-mod docutils literal"><span class="pre">LiveLog</span></tt></a> program runs continuously and can upload data every 48 seconds.</p>
</div>
<div class="section" id="getting-started">
<h2>Getting started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h2>
<p>First of all, you need to install pywws and make sure it can get data from your weather station.
See <a class="reference internal" href="getstarted.html"><em>How to get started with pywws</em></a> for details.</p>
<p>Try running <a class="reference internal" href="../api/pywws.LiveLog.html#module-pywws.LiveLog" title="pywws.LiveLog"><tt class="xref py py-mod docutils literal"><span class="pre">LiveLog</span></tt></a> from the command line, with a high level of verbosity so you can see what&#8217;s happening:</p>
<div class="highlight-python"><pre>python -m pywws.LiveLog -vvv ~/weather/data</pre>
</div>
<p>Within five minutes (assuming you have set a 5 minute logging interval) you should see a &#8216;live_data new ptr&#8217; message, followed by fetching any new data from the weather station and processing it.
Let <a class="reference internal" href="../api/pywws.LiveLog.html#module-pywws.LiveLog" title="pywws.LiveLog"><tt class="xref py py-mod docutils literal"><span class="pre">LiveLog</span></tt></a> run for a minute or two longer, then kill the process by typing &#8216;&lt;Ctrl&gt;C&#8217;.</p>
</div>
<div class="section" id="configuring-file-locations">
<h2>Configuring file locations<a class="headerlink" href="#configuring-file-locations" title="Permalink to this headline">¶</a></h2>
<p>Open your weather.ini file with a text editor.
You should have a <tt class="docutils literal"><span class="pre">[paths]</span></tt> section similar to the following (where <tt class="docutils literal"><span class="pre">xxx</span></tt> is your user name):</p>
<div class="highlight-python"><pre>[paths]
work = /tmp/weather
templates = /home/xxx/weather/templates/
graph_templates = /home/xxx/weather/graph_templates/
local_files = /home/xxx/weather/results/</pre>
</div>
<p>Edit these to suit your installation and preferences.
<tt class="docutils literal"><span class="pre">work</span></tt> is a temporary directory used to store intermediate files, <tt class="docutils literal"><span class="pre">templates</span></tt> is the directory where you keep your text template files, <tt class="docutils literal"><span class="pre">graph_templates</span></tt> is the directory where you keep your graph template files and <tt class="docutils literal"><span class="pre">local_files</span></tt> is a directory where template output that is not uploaded to your web site is put.
Don&#8217;t use the pywws example directories for your templates, as they will get over-written when you upgrade pywws.</p>
<p>Copy your text and graph templates to the appropriate directories.
You may find some of the examples provided with pywws useful to get started.
If you installed pywws with <tt class="docutils literal"><span class="pre">pip</span></tt> the examples should be in <tt class="docutils literal"><span class="pre">/usr/share/pywws</span></tt> or <tt class="docutils literal"><span class="pre">/usr/local/share/pywws</span></tt> or similar.</p>
</div>
<div class="section" id="configuring-periodic-tasks">
<h2>Configuring periodic tasks<a class="headerlink" href="#configuring-periodic-tasks" title="Permalink to this headline">¶</a></h2>
<p>In weather.ini you should have a <tt class="docutils literal"><span class="pre">[live]</span></tt> section similar to the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="n">live</span><span class="p">]</span>
<span class="n">services</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">plot</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">text</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
<p>This section specifies what pywws should do every time it gets a new reading from the weather station, i.e. every 48 seconds.
The <tt class="docutils literal"><span class="pre">services</span></tt> entry is a list of online weather services to upload data to, e.g. <tt class="docutils literal"><span class="pre">['underground_rf']</span></tt>.
The <tt class="docutils literal"><span class="pre">plot</span></tt> and <tt class="docutils literal"><span class="pre">text</span></tt> entries are lists of template files for plots and text files to be processed and, optionally, uploaded to your web site.
You should probably leave all of these blank except for <tt class="docutils literal"><span class="pre">services</span></tt>.</p>
<p>If you use YoWindow (<a class="reference external" href="http://yowindow.com/">http://yowindow.com/</a>) you can add an entry to the <tt class="docutils literal"><span class="pre">[live]</span></tt> section to specify your YoWindow file, e.g.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="n">live</span><span class="p">]</span>
<span class="n">services</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;underground_rf&#39;</span><span class="p">]</span>
<span class="n">text</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;yowindow.xml&#39;</span><span class="p">,</span> <span class="s">&#39;L&#39;</span><span class="p">)]</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Note the use of the <tt class="docutils literal"><span class="pre">'L'</span></tt> flag &#8211; this tells pywws to copy the template result to your &#8220;local files&#8221; directory instead of uploading it to your ftp site.</p>
<p>If you don&#8217;t already have them, create four more sections in your weather.ini file: <tt class="docutils literal"><span class="pre">[logged]</span></tt>, <tt class="docutils literal"><span class="pre">[hourly]</span></tt>, <tt class="docutils literal"><span class="pre">[12</span> <span class="pre">hourly]</span></tt> and <tt class="docutils literal"><span class="pre">[daily]</span></tt>.
These sections should have similar entries to the <tt class="docutils literal"><span class="pre">[live]</span></tt> section, and specify what to do every time data is logged (5 to 30 minutes, depending on your logging interval), every hour, twice daily and once per day.
Add the names of your template files to the appropriate entries, for example:</p>
<div class="highlight-python"><pre>[logged]
services = ['underground', 'metoffice']
plot = []
text = []

[hourly]
services = []
plot = ['7days.png.xml', '24hrs.png.xml', 'rose_24hrs.png.xml']
text = [('tweet.txt', 'T'), '24hrs.txt', '6hrs.txt', '7days.txt']

[12 hourly]
services = []
plot = []
text = []

[daily]
services = []
plot = ['28days.png.xml']
text = [('forecast.txt', 'T'), 'allmonths.txt']</pre>
</div>
<p>Note the use of the <tt class="docutils literal"><span class="pre">'T'</span></tt> flag &#8211; this tells pywws to send the template result to Twitter instead of uploading it to your ftp site.</p>
<p class="versionchanged">
<span class="versionmodified">Changed in version 13.06_r1015: </span>added the <tt class="docutils literal"><span class="pre">'T'</span></tt> flag.
Previously Twitter templates were listed separately in <tt class="docutils literal"><span class="pre">twitter</span></tt> entries in the <tt class="docutils literal"><span class="pre">[hourly]</span></tt> and other sections.
The older syntax still works, but is deprecated.</p>
<p class="versionchanged">
<span class="versionmodified">Changed in version 13.05_r1013: </span>added a <tt class="docutils literal"><span class="pre">'yowindow.xml'</span></tt> template.
Previously yowindow files were generated by a separate module, invoked by a <tt class="docutils literal"><span class="pre">yowindow</span></tt> entry in the <tt class="docutils literal"><span class="pre">[live]</span></tt> section.
This older syntax still works, but is deprecated.</p>
</div>
<div class="section" id="asynchronous-uploads">
<h2>Asynchronous uploads<a class="headerlink" href="#asynchronous-uploads" title="Permalink to this headline">¶</a></h2>
<p class="versionadded">
<span class="versionmodified">New in version 13.09_r1057.</span></p>
<p>Uploading data to web sites or &#8216;services&#8217; can sometimes take a long time, particularly if a site has gone off line and the upload times out.
In normal operation pywws waits until all uploads have been processed before fetching any more data from the weather station.
This can lead to data sometimes being missed.</p>
<p>The <tt class="docutils literal"><span class="pre">asynchronous</span></tt> item in the <tt class="docutils literal"><span class="pre">[config]</span></tt> section of weather.ini can be set to <tt class="docutils literal"><span class="pre">True</span></tt> to tell <a class="reference internal" href="../api/pywws.LiveLog.html#module-pywws.LiveLog" title="pywws.LiveLog"><tt class="xref py py-mod docutils literal"><span class="pre">LiveLog</span></tt></a> to do these uploads in a separate thread.
This feature is still a bit experimental &#8211; try it at your own risk.</p>
</div>
<div class="section" id="using-a-utility-script">
<h2>Using a utility script<a class="headerlink" href="#using-a-utility-script" title="Permalink to this headline">¶</a></h2>
<p>The pywws installation includes a short script <tt class="docutils literal"><span class="pre">pywws-livelog.py</span></tt> that gets installed in <tt class="docutils literal"><span class="pre">/usr/bin</span></tt> or <tt class="docutils literal"><span class="pre">/usr/local/bin</span></tt> or similar.
You should be able to use this script to run <a class="reference internal" href="../api/pywws.LiveLog.html#module-pywws.LiveLog" title="pywws.LiveLog"><tt class="xref py py-mod docutils literal"><span class="pre">LiveLog</span></tt></a>:</p>
<div class="highlight-python"><pre>pywws-livelog.py -v ~/weather/data</pre>
</div>
</div>
<div class="section" id="run-in-the-background">
<h2>Run in the background<a class="headerlink" href="#run-in-the-background" title="Permalink to this headline">¶</a></h2>
<p>In order to have <a class="reference internal" href="../api/pywws.LiveLog.html#module-pywws.LiveLog" title="pywws.LiveLog"><tt class="xref py py-mod docutils literal"><span class="pre">LiveLog</span></tt></a> carry on running after you finish using your computer it needs to be run as a &#8216;background job&#8217;.
On most Linux / UNIX systems you can do this by putting an ampersand (&#8216;&amp;&#8217;) at the end of the command line.
For example:</p>
<div class="highlight-python"><pre>pywws-livelog.py ~/weather/data &amp;</pre>
</div>
<p>However, it would be useful to know what went wrong if the program crashes for any reason. <a class="reference internal" href="../api/pywws.LiveLog.html#module-pywws.LiveLog" title="pywws.LiveLog"><tt class="xref py py-mod docutils literal"><span class="pre">LiveLog</span></tt></a> can store its messages in a log file, specified with the <tt class="docutils literal"><span class="pre">-l</span></tt> option:</p>
<div class="highlight-python"><pre>pywws-livelog.py -v -l ~/weather/data/pywws.log ~/weather/data &amp;</pre>
</div>
</div>
<div class="section" id="automatic-restarting">
<h2>Automatic restarting<a class="headerlink" href="#automatic-restarting" title="Permalink to this headline">¶</a></h2>
<p>There are various ways of configuring a Linux system to start a program when the machine boots up.
Typically these involve putting a file in <tt class="docutils literal"><span class="pre">/etc/init.d/</span></tt>, which requires root privileges.
A slightly harder problem is ensuring a program restarts if it crashes.
My solution to both problems is to run the following script from cron, every hour.</p>
<div class="highlight-python"><pre>#!/bin/sh

pidfile=/var/run/pywws.pid
datadir=/data/weather
logfile=$datadir/live_logger.log

# exit if process is running
[ -f $pidfile ] &amp;&amp; kill -0 `cat $pidfile` &amp;&amp; exit

# email last few lines of the logfile to see why it died
if [ -f $logfile ]; then
  log=/var/log/log-weather
  tail -40 $logfile &gt;$log
  /home/jim/scripts/email-log.sh $log "weather log"
  rm $log
  fi

# restart process
pywws-livelog.py -v -l $logfile $datadir &amp;
echo $! &gt;$pidfile</pre>
</div>
<p>This stores the process id of the running <a class="reference internal" href="../api/pywws.LiveLog.html#module-pywws.LiveLog" title="pywws.LiveLog"><tt class="xref py py-mod docutils literal"><span class="pre">LiveLog</span></tt></a> in pidfile.
If the process is running, the script does nothing.
If the process has crashed, it emails the last 40 lines of the log file to me (using a script that creates a message and passes it to sendmail) and then restarts <a class="reference internal" href="../api/pywws.LiveLog.html#module-pywws.LiveLog" title="pywws.LiveLog"><tt class="xref py py-mod docutils literal"><span class="pre">LiveLog</span></tt></a>.
You&#8217;ll need to edit this quite a lot to suit your file locations and so on, but it gives some idea of what to do.</p>
<hr class="docutils" />
<p>Comments or questions? Please subscribe to the pywws mailing list <a class="reference external" href="http://groups.google.com/group/pywws">http://groups.google.com/group/pywws</a> and let us know.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/pywws_logo.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">How to set up &#8216;live&#8217; logging with pywws</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#getting-started">Getting started</a></li>
<li><a class="reference internal" href="#configuring-file-locations">Configuring file locations</a></li>
<li><a class="reference internal" href="#configuring-periodic-tasks">Configuring periodic tasks</a></li>
<li><a class="reference internal" href="#asynchronous-uploads">Asynchronous uploads</a></li>
<li><a class="reference internal" href="#using-a-utility-script">Using a utility script</a></li>
<li><a class="reference internal" href="#run-in-the-background">Run in the background</a></li>
<li><a class="reference internal" href="#automatic-restarting">Automatic restarting</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="hourlylogging.html"
                        title="previous chapter">How to set up &#8216;hourly&#8217; logging with pywws</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="integration.html"
                        title="next chapter">How to integrate pywws with various weather services</a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="integration.html" title="How to integrate pywws with various weather services"
             >next</a> |</li>
        <li class="right" >
          <a href="hourlylogging.html" title="How to set up ‘hourly’ logging with pywws"
             >previous</a> |</li>
        <li><a href="../index.html">pywws 13.12.dev1117 documentation</a> &raquo;</li>
          <li><a href="index.html" >User guides</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2008-13, Jim Easterbrook.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>
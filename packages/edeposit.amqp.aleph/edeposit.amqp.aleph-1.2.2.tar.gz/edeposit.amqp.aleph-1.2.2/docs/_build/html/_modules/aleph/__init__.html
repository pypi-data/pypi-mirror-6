

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>aleph.__init__</title>
    
    <link rel="stylesheet" href="../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/theme_extras.js"></script>
    <link rel="top" title="" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
      <div class="header"><img class="rightlogo" src="../../_static/nkp_logo.png" alt="Logo"/><h1 class="heading"><a href="../../index.html">
          <span></span></a></h1>
        <h2 class="heading"><span>aleph.__init__</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for aleph.__init__</h1><div class="highlight"><pre>
<span class="c">#! /usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">#</span>
<span class="c"># Interpreter version: python 2.7</span>
<span class="c">#</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">- Query workflow --------------------------------------------------------------</span>

<span class="sd">To query Aleph, just create one of the Queries - ISBNQuery for example and put</span>
<span class="sd">it into SearchRequest wrapper. Then encode it by calling toAMQPMessage() and</span>
<span class="sd">send the message to the Aleph&#39;s exchange.</span>

<span class="sd">---</span>
<span class="sd">isbnq = ISBNQuery(&quot;80-251-0225-4&quot;)</span>
<span class="sd">request = SearchRequest(isbnq)</span>

<span class="sd">amqp.send(</span>
<span class="sd">    message    = serialize(request),</span>
<span class="sd">    properties = &quot;..&quot;,</span>
<span class="sd">    exchange   = &quot;ALEPH&#39;S_EXCHANGE&quot;</span>
<span class="sd">)</span>
<span class="sd">---</span>

<span class="sd">and you will get back AMQP message, and after decoding with fromAMQPMessage()</span>
<span class="sd">also SearchResult.</span>

<span class="sd">If you want to just get count of how many items is there in Aleph, just wrap</span>
<span class="sd">the ISBNQuery with CountRequest (you should use this instead of just calling</span>
<span class="sd">len() to SearchResult.records - it doesn&#39;t put that much load to Aleph):</span>

<span class="sd">---</span>
<span class="sd">isbnq = ISBNQuery(&quot;80-251-0225-4&quot;)</span>
<span class="sd">request = CountRequest(isbnq)</span>

<span class="sd"># rest is same..</span>
<span class="sd">---</span>

<span class="sd">and you will get back (after decoding) CountResult.</span>

<span class="sd">Here is ASCII flow diagram for you:</span>

<span class="sd">ISBNQuery      ----.                                 ,--&gt; CountResult</span>
<span class="sd">AuthorQuery    ----|                                 |        `- num_of_records</span>
<span class="sd">PublisherQuery ----|                                 |</span>
<span class="sd">GenericQuery   ----|      ISBNValidationRequest      |--&gt; SearchResult</span>
<span class="sd">                   |                |                |        `- AlephRecord</span>
<span class="sd">                   V                |                |</span>
<span class="sd">         Count/SearchRequest        |                |--&gt; ISBNValidationResult</span>
<span class="sd">                   |                |                |        `- ISBN</span>
<span class="sd">                   V                |                |</span>
<span class="sd">              serialize()&lt;----------&#39;           deserialize()</span>
<span class="sd">                   |                                 ^</span>
<span class="sd">                   V             Client              |</span>
<span class="sd">              AMQPMessage ------&gt; AMQP -------&gt; AMQPMessage</span>
<span class="sd">                                 |    ^</span>
<span class="sd">                                 V    |</span>
<span class="sd">                                 |    ^</span>
<span class="sd">                                 V    |</span>
<span class="sd">                                 |    ^</span>
<span class="sd">                                 V    |</span>
<span class="sd">              AMQPMessage &lt;------ AMQP &lt;-------- AMQPMessage</span>
<span class="sd">                   |             Service              ^</span>
<span class="sd">                   |                                  |</span>
<span class="sd">                   V                                  |</span>
<span class="sd">          reactToAMQPMessage() ............... magic_happens()</span>

<span class="sd">Neat, isn&#39;t it?</span>

<span class="sd">- Export workflow -------------------------------------------------------------</span>
<span class="sd">TODO: implement, then write docstring</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c">#= Imports ====================================================================</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>


<span class="kn">import</span> <span class="nn">isbn</span>
<span class="kn">import</span> <span class="nn">aleph</span>
<span class="kn">import</span> <span class="nn">convertors</span>


<span class="c"># Datatypes for searching in Aleph ############################################</span>
<div class="viewcode-block" id="CountRequest"><a class="viewcode-back" href="../../aleph.html#aleph.__init__.CountRequest">[docs]</a><span class="k">class</span> <span class="nc">CountRequest</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;CountRequest&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;query&quot;</span><span class="p">])):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Put one of the Queries to .query property and it will return just</span>
<span class="sd">    number of records, instead of records itself.</span>

<span class="sd">    This help to saves some of Aleph resources (yeah, it is restricted to give</span>
<span class="sd">    too much queries by license).</span>

<span class="sd">    query -- GenericQuery, ISBNQuery, .. *Query structures in this module</span>

<span class="sd">    reactToAMQPMessage() returns CountResult as response.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="SearchRequest"><a class="viewcode-back" href="../../aleph.html#aleph.__init__.SearchRequest">[docs]</a><span class="k">class</span> <span class="nc">SearchRequest</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;SearchRequest&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;query&#39;</span><span class="p">])):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform search in Aleph with given query.</span>

<span class="sd">    query -- GenericQuery, ISBNQuery, .. *Query structures in this module</span>

<span class="sd">    reactToAMQPMessage() returns SearchResult as response.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="ISBNValidationRequest"><a class="viewcode-back" href="../../aleph.html#aleph.__init__.ISBNValidationRequest">[docs]</a><span class="k">class</span> <span class="nc">ISBNValidationRequest</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;ISBNValidationRequest&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;ISBN&#39;</span><span class="p">])):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate given ISBN.</span>

<span class="sd">    reactToAMQPMessage() returns ISBNValidationResult as response.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="ISBNValidationResult"><a class="viewcode-back" href="../../aleph.html#aleph.__init__.ISBNValidationResult">[docs]</a><span class="k">class</span> <span class="nc">ISBNValidationResult</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;ISBNValidationResult&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;is_valid&quot;</span><span class="p">])):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Response to ISBNValidationRequest.</span>

<span class="sd">    is_valid -- bool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="AlephRecord"><a class="viewcode-back" href="../../aleph.html#aleph.__init__.AlephRecord">[docs]</a><span class="k">class</span> <span class="nc">AlephRecord</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;AlephRecord&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;base&#39;</span><span class="p">,</span>
                                             <span class="s">&#39;library&#39;</span><span class="p">,</span>
                                             <span class="s">&#39;docNumber&#39;</span><span class="p">,</span>
                                             <span class="s">&#39;xml&#39;</span><span class="p">,</span>
                                             <span class="s">&#39;epublication&#39;</span><span class="p">])):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This structure is returned as response to SearchRequest inside</span>
<span class="sd">    SearchResult.</span>

<span class="sd">    base -- from which base was this record pulled</span>
<span class="sd">    library -- library string, used for downloading documents from Aleph when</span>
<span class="sd">               you know proper docNumber</span>
<span class="sd">    docNumber -- identificator in Aleph. It is not that much unique as it could</span>
<span class="sd">                 be, but with .library string, you can fetch documents from</span>
<span class="sd">                 Aleph if you know this.</span>
<span class="sd">    xml -- MARC XML source returned from Aleph. Quite complicated stuff.</span>
<span class="sd">    epublication -- parsed .xml to EPublication structure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="SearchResult"><a class="viewcode-back" href="../../aleph.html#aleph.__init__.SearchResult">[docs]</a><span class="k">class</span> <span class="nc">SearchResult</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;SearchResult&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;records&#39;</span><span class="p">])):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is response structure, which is sent back when SearchRequest is</span>
<span class="sd">    received.</span>

<span class="sd">    records -- array of AlephRecord structures</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="CountResult"><a class="viewcode-back" href="../../aleph.html#aleph.__init__.CountResult">[docs]</a><span class="k">class</span> <span class="nc">CountResult</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;CountResult&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;num_of_records&#39;</span><span class="p">])):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is returned back to client when he send CountRequest.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>

</div>
<span class="k">class</span> <span class="nc">_QueryTemplate</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class is here to just save some effort by using common ancestor with</span>
<span class="sd">    same .getSearchResult() and .getCountResult() definition.</span>

<span class="sd">    You probably shouldn&#39;t use it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">getSearchResult</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">doc_id</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">base</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getIDs</span><span class="p">():</span>
            <span class="n">xml</span> <span class="o">=</span> <span class="n">aleph</span><span class="o">.</span><span class="n">downloadMARCXML</span><span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="n">library</span><span class="p">)</span>

            <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">AlephRecord</span><span class="p">(</span>
                    <span class="n">base</span><span class="p">,</span>
                    <span class="n">library</span><span class="p">,</span>
                    <span class="n">doc_id</span><span class="p">,</span>
                    <span class="n">xml</span><span class="p">,</span>
                    <span class="n">convertors</span><span class="o">.</span><span class="n">toEPublication</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">SearchResult</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getCountResult</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CountResult</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getCount</span><span class="p">())</span>


<div class="viewcode-block" id="GenericQuery"><a class="viewcode-back" href="../../aleph.html#aleph.__init__.GenericQuery">[docs]</a><span class="k">class</span> <span class="nc">GenericQuery</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;GenericQuery&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;base&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;phrase&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;considerSimilar&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;field&#39;</span><span class="p">]),</span>
                   <span class="n">_QueryTemplate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used for generic queries to aleph.</span>

<span class="sd">    For details of base/phrase/.. parameters, see aleph.py : searchInAleph().</span>

<span class="sd">    This is used mainly if you want to search by your own parameters and don&#39;t</span>
<span class="sd">    want to use prepared wrappers (AuthorQuery/ISBNQuery/..).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_getIDs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">aleph</span><span class="o">.</span><span class="n">getDocumentIDs</span><span class="p">(</span>
            <span class="n">aleph</span><span class="o">.</span><span class="n">searchInAleph</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">considerSimilar</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">field</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getCount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">aleph</span><span class="o">.</span><span class="n">searchInAleph</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phrase</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">considerSimilar</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">field</span>
        <span class="p">)[</span><span class="s">&quot;no_entries&quot;</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="ISBNQuery"><a class="viewcode-back" href="../../aleph.html#aleph.__init__.ISBNQuery">[docs]</a><span class="k">class</span> <span class="nc">ISBNQuery</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;ISBNQuery&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;ISBN&quot;</span><span class="p">]),</span> <span class="n">_QueryTemplate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query for ISBN.</span>

<span class="sd">    Note: ISBN is not unique, so you can get back lot of books with same ISBN.</span>
<span class="sd">          some books also have two or more ISBNs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_getIDs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">aleph</span><span class="o">.</span><span class="n">getISBNsIDs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ISBN</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getCount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">aleph</span><span class="o">.</span><span class="n">getISBNCount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ISBN</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="AuthorQuery"><a class="viewcode-back" href="../../aleph.html#aleph.__init__.AuthorQuery">[docs]</a><span class="k">class</span> <span class="nc">AuthorQuery</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;AuthorQuery&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;author&quot;</span><span class="p">]),</span> <span class="n">_QueryTemplate</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_getIDs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">aleph</span><span class="o">.</span><span class="n">getAuthorsBooksIDs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getCount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">aleph</span><span class="o">.</span><span class="n">getAuthorsBooksCount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="PublisherQuery"><a class="viewcode-back" href="../../aleph.html#aleph.__init__.PublisherQuery">[docs]</a><span class="k">class</span> <span class="nc">PublisherQuery</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;PublisherQuery&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;publisher&quot;</span><span class="p">]),</span>
                     <span class="n">_QueryTemplate</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_getIDs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">aleph</span><span class="o">.</span><span class="n">getPublishersBooksIDs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getCount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">aleph</span><span class="o">.</span><span class="n">getPublishersBooksCount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="p">)</span>


<span class="c">###############################################################################</span>
<span class="c"># Add new record to Aleph #####################################################</span>
<span class="c"># TODO: implement exports</span>
<span class="c">#</span></div>
<div class="viewcode-block" id="Author"><a class="viewcode-back" href="../../aleph.html#aleph.__init__.Author">[docs]</a><span class="k">class</span> <span class="nc">Author</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;Author&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;firstName&#39;</span><span class="p">,</span> <span class="s">&#39;lastName&#39;</span><span class="p">,</span> <span class="s">&#39;title&#39;</span><span class="p">])):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="Producent"><a class="viewcode-back" href="../../aleph.html#aleph.__init__.Producent">[docs]</a><span class="k">class</span> <span class="nc">Producent</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;Producent&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">,</span>
                                         <span class="s">&#39;phone&#39;</span><span class="p">,</span>
                                         <span class="s">&#39;fax&#39;</span><span class="p">,</span>
                                         <span class="s">&#39;email&#39;</span><span class="p">,</span>
                                         <span class="s">&#39;url&#39;</span><span class="p">,</span>
                                         <span class="s">&#39;identificator&#39;</span><span class="p">,</span>
                                         <span class="s">&#39;ico&#39;</span><span class="p">])):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="EPublication"><a class="viewcode-back" href="../../aleph.html#aleph.__init__.EPublication">[docs]</a><span class="k">class</span> <span class="nc">EPublication</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;EPublication&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;nazev&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;podnazev&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;vazba&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;cena&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;castDil&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;nazevCasti&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;nakladatelVydavatel&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;datumVydani&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;poradiVydani&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;zpracovatelZaznamu&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;kategorieProRIV&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;mistoDistribuce&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;distributor&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;datumDistribuce&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;datumProCopyright&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;format&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;url&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;mistoVydani&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;ISBNSouboruPublikaci&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;autori&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;originaly&#39;</span><span class="p">])):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This structure is returned as result of users SearchRequest. It will be</span>
<span class="sd">    also used in exporting new data to aleph, but that is not implemented yet.</span>

<span class="sd">    In case of Search/Count requests, this structure is filled with data from</span>
<span class="sd">    MARC XML record parsed by marcxml.py.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="OriginalFile"><a class="viewcode-back" href="../../aleph.html#aleph.__init__.OriginalFile">[docs]</a><span class="k">class</span> <span class="nc">OriginalFile</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;OriginalFile&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;format&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;file&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;isbns&#39;</span><span class="p">])):</span>
    <span class="sd">&quot;&quot;&quot; type of isbn: ISBN&quot;&quot;&quot;</span>
    <span class="k">pass</span>


<span class="c">## Export protocol query wrappers #############################################</span></div>
<div class="viewcode-block" id="ExportRequest"><a class="viewcode-back" href="../../aleph.html#aleph.__init__.ExportRequest">[docs]</a><span class="k">class</span> <span class="nc">ExportRequest</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;AlephExport&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;epublication&#39;</span><span class="p">,</span>
                                               <span class="s">&#39;linkOfEPublication&#39;</span><span class="p">])):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    epublication -- type of EPublication</span>
<span class="sd">    linkOfEPublication -- url of epublication</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="ExportResult"><a class="viewcode-back" href="../../aleph.html#aleph.__init__.ExportResult">[docs]</a><span class="k">class</span> <span class="nc">ExportResult</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;AlephExportResult&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;docNumber&#39;</span><span class="p">,</span>
                                                    <span class="s">&#39;base&#39;</span><span class="p">,</span>
                                                    <span class="s">&#39;xml&#39;</span><span class="p">,</span>
                                                    <span class="s">&#39;success&#39;</span><span class="p">,</span>
                                                    <span class="s">&#39;message&#39;</span><span class="p">])):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    docNumber -- docNumber of a record in Aleph</span>
<span class="sd">    base      --      base of Aleph</span>
<span class="sd">    success   --   whether import was successful</span>
<span class="sd">    message   --   message of error or success</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>


<span class="c"># Interface for an external world #############################################</span>

<span class="c"># Variables ###################################################################</span></div>
<span class="n">QUERY_TYPES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ISBNQuery</span><span class="p">,</span>
    <span class="n">AuthorQuery</span><span class="p">,</span>
    <span class="n">PublisherQuery</span><span class="p">,</span>
    <span class="n">GenericQuery</span>
<span class="p">]</span>

<span class="n">REQUEST_TYPES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">SearchRequest</span><span class="p">,</span>
    <span class="n">CountRequest</span><span class="p">,</span>
    <span class="n">ExportRequest</span><span class="p">,</span>
    <span class="n">ISBNValidationRequest</span>
<span class="p">]</span>


<div class="viewcode-block" id="serialize"><a class="viewcode-back" href="../../aleph.html#aleph.__init__.serialize">[docs]</a><span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Serialize class hierarchy into JSON.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">convertors</span><span class="o">.</span><span class="n">toJSON</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="deserialize"><a class="viewcode-back" href="../../aleph.html#aleph.__init__.deserialize">[docs]</a><span class="k">def</span> <span class="nf">deserialize</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deserialize classes from JSON data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">convertors</span><span class="o">.</span><span class="n">fromJSON</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="iiOfAny"><a class="viewcode-back" href="../../aleph.html#aleph.__init__.iiOfAny">[docs]</a><span class="k">def</span> <span class="nf">iiOfAny</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">classes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns true, if `instance` is instance of any (iiOfAny) of the `classes`.</span>

<span class="sd">    This function doesn&#39;t use isinstance() check, it just compares the</span>
<span class="sd">    classnames.</span>

<span class="sd">    This can be generaly dangerous, but it is really useful when you are</span>
<span class="sd">    comparing class serialized in one module and deserialized in another.</span>

<span class="sd">    This causes, that module paths in class internals are different and</span>
<span class="sd">    isinstance() and type() comparsions thus fails.</span>

<span class="sd">    Use this function instead, if you wan&#39;t to check what type is your</span>
<span class="sd">    deserialized message.</span>

<span class="sd">    instance -- class instance you want to know the type</span>
<span class="sd">    classes -- list of classes, or just the class you want to compare - func</span>
<span class="sd">               automatically retypes nonlist/nontuple parameters to list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]:</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="p">[</span><span class="n">classes</span><span class="p">]</span>

    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="n">x</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">classes</span><span class="p">))</span>


<span class="c"># Functions ###################################################################</span></div>
<div class="viewcode-block" id="reactToAMQPMessage"><a class="viewcode-back" href="../../aleph.html#aleph.__init__.reactToAMQPMessage">[docs]</a><span class="k">def</span> <span class="nf">reactToAMQPMessage</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">response_callback</span><span class="p">,</span> <span class="n">UUID</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    React to given AMQPMessage. Return data thru given callback function.</span>

<span class="sd">    message -- message encoded in JSON by serialize()</span>
<span class="sd">    response_callback -- function taking exactly ONE parameter - message&#39;s body</span>
<span class="sd">                         with response. Function take care of sending the</span>
<span class="sd">                         response over AMQP.</span>

<span class="sd">    Returns result of response_callback() call.</span>

<span class="sd">    Raise:</span>
<span class="sd">        ValueError if bad type of `message` structure is given.</span>

<span class="sd">    TODO:</span>
<span class="sd">        React to Export requests.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="k">else</span> <span class="n">message</span>

    <span class="c"># TODO: pridat podporu exportnich typu</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">iiOfAny</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">REQUEST_TYPES</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s">&quot;Unknown type of request: &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;&#39;!&quot;</span>
        <span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">iiOfAny</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">CountRequest</span><span class="p">)</span> <span class="ow">and</span> <span class="n">iiOfAny</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">QUERY_TYPES</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">getCountResult</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">iiOfAny</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">SearchRequest</span><span class="p">)</span> <span class="ow">and</span> <span class="n">iiOfAny</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">QUERY_TYPES</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">getSearchResult</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">iiOfAny</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ExportRequest</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Not implemented yet.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">iiOfAny</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">ISBNValidationRequest</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">ISBNValidationResult</span><span class="p">(</span><span class="n">isbn</span><span class="o">.</span><span class="n">is_valid_isbn</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">ISBN</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s">&quot;Unknown type of request: &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">req</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;&#39; or query: &#39;&quot;</span> <span class="o">+</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">query</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;&#39;!&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response_callback</span><span class="p">(</span><span class="n">serialize</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="n">UUID</span><span class="p">)</span></div>
</pre></div>

      </div>
      <div class="bottomnav">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2013, Jan Stavěl.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>
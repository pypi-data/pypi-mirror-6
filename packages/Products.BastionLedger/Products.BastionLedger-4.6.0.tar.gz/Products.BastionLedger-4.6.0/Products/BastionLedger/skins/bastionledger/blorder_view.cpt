<html xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="bastionledger">

  <metal:border fill-slot="top_slot">
    <tal:border define="dummy python:request.set('enable_border',1)" />
  </metal:border>
 
<body>
  <div metal:fill-slot="main" 
       tal:define="errors options/state/getErrors;
                   utool context/@@plone_portal_state/portal_url;
                   sales_tax python: here.isReceivable() and 'sales_tax_due' or 'sales_tax_paid'">

      <h1><img src="" alt="" tal:define="icon python:context.getIcon(1)" 
               tal:attributes="src string:${utool}/${icon}">&nbsp;<span tal:replace="context/Title | context/getId"/></h1>

       <tal:byline tal:on-error="string:">
         <div tal:replace="structure provider:plone.belowcontenttitle"/>
       </tal:byline>

       <metal:order metal:define-macro="order">
          <tal:defines tal:define="items context/orderItemValues;
                                   account context/blAccount;
                                   newline_to_br python: modules['Products.PythonScripts.standard'].newline_to_br">

              <h3 align="center">Tax Invoice</h3>
              <h3 align="center" tal:content="python: context.getLedgerProperty('title')"/>
              <h3 align="center" tal:define="tax_no python: context.getLedgerProperty('tax_number')"
                  tal:condition="tax_no">
                  Tax No. <span tal:replace="tax_no"/></h3>
              <br/>
              <div align="center">
                  <small tal:content="python: ', '.join(context.getLedgerProperty('address', '').split('\n'))"/>
              </div>
              <br/>
              <br/>
              <h4 align="center">
                   Order Ref&nbsp;
                   <a href="" tal:attributes="href context/absolute_url" tal:content="context/getId"/>
              </h4>
              <h4 align="center" 
                   tal:define="txn context/blTransaction"
                   tal:condition="nocall: txn">
                   Transaction Ref&nbsp;
                    <a href="" tal:attributes="href txn/absolute_url" tal:content="txn/getId"/>
              </h4>
              <br/>
              <br/>

       <table summary="" border="0" cellspacing="0" cellpadding="2"
              tal:define="billingaddress context/billingaddress;
                          shiptoaddress context/shiptoaddress">
           <tr tal:define="company context/company" tal:condition="company">
               <td class="label">Company</td>
               <td class="field" nowrap tal:content="company"/>
           </tr>
           <tr>
               <td class="label">Contact</td>
               <td class="field" 
                   tal:define="email context/contactEmail; 
                               contact context/contact | context/aq_parent/contact | nothing">
                   <span tal:condition="not: email" tal:replace="contact"/>
                   <a class="link-email" tal:condition="email" 
                      tal:attributes="href string:mailto:${email}" tal:content="contact"/>
               </td>
           </tr>
           <tr tal:condition="billingaddress">
               <td class="label" valign="top" tal:condition="not: shiptoaddress">Address</td>
               <td class="label" valign="top" tal:condition="shiptoaddress">Billing Address</td>
               <td class="field" tal:content="structure python: newline_to_br(billingaddress)"/>
           </tr>
           <tr tal:condition="shiptoaddress"><td>&nbsp;</td></tr>
           <tr tal:condition="shiptoaddress">
               <td class="label" valign="top">Shipping Address</td>
               <td class="field" tal:content="structure python: newline_to_br(shiptoaddress)"/>
           </tr>
           <tr><td>&nbsp;</td></tr>
           <tr tal:on-error="string:">
               <td class="label" nowrap>Invoice Date</td>
               <td class="field" tal:content="python: context.invoiceDate().strftime('%Y/%m/%d')"/>
           </tr>
           <tr tal:on-error="string:">
               <td class="label" nowrap>Order Date</td>
               <td class="field" tal:content="python: context.orderdate.strftime('%Y/%m/%d')"/>
           </tr>
           <tr tal:on-error="string:">
               <td class="label" nowrap>Required Date</td>
               <td class="field" tal:content="python: context.reqdate.strftime('%Y/%m/%d')"/>
           </tr>
           <tr><td>&nbsp;</td></tr>
           <tr tal:define="notes context/notes" tal:condition="notes">
               <td class="label" valign="top">Notes</td>
               <td class="field" colspan="3"
                   tal:content="structure python: newline_to_br(notes)"/>
           </tr>
         </table>

         <br/>
         <br/>

         <metal:orderlines define-macro="orderlines">
           <tal:defines tal:define="utool context/@@plone_portal_state/portal_url;
                                    discount context/discount;
                                    freight context/blorder_freight;
                                    taxincluded context/taxincluded;">

             <table summary="" border="0" cellpadding="2" cellspacing="0"
                    tal:condition="items">
                <tr class="row">
                    <td class="field" width="25"/>
                    <td class="field" width="50%">
                         <span class="label">Description</span>
                    </td>
                    <td class="field" align="right">
                         <span class="label">Quantity</span>
                    </td>
                    <td class="field">&nbsp;&nbsp;&nbsp;</td>
                    <td class="field" align="right">
                         <span class="label">Unit Price</span>
                    </td>
                    <td class="field">&nbsp;&nbsp;&nbsp;</td>
                    <td class="field" align="right">
                         <span class="label">Amount</span>
                    </td>
                    <td class="field">&nbsp;</td>
                 </tr>
                 <tr tal:repeat="item items" class="row"
                     tal:attributes="class python:repeat['item'].odd() and 'odd' or 'even'">
                       <td class="field" valign="top">
                           <img border="0" src="" 
                                tal:define="icon python:item.getIcon(1)" 
                                tal:attributes="src string:${utool}/${icon}"
                                tal:on-error="string:"/>
                       </td>
                       <td class="field" valign="top" nowrap tal:define="part item/blPart">
                          <a href=""
                             tal:condition="nocall: part" 
                             tal:attributes="href part/absolute_url" 
                             tal:content="item/title"/>
                          <span tal:condition="python: part is None" tal:content="item/title"/>
			  <div class="formHelp" tal:condition="item/note | nothing" tal:content="item/note"/>
                       </td>
                       <td class="field" valign="top" align="right" tal:content="item/quantity"/>
                       <td class="field">&nbsp;&nbsp;&nbsp;</td>
                       <td class="field" valign="top" align="right" nowrap tal:content="item/unit" />
                       <td class="field">&nbsp;&nbsp;&nbsp;</td>
                       <td class="field" valign="top" align="right" nowrap tal:content="item/calculateGrossPrice"/>
                       <td class="field">&nbsp;</td>
                    </tr>
                    <tr>
                       <td colspan="6" align="right"><span class="label">Total</span></td>
                       <td class="field" align="right" nowrap>
                            <label tal:content="context/getGross"/></td>
                       <td class="field">&nbsp;</td>
                    </tr>
                    <tal:discount tal:condition="discount">
                        <tr>
                            <td colspan="6" class="field" align="right">less Discount</td>
                            <td class="field" align="right" tal:content="context/getDiscount"/>
                            <td class="field">&nbsp;</td>
                        </tr>
                    </tal:discount>
                    <tal:freight tal:condition="python: freight > 0">
                       <tr>
                          <td colspan="6" class="field" align="right">plus freight</td>
                          <td class="field" align="right" tal:content="freight"/>
                          <td class="field"/>
                       </tr>
                    </tal:freight>
                    <tal:tax tal:condition="not: taxincluded">
                       <tr tal:repeat="acct python: context.Ledger.accountValues(tags=sales_tax)" 
                           tal:on-error="string:" >
                          <td colspan="6" class="field" align="right">plus <em tal:content="acct/title"/></td>
                          <td class="field" align="right"
                              tal:content="python: context.calculateTax(acct, context.orderdate)"/>
                          <td class="field"/>
                       </tr>
                    </tal:tax>
                    <tr tal:condition="python: freight > 0 or not context.taxincluded or discount">
                        <td class="field" colspan="6" align="right"><span class="label">Net</span></td>
                        <td class="field" align="right"><label tal:content="context/getNet"/></td>
                        <td class="field">&nbsp;</td>
                    </tr>
                 </table>
               </tal:defines>
             </metal:orderlines>
         </tal:defines>
     </metal:order>

     <metal:attachments metal:define-macro="orderattachments">
        <br/>
        <br/>
        <div tal:define="attachments context/attachmentValues" tal:condition="attachments">
            <div class="label">Additional Documentation</div>
            <span id="blattachment" tal:repeat="attachment context/attachmentValues">
                <img alt="Attachment" src="trombone.gif" 
                     tal:attributes="src string:${utool}/trombone.gif"/>
                <a href="" target="_blank" 
                  tal:attributes="href string:attachments/${attachment/getId}"
                  tal:content="attachment/getId"/>
                &nbsp;&nbsp;&nbsp;
             </span>
         </div>
     </metal:attachments>
     
     <br/>
     <br/>

     <form name="order_actions"  action="."  method="post" class="visualNoPrint"
           tal:attributes="action template/getId">

        <div tal:define="error errors/email|nothing;
                         Email request/email | context/contactEmail | context/emailAddress"
             tal:attributes="class python:error and 'field error' or 'field'">

           <div tal:content="error">Validation error output</div>

           <img src="" alt="mail" tal:attributes="src string:${utool}/mail_icon.png"/>

           <input type="text" name="email" size="30" value=""
                  tal:attributes="value Email"/>

           <input class="context"
                         type="submit"
                         name="form.button.Email"
                         value="Email"
                         i18n:attributes="value" />

           <input class="standalone"
                         type="submit"
                         name="form.button.NewAccount"
                         value="New Account"
                         i18n:attributes="value" />

        </div>

        <input type="hidden" name="form.submitted" value="1" />
     </form>

      <div tal:replace="structure provider:plone.belowcontentbody">
           Document actions (print, sendto etc)
      </div>

  </div>
 
</body>
</html>

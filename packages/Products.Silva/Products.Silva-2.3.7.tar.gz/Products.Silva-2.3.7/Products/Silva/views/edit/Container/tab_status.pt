<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html tal:omit-tag=""
  lang="en"
  xml:lang="en"
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:i18n="http://xml.zope.org/namespaces/i18n"
  tal:define="vein string:publish"
  i18n:domain="silva">
<metal:use use-macro="here/macro_index/macros/master">

  <metal:block metal:fill-slot="middleground">
    <tal:buttons tal:replace="structure model/@@tab_publish_extra" />
  </metal:block>

<metal:fill fill-slot="main">

<form action="."
  method="post"
  name="silvaObjects"
  id="silvaObjectsPermissions"
  tal:define="
    objects model/get_processed_status_tree;
    refs options/refs | python: [];
    redisplay_timing_form request/redisplay_timing_form | options/redisplay_timing_form | python: 1;
    global approveables nothing;
    global rejectables nothing;
    global revokeables nothing;
    global closeables nothing;
    global new_versionables nothing;
    global republishables nothing;
    global expireables nothing;
  ">
<table class="columns columns2">
  <tbody>
    <tr>
      <tal:block replace="nothing">
        _____________________ sidebar _____________________
      </tal:block>
      <td class="left">
        <metal:use-macro use-macro="here/macro_vein_navigation/macros/vein">
          <metal:fill-slot fill-slot="sidebar">
            <tal:plug replace="structure python: here.service_sidebar.render(model, 'tab_status', vein)" />
          </metal:fill-slot>
        </metal:use-macro>
      </td>

      <tal:block replace="nothing">
        _____________________ main _____________________
      </tal:block>
      <td class="main">
      <div style="display:none;" i18n:translate="" id="update-action-message">There are publications selected to have their publication and/or expiration times updated. Are you sure you want to update all the contents of these publications?</div>
      <div style="display:none;" i18n:translate="" id="new-version-action-message">There are publications selected to create new versions. Are you sure you want to create new versions of all the contents of these publications?</div>
      <div style="display:none;" i18n:translate="" id="close-action-message">You have selected one or more publication(s) to close.  All items within the selected publication(s) will be closed.  Do you wish to continue?</div>
      <div style="display:none;" i18n:translate="" id="publish-action-message">You have selected one or more publication(s) to publish.  All items within the selected publication(s) will be published.  Do you wish to continue?</div>
      <div style="display:none;" i18n:translate="" id="reject-action-message">There are publications selected to have their request for approval rejected. Are you sure you want to reject approval for all the contents of these publications?</div>
      <div style="display:none;" i18n:translate="" id="revoke-action-message">There are publications selected to have their approval of approved versions withdrawn. Are you sure you want to withdraw approval for all the contents of these publications?</div>

<script type="text/javascript">
<!--

Array.prototype.contains = function(obj) {
  var i = this.length;
  while (i--) {
    if (this[i] == obj) {
      return true;
    }
  }
  return false;
}

var publications = new Array();
function selectAllBelowLevel(start) {
  var currentIndent = start.parentNode.parentNode.getElementsByTagName("div")[0].style.marginLeft.replace("px","");
  var inputs = document.getElementById("silvaObjectsPermissions").getElementsByTagName("input");

  var atCorrectLevel = false;

  for (var i = 0; i < inputs.length; i++) {
    if (inputs[i].id == "all_0" || inputs[i].type != "checkbox") {
      continue;
    }
    else if (inputs[i].id == "all_1") {
      break;
    }

    if (atCorrectLevel) {
      if (inputs[i].parentNode.parentNode.getElementsByTagName("div")[0].style.marginLeft.replace("px","") > currentIndent) {
        var onclick = "" + inputs[i].onclick;
        inputs[i].checked = start.checked;
        inputs[i].disabled = start.checked;

        if (onclick.match(/.*dummyPublication.*/)) {
          if (!publications.contains(inputs[i])) {
            publications.push(inputs[i]);
          }
        }
      }
      else {
        break;
      }
    }
    else if (start == inputs[i]) {
      atCorrectLevel = true;
    }
  }
}

function dummyPublication(selection) {
  if (!publications.contains(selection)) {
    publications.push(selection);
  }
}

function verifyChange(msg) {
  //See if we need to prompt the user about publication changes
  for (var i = 0; i < publications.length; i++) {
    if (publications[i].checked) {
      return confirm(msg)
    }
  }
  return true;
}

//-->
</script>
<table class="listing">
  <thead>
    <tal:block replace="nothing">
      ______________ vein + title row ______________
    </tal:block>
    <tr>
      <td class="top"
        colspan="6">
        <h2 tal:attributes="title string:id: ${model/id}">
          <img tal:replace="structure icon" />
          &#xab;<span tal:replace="title">title</span>&#xbb;
        </h2>
      </td>
    </tr>
    <tal:block replace="nothing">
      ______________ top controls row ______________
    </tal:block>
    <tr class="top-controls">
      <td colspan="6">
        <h3 i18n:translate="">
          publishing actions
        </h3>
      </td>
    </tr>
  </thead>
  <tbody>
    <tr tal:condition="objects">
      <th class="listing-left">
        <input type="checkbox"
          name="all_0"
          id="all_0"
          title="select all: alt-a"
          onclick="toggleSelect(this, 'refs');"
          i18n:attributes="title"
        />
      </th>
      <th i18n:translate="">
        modify / preview
      </th>
      <th class="align-right" i18n:translate="">
        revision
      </th>
      <th class="align-right" i18n:translate="">
        publication due
      </th>
      <th class="align-right" i18n:translate="">
        expiration due
      </th>
      <th class="align-right" i18n:translate="">
        published
      </th>
    </tr>
    <tal:block replace="nothing">
      ______________ iteration ______________
    </tal:block>
    <tal:loop repeat="obj objects">
      <tr
        tal:define="
          iterate repeat/obj/odd;
          is_container obj/implements_container | nothing;
          is_publication obj/implements_publication | nothing;
          indent_depth python: '%spx' % str(obj['indent'] * 10);
          obj_url obj/absolute_url;
          state obj/status_style | nothing;
          public_status obj/public_status | nothing;
          global rejectables python: test(state == 'pending', 1, rejectables);
          global revokeables python: test(state == 'approved', 1, revokeables);
          global approveables python: test(state == 'draft', 1, approveables);
          global new_versionables python:test(
            ((public_status == 'published' or public_status == 'closed')
            and state != 'draft' and state != 'pending' and state != 'approved'
            ), 1, new_versionables);
          global republishables python: test(state == 'closed', 1, republishables);"
        tal:attributes="
          class python: iterate and 'odd' or 'even';">
        <td class="listing-left">
          <input type="checkbox"
            name="refs:list"
            tal:define="ref obj/ref | nothing"
            tal:condition="ref"
            tal:attributes="
              value ref;
              checked python: ref in refs and 'checked' or nothing;
              onclick python: is_container and not is_publication and 'selectAllBelowLevel(this)' or is_publication and 'dummyPublication(this)' or nothing;
              "
          />
        </td>
        <tal:block replace="nothing">
          _______ icon/title cell _______
        </tal:block>
        <td>
          <div tal:attributes="style string:margin-left:${indent_depth}">
            <div style="float: left;">
              <a class="icon"
                tal:attributes="
                  href string:${obj_url}/edit/tab_edit;
                  title python: here.tab_status_get_modify_title(obj['meta_type']);
                "
                i18n:attributes="title">
                <img tal:replace="structure obj/icon" />
              </a>
            </div>
            <div style="padding-left: 19px;"
              tal:define="title obj/title">
              <a class="blacklink"
                tal:attributes="
                  class obj/status_style | default;
                  href string:${obj_url}/edit/tab_preview;
                  title python:here.tab_status_get_preview_title(obj['id']);
                  "
                  i18n:attributes="title">
                <tal:if condition="obj/is_default | nothing">
                  <em i18n:translate="">index:</em>
                  <tal:plug condition="title" replace="title" />
                  <em tal:condition="not:title" tal:content="obj/id">id</em>
                </tal:if>
                <tal:if condition="not:obj/is_default | nothing">
                  <tal:plug condition="title" replace="title" />
                  <em tal:condition="not:title" tal:content="obj/id">id</em>
                </tal:if>
              </a>
            </div>
          </div>
        </td>
        <tal:block replace="nothing">
          _______ revision cell _______
        </tal:block>
        <td class="align-right">
          <a title="publish"
            tal:condition="obj/status | nothing"
            tal:attributes="
              class obj/status_style | default;
              href string:${obj_url}/edit/tab_status;"
              i18n:attributes="title">
            <tal:block replace="obj/status" />
          </a>
          <a class="closed"
            title="publish"
            tal:condition="is_container"
            tal:attributes="
            href string:${obj_url}/edit/tab_status;"
            i18n:attributes="title">
            <em i18n:translate="">n/a</em>
          </a>
        </td>
        <tal:block replace="nothing">
          _______ publication datetime cell _______
        </tal:block>
        <td class="align-right">
          <span
            tal:content="structure obj/next_version_publication_datetime | nothing"
            tal:attributes="class obj/status_style | default;"
            tal:omit-tag="obj/status_style | default"
          />
        </td>
        <tal:block replace="nothing">
          _______ expiration datetime cell _______
        </tal:block>
        <td class="align-right">
          <span
            tal:define="
              expire_time obj/next_version_expiration_datetime | nothing;
              global expireables python:expire_time and 1 or expireables;"
            tal:content="structure expire_time"
            tal:attributes="class obj/status_style | default;"
            tal:omit-tag="obj/status_style | default"
          />
        </td>
        <tal:block replace="nothing">
          _______ public version cell _______
        </tal:block>
        <td class="listing-right"
          tal:define="
            public_status obj/public_status | nothing;
            start_time obj/public_version_publication_datetime | nothing;
            end_time obj/public_version_expiration_datetime | nothing">
          <a href="tab_status"
            title="public version"
            tal:attributes="href obj_url;"
            tal:condition="python: public_status == 'published'"
            i18n:attributes="title">
            <tal:def
              define="
                global closeables python: 1;
                global expireables python:end_time and 1 or expireables"
              condition="start_time"
              replace="python: '%s%s' % (start_time, test(end_time, ' - %s' % end_time, ''))">
            </tal:def>
          </a>
          <tal:if condition="python: public_status == 'closed'">
            <span i18n:translate="">
              closed
            </span>
          </tal:if>
        </td>
      </tr>
    </tal:loop>
    <tal:block replace="nothing">
      ______________ if empty ______________
    </tal:block>
    <tr class="even"
      tal:condition="not: objects">
      <td colspan="6"
        i18n:translate="">
        There are no publishable items here.
      </td>
    </tr>
  </tbody>
  <tfoot tal:condition="may_change_content">
    <tr tal:condition="python: objects and (approveables or revokeables or rejectables or new_versionables)">
      <th class="listing-left"
        colspan="2">
        <tal:define define="select_id string:refs">
          <metal:use use-macro="here/macro_select_all/macros/select_all" />
        </tal:define>
      </th>
      <th class="align-right"
        colspan="6">
        <tal:if condition="python: approveables or ((closeables or revokeables or rejectables or republishables) and may_approve_content)">
          <tal:inline i18n:translate="">day / month / year &nbsp;(23:59)</tal:inline>
        </tal:if>
      </th>
    </tr>
    <tr class="inter-controls"
      tal:condition="
        python: approveables or ((revokeables or rejectables or new_versionables) and may_approve_content)">
      <tal:block replace="nothing">
        ______________ publication time controls ______________
      </tal:block>
      <td class="align-right"
        colspan="6">
        <label title="access key: alt-m"
          accesskey="m"
          i18n:attributes="title"
          i18n:translate=""
          >
          publish time
        </label>
        <tal:plug condition="redisplay_timing_form"
          replace="structure python: here.tab_status_form.publish_datetime.render_from_request(request)"
        />
        <tal:plug condition="not: redisplay_timing_form"
          replace="structure python: here.tab_status_form.publish_datetime.render()"
        />
        <tal:if condition="python: approveables or ((closeables or revokeables or rejectables or new_versionables) and may_approve_content)">
          &nbsp;
          <label title="access key: alt-x"
            accesskey="x"
            i18n:attributes="title"
            i18n:translate="">
            expiration time
          </label>
          <tal:plug condition="redisplay_timing_form"
            replace="structure python: here.tab_status_form.expiration_datetime.render_from_request(request)"
          />
          <tal:plug condition="not: redisplay_timing_form"
            replace="structure python: here.tab_status_form.expiration_datetime.render()"
          />
        </tal:if>
        <tal:if condition="python: may_approve_content and expireables">
          &nbsp;
          <label for="clear_expiration"
            title="access key: alt-o"
            accesskey="o"
            i18n:attributes="title"
            i18n:translate="">
            clear&nbsp;expiration
          </label>
          <field tal:replace="structure here/tab_status_form/clear_expiration/render" />
        </tal:if>
      </td>
    </tr>
    <tal:block replace="nothing">
      ______________ editor controls ______________
    </tal:block>
    <tr class="controls"
      tal:condition="may_approve_content">
        <td colspan="7">
        <input class="button executor"
          style="float:right"
          name="tab_status_open_now:method"
          value="publish"
          title="publish new versions: alt-p"
          accesskey="p"
          type="submit"
          onclick="return verifyChange(document.getElementById('publish-action-message').innerHTML)"
          i18n:attributes="value; title"
          tal:condition="python: approveables or rejectables or republishables"
        />
        <input class="button manipulator"
          style="float:right"
          name="tab_status_approve:method"
          type="submit"
          value="approve for future"
          title="approve new versions for publication at a later date: alt-o"
          accesskey="o"
          onclick="return verifyChange(document.getElementById('publish-action-message').innerHTML)"
          tal:condition="python: approveables or rejectables or republishables"
          i18n:attributes="value;title"
        />
        <input class="button"
          style="float:right"
          name="tab_status_change_settings:method"
          type="submit"
          value="update timing"
          title="change publish and expiration times: alt-u"
          accesskey="u"
          onclick="return verifyChange(document.getElementById('update-action-message').innerHTML)"
          tal:condition="python: approveables or closeables or revokeables or rejectables"
          i18n:attributes="value;title"
        />
        <metal:def define-macro="versioning_controls">
          <input class="button rejector"
            style="float:left"
            type="submit"
            name="tab_status_reject:method"
            value="reject"
            title="reject pending request for approval: alt-j"
            accesskey="j"
            onclick="return verifyChange(document.getElementById('reject-action-message').innerHTML)"
            tal:condition="rejectables"
            i18n:attributes="value;title"
          />
          <input class="button revoker"
            style="float:left"
            type="submit"
            name="tab_status_revoke:method"
            value="revoke"
            title="withdraw approval of approved versions: alt-v"
            accesskey="v"
            onclick="return verifyChange(document.getElementById('revoke-action-message').innerHTML)"
            tal:condition="revokeables"
            i18n:attributes="value;title"
          />
          <input class="button closer"
            style="float:left"
            type="submit"
            name="tab_status_close:method"
            value="close"
            title="close published items: alt-c"
            accesskey="c"
            onclick="return verifyChange(document.getElementById('close-action-message').innerHTML)"
            tal:condition="python:closeables and may_approve_content"
            i18n:attributes="value;title"
          />
          <input class="button"
            style="float:left"
            type="submit"
            name="tab_status_new_version:method"
            value="new version"
            title="create new versions of published docs: alt-n"
            accesskey="n"
            onclick="return verifyChange(document.getElementById('new-version-action-message').innerHTML)"
            tal:condition="new_versionables"
            i18n:attributes="value;title"
          />
        </metal:def>
      </td>
    </tr>
    <tr class="controls"
      tal:condition="not:may_approve_content">
      <tal:block replace="nothing">
        ______________ author controls ______________
      </tal:block>
      <td colspan="7">
        <input class="button executor"
          style="float:right"
          type="submit"
          name="tab_status_request_approval_now:method"
          value="request approval now"
          title="request immediate approval for new versions: alt-p"
          accesskey="r"
          tal:condition="approveables"
          i18n:attributes="value;title"
        />
        <input class="button"
          style="float:right"
          type="submit"
          name="tab_status_request_approval:method"
          value="request approval"
          title="request approval for new versions: alt-r"
          accesskey="r"
          tal:condition="approveables"
          i18n:attributes="value;title"
        />
        <input class="button"
          style="float:right"
          name="tab_status_change_settings:method"
          type="submit"
          value="update timing"
          title="change publish and expiration times: alt-s"
          accesskey="s"
          tal:condition="python: approveables"
          i18n:attributes="value;title"
        />
        <metal:use use-macro="here/tab_status/macros/versioning_controls">
          insert versioning controls
        </metal:use>
      </td>
    </tr>
  </tfoot>
</table>

      </td>
    </tr>
  </tbody>
</table>
</form>
</metal:fill>
</metal:use>
</html>



<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Safe Builtins &mdash; zope.security 4.0dev documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '4.0dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="zope.security 4.0dev documentation" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="index.html">zope.security 4.0dev documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="safe-builtins">
<h1>Safe Builtins<a class="headerlink" href="#safe-builtins" title="Permalink to this headline">¶</a></h1>
<p>When executing untrusted Python code, we need to make sure that we
only give the code access to safe, basic or proxied objects. This
included the builtin objects provided to Python code through a special
__builtins__ module in globals.  The <cite>builtins</cite> module provides a
suitable module object:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">zope.security.untrustedpython.builtins</span> <span class="kn">import</span> <span class="n">SafeBuiltins</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;__builtins__&#39;</span><span class="p">:</span> <span class="n">SafeBuiltins</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">exec</span> <span class="s">&#39;x = str(1)&#39;</span> <span class="ow">in</span> <span class="n">d</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">d</span><span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">]</span>
<span class="go">&#39;1&#39;</span>
</pre></div>
</div>
<p>The object is immutable:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">SafeBuiltins</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="mi">1</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">AttributeError</span>: <span class="n">foo</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">del</span> <span class="n">SafeBuiltins</span><span class="p">[</span><span class="s">&#39;getattr&#39;</span><span class="p">]</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">TypeError</span>: <span class="n">object does not support item deletion</span>



<span class="go">Exception raised:</span>
<span class="gp">...</span>
<span class="go">TypeError: object does not support item deletion</span>
</pre></div>
</div>
<dl class="docutils">
<dt>(Note that you can mutate it through its <cite>__dict__</cite> attribute,</dt>
<dd>however, when combined with the untrusted code compiler, getting the
<cite>__dict__</cite> attribute will return a proxied object that will prevent
mutation.)</dd>
</dl>
<p>It contains items with keys that are all strings and values that are
either proxied or are basic types:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">zope.security.proxy</span> <span class="kn">import</span> <span class="n">Proxy</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">SafeBuiltins</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">Proxy</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
<span class="gp">... </span>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
<p>It doesn&#8217;t contain unsafe items, such as eval, globals, etc:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">SafeBuiltins</span><span class="o">.</span><span class="n">eval</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">AttributeError</span>: <span class="n">&#39;ImmutableModule&#39; object has no attribute &#39;eval&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">SafeBuiltins</span><span class="o">.</span><span class="n">globals</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">AttributeError</span>: <span class="n">&#39;ImmutableModule&#39; object has no attribute &#39;globals&#39;</span>
</pre></div>
</div>
<p>The safe builtins also contains a custom __import__ function.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">imp</span> <span class="o">=</span> <span class="n">SafeBuiltins</span><span class="o">.</span><span class="n">__import__</span>
</pre></div>
</div>
<p>As with regular import, it only returns the top-level package if no
fromlist is specified:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">zope.security</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">imp</span><span class="p">(</span><span class="s">&#39;zope.security&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">zope</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">imp</span><span class="p">(</span><span class="s">&#39;zope.security&#39;</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="n">zope</span><span class="o">.</span><span class="n">security</span>
<span class="go">True</span>
</pre></div>
</div>
<p>Note that the values returned are proxied:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">imp</span><span class="p">(</span><span class="s">&#39;zope.security&#39;</span><span class="p">))</span> <span class="ow">is</span> <span class="n">Proxy</span>
<span class="go">True</span>
</pre></div>
</div>
<p>This means that, having imported a module, you will only be able to
access attributes for which you are authorized.</p>
<p>Unlike regular __import__, you can only import modules that have been
previously imported.  This is to prevent unauthorized execution of
module-initialization code:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">security</span> <span class="o">=</span> <span class="n">zope</span><span class="o">.</span><span class="n">security</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">sys</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s">&#39;zope.security&#39;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">imp</span><span class="p">(</span><span class="s">&#39;zope.security&#39;</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">ImportError</span>: <span class="n">zope.security</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s">&#39;zope.security&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">security</span>
</pre></div>
</div>
<p>Package-relative imports are supported (for now):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">imp</span><span class="p">(</span><span class="s">&#39;security&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;__name__&#39;</span><span class="p">:</span> <span class="s">&#39;zope&#39;</span><span class="p">,</span> <span class="s">&#39;__path__&#39;</span><span class="p">:</span> <span class="p">[]})</span> <span class="o">==</span> <span class="n">security</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">imp</span><span class="p">(</span><span class="s">&#39;security&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;__name__&#39;</span><span class="p">:</span> <span class="s">&#39;zope.foo&#39;</span><span class="p">})</span> <span class="o">==</span> <span class="n">zope</span><span class="o">.</span><span class="n">security</span>
<span class="go">True</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">imp</span><span class="p">(</span><span class="s">&#39;security.untrustedpython&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;__name__&#39;</span><span class="p">:</span> <span class="s">&#39;zope.foo&#39;</span><span class="p">})</span> <span class="o">==</span> <span class="n">security</span>
<span class="go">True</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">zope.security</span> <span class="kn">import</span> <span class="n">untrustedpython</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">imp</span><span class="p">(</span><span class="s">&#39;security.untrustedpython&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;__name__&#39;</span><span class="p">:</span> <span class="s">&#39;zope.foo&#39;</span><span class="p">},</span> <span class="p">{},</span> <span class="p">[</span><span class="s">&#39;*&#39;</span><span class="p">]</span>
<span class="gp">... </span>    <span class="p">)</span> <span class="o">==</span> <span class="n">untrustedpython</span>
<span class="go">True</span>
</pre></div>
</div>
</div>
<div class="section" id="untrusted-python-interpreter">
<h1>Untrusted Python interpreter<a class="headerlink" href="#untrusted-python-interpreter" title="Permalink to this headline">¶</a></h1>
<p>The interpreter module provides very basic Python interpreter
support.  It combined untrusted code compilation with safe builtins
and an exec-like API.  The exec_src function can be used to execute
Python source:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">zope.security.untrustedpython.interpreter</span> <span class="kn">import</span> <span class="n">exec_src</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">exec_src</span><span class="p">(</span><span class="s">&quot;x=1&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">d</span><span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">]</span>
<span class="go">1</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">exec_src</span><span class="p">(</span><span class="s">&quot;x=getattr&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that the safe builtins dictionary is inserted into the
dictionary:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">zope.security.untrustedpython.builtins</span> <span class="kn">import</span> <span class="n">SafeBuiltins</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">d</span><span class="p">[</span><span class="s">&#39;__builtins__&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">SafeBuiltins</span>
<span class="go">True</span>
</pre></div>
</div>
<p>All of the non-basic items in the safe builtins are proxied:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">exec_src</span><span class="p">(</span><span class="s">&#39;str=str&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">zope.security.proxy</span> <span class="kn">import</span> <span class="n">Proxy</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;str&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="n">Proxy</span>
<span class="go">True</span>
</pre></div>
</div>
<p>Note that, while you can get to the safe <cite>__builtins__</cite>&#8216;s dictionary,
you can&#8217;t use the dictionary to mutate it:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">zope.security.interfaces</span> <span class="kn">import</span> <span class="n">ForbiddenAttribute</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">try</span><span class="p">:</span> <span class="n">exec_src</span><span class="p">(</span><span class="s">&#39;__builtins__.__dict__[&quot;x&quot;] = 1&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
<span class="gp">... </span><span class="k">except</span> <span class="n">ForbiddenAttribute</span><span class="p">:</span> <span class="k">print</span> <span class="s">&#39;Forbidden!&#39;</span>
<span class="go">Forbidden!</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">try</span><span class="p">:</span> <span class="n">exec_src</span><span class="p">(</span><span class="s">&#39;del __builtins__.__dict__[&quot;str&quot;]&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
<span class="gp">... </span><span class="k">except</span> <span class="n">ForbiddenAttribute</span><span class="p">:</span> <span class="k">print</span> <span class="s">&#39;Forbidden!&#39;</span>
<span class="go">Forbidden!</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">try</span><span class="p">:</span> <span class="n">exec_src</span><span class="p">(</span><span class="s">&#39;__builtins__.__dict__.update({&quot;x&quot;: 1})&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
<span class="gp">... </span><span class="k">except</span> <span class="n">ForbiddenAttribute</span><span class="p">:</span> <span class="k">print</span> <span class="s">&#39;Forbidden!&#39;</span>
<span class="go">Forbidden!</span>
</pre></div>
</div>
<p>Because the untrusted code compiler is used, you can&#8217;t use exec,
raise, or try/except statements:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">exec_src</span><span class="p">(</span><span class="s">&quot;exec &#39;x=1&#39;&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">SyntaxError</span>: <span class="n">Line 1: exec statements are not supported</span>
</pre></div>
</div>
<p>Any attribute-access results will be proxied:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">exec_src</span><span class="p">(</span><span class="s">&quot;data = {}</span><span class="se">\n</span><span class="s">update = data.update</span><span class="se">\n</span><span class="s">update({&#39;x&#39;: &#39;y&#39;})&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;update&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="n">Proxy</span>
<span class="go">True</span>
</pre></div>
</div>
<p>In this case, we were able to get to and use the update method because
the data dictionary itself was created by the untrusted code and was,
thus, unproxied.</p>
<p>You can compile code yourself and call exec_code instead:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">zope.security.untrustedpython.rcompile</span> <span class="kn">import</span> <span class="nb">compile</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="s">&#39;x=2&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;mycode&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;exec&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">zope.security.untrustedpython.interpreter</span> <span class="kn">import</span> <span class="n">exec_code</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">exec_code</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">d</span><span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">]</span>
<span class="go">2</span>
</pre></div>
</div>
<p>This is useful if you are going to be executing the same expression
many times, as you can avoid the cost of repeated comilation.</p>
<div class="section" id="compiled-programs">
<h2>Compiled Programs<a class="headerlink" href="#compiled-programs" title="Permalink to this headline">¶</a></h2>
<p>A slightly higher-level interface is provided by compiled programs.
These make it easier to safetly safe the results of compilation:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">zope.security.untrustedpython.interpreter</span> <span class="kn">import</span> <span class="n">CompiledProgram</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">CompiledProgram</span><span class="p">(</span><span class="s">&#39;x=2&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">exec_</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">d</span><span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">]</span>
<span class="go">2</span>
</pre></div>
</div>
<p>When you execute a compiled program, you can supply an object with a
write method to get print output:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">CompiledProgram</span><span class="p">(</span><span class="s">&#39;print &quot;Hello world!&quot;&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">cStringIO</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="n">cStringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">exec_</span><span class="p">({},</span> <span class="n">output</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
<span class="go">&#39;Hello world!\n&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="compiled-expressions">
<h2>Compiled Expressions<a class="headerlink" href="#compiled-expressions" title="Permalink to this headline">¶</a></h2>
<p>You can also precompile expressions:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">zope.security.untrustedpython.interpreter</span> <span class="kn">import</span> <span class="n">CompiledExpression</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">CompiledExpression</span><span class="p">(</span><span class="s">&#39;x*2&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">eval</span><span class="p">({</span><span class="s">&#39;x&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
<span class="go">4</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="support-for-restricted-python-code">
<h1>Support for Restricted Python Code<a class="headerlink" href="#support-for-restricted-python-code" title="Permalink to this headline">¶</a></h1>
<p>This package provides a way to compile
untrusted Python code so that it can be executed safely.</p>
<p>This form of restricted Python assumes that security proxies will be
used to protect assets.  Given this, the only thing that actually
needs to be done differently by the generated code is to:</p>
<ul class="simple">
<li>Ensure that all attribute lookups go through a safe version of the getattr()
function that&#8217;s been provided in the built-in functions used in the
execution environment.</li>
<li>Prevent exec statements. (Later, we could possibly make exec safe.)</li>
<li>Print statements always go to an output that is provided as a
global, rather than having an implicit sys.output.</li>
<li>Prevent try/except and raise statements. This is mainly because they
don&#8217;t work properly in the presense of security proxies.  Try/except
statements will be made to work in the future.</li>
</ul>
<p>No other special treatment is needed to support safe expression
evaluation.</p>
<p>The implementation makes use of the <cite>RestrictedPython</cite> package,
originally written for Zope 2.  There is a new AST re-writer in
<cite>zope.security.untrustedpython.rcompile</cite> which performs the
tree-transformation, and a top-level <cite>compile()</cite> function in
<cite>zope.security.untrustedpython.rcompile</cite>; the later is what client
applications are expected to use.</p>
<p>The signature of the <cite>compile()</cite> function is very similar to that of
Python&#8217;s built-in <cite>compile()</cite> function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nb">compile</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
</pre></div>
</div>
<p>Using it is equally simple:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">zope.security.untrustedpython.rcompile</span> <span class="kn">import</span> <span class="nb">compile</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="s">&quot;21 * 2&quot;</span><span class="p">,</span> <span class="s">&quot;&lt;string&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;eval&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">eval</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<span class="go">42</span>
</pre></div>
</div>
<p>What&#8217;s interesting about the restricted code is that all attribute
lookups go through the <cite>getattr()</cite> function.  This is generally
provided as a built-in function in the restricted environment:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">mygetattr</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&quot;Yahoo!&quot;</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">marker</span> <span class="o">=</span> <span class="p">[]</span>
<span class="gp">... </span>    <span class="k">print</span> <span class="s">&quot;Looking up&quot;</span><span class="p">,</span> <span class="n">name</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">marker</span><span class="p">)</span> <span class="ow">is</span> <span class="n">marker</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">default</span>
<span class="gp">... </span>    <span class="k">else</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="s">&quot;Yeehaw!&quot;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">__builtin__</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">builtins</span> <span class="o">=</span> <span class="n">__builtin__</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">builtins</span><span class="p">[</span><span class="s">&quot;getattr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mygetattr</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">reval</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s">&quot;README.txt&quot;</span><span class="p">,</span> <span class="s">&quot;eval&quot;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="nb">globals</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;__builtins__&quot;</span><span class="p">:</span> <span class="n">builtins</span><span class="p">}</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="p">{})</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">reval</span><span class="p">(</span><span class="s">&quot;(42).__class__&quot;</span><span class="p">)</span>
<span class="go">Looking up __class__</span>
<span class="go">&#39;Yeehaw!&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">reval</span><span class="p">(</span><span class="s">&quot;(42).not_really_there&quot;</span><span class="p">)</span>
<span class="go">Looking up not_really_there</span>
<span class="go">&#39;Yahoo!&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">reval</span><span class="p">(</span><span class="s">&quot;(42).foo.not_really_there&quot;</span><span class="p">)</span>
<span class="go">Looking up foo</span>
<span class="go">Looking up not_really_there</span>
<span class="go">&#39;Yahoo!&#39;</span>
</pre></div>
</div>
<p>This allows a <cite>getattr()</cite> to be used that ensures the result of
evaluation is a security proxy.</p>
<p>To compile code with statements, use exec or single:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">exec</span> <span class="nb">compile</span><span class="p">(</span><span class="s">&quot;x = 1&quot;</span><span class="p">,</span> <span class="s">&quot;&lt;string&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;exec&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span>
<span class="go">1</span>
</pre></div>
</div>
<p>Trying to compile exec, raise or try/except sattements gives
syntax errors:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="nb">compile</span><span class="p">(</span><span class="s">&quot;exec &#39;x = 2&#39;&quot;</span><span class="p">,</span> <span class="s">&quot;&lt;string&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;exec&quot;</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">SyntaxError</span>: <span class="n">Line 1: exec statements are not supported</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">compile</span><span class="p">(</span><span class="s">&quot;raise KeyError(&#39;x&#39;)&quot;</span><span class="p">,</span> <span class="s">&quot;&lt;string&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;exec&quot;</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">SyntaxError</span>: <span class="n">Line 1: raise statements are not supported</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">compile</span><span class="p">(</span><span class="s">&quot;try: pass</span><span class="se">\n</span><span class="s">except: pass&quot;</span><span class="p">,</span> <span class="s">&quot;&lt;string&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;exec&quot;</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">SyntaxError</span>: <span class="n">Line 1: try/except statements are not supported</span>
</pre></div>
</div>
<p>Printing to an explicit writable is allowed:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">StringIO</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="s">&quot;print &gt;&gt; f, &#39;hi&#39;,</span><span class="se">\n</span><span class="s">print &gt;&gt; f, &#39;world&#39;&quot;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;exec&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">exec</span> <span class="n">code</span> <span class="ow">in</span> <span class="p">{</span><span class="s">&#39;f&#39;</span><span class="p">:</span> <span class="n">f</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
<span class="go">&#39;hi world\n&#39;</span>
</pre></div>
</div>
<p>But if no output is specified, then output will be send to
<cite>untrusted_output</cite>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="s">&quot;print &#39;hi&#39;,</span><span class="se">\n</span><span class="s">print &#39;world&#39;&quot;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;exec&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">exec</span> <span class="n">code</span> <span class="ow">in</span> <span class="p">{}</span>
<span class="gt">Traceback (most recent call last):</span>
<span class="c">...</span>
<span class="gr">NameError</span>: <span class="n">name &#39;untrusted_output&#39; is not defined</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">exec</span> <span class="n">code</span> <span class="ow">in</span> <span class="p">{</span><span class="s">&#39;untrusted_output&#39;</span><span class="p">:</span> <span class="n">f</span><span class="p">}</span>
</pre></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Safe Builtins</a></li>
<li><a class="reference internal" href="#untrusted-python-interpreter">Untrusted Python interpreter</a><ul>
<li><a class="reference internal" href="#compiled-programs">Compiled Programs</a></li>
<li><a class="reference internal" href="#compiled-expressions">Compiled Expressions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#support-for-restricted-python-code">Support for Restricted Python Code</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/untrusted.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="index.html">zope.security 4.0dev documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Zope Foundation Contributors &lt;zope-dev@zope.org&gt;.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>
<html xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="bastionledger">

  <metal:border fill-slot="top_slot">
    <tal:border define="dummy python:request.set('enable_border',1)" />
  </metal:border>
 
<body>
  <div metal:fill-slot="main"
       tal:define="effective python: modules['Products.BastionLedger.utils'].ceiling_date(request.get('date', DateTime()));
                   utool context/@@plone_portal_state/portal_url;
                   voting_classes context/votingClasses;
                   voters context/getMemberIds;
                   allocations python: context.allocationValues(effective=effective);
                   sharedefs python: context.shareDefinitionValues(effective)">

      <h1><img src="" alt="" tal:define="icon python:context.getIcon(1)" 
               tal:attributes="src string:${utool}/${icon}">&nbsp;<span tal:replace="context/Title | context/getId"/> 
          Share Allocations as at <span tal:replace="python: effective.strftime('%Y/%m/%d')"/></h1>

      <form action="" name="date_form" id="date_form" method="post" tal:attributes="action template/getId"
            tal:define="inputvalue python: modules['Products.BastionLedger.utils'].floor_date(effective);
                        formname string:date_form;
                        show_hm python: False;
                        inputname string:date;">

             <div class="reviewHistory">
                <dl id="viewing" class="collapsible inline collapsedOnLoad">
                    <dt class="collapsibleHeader">Filter</dt>
                    <dd class="collapsibleContent" tal:define="accno query/accno | python:[]">
                         <div class="label">As At</div>
                         <div metal:use-macro="here/calendar_macros/macros/calendarDatePickerBox"/>
                         <div>
                             <input class="context" type="submit" name="form.button.Filter" value=" Go "/>
                         </div>
                         <br/>
                    </dd>
                </dl>
             </div>
         
      <table summary="" width="100%" tal:condition="allocations">
         <tr class="row">
             <td class="field">&nbsp;</td>
             <td class="field"></td>
             <td class="field"><label>Share</label></td>
             <td class="field"><label>Issued</label></td>
             <td class="field" align="right"><label>Face</label></td>
             <td class="field" align="right"><label>Quantity</label></td>
             <td class="field" align="right"><label>Nominal Value</label></td>
             <td class="field" align="right"><label>Outstanding</label></td>
         </tr>
         <tr class="row" tal:repeat="allocation allocations">
             <tal:block tal:define="defn allocation/getDefinition">
                <td class="field">
                    <img src=""  alt="Allocation" tal:define="icon python:allocation.getIcon(1)" 
                                 tal:attributes="src string:${utool}/${icon}">
                </td>
                <td class="field">
                    <a href="" tal:attributes="href allocation/absolute_url"
                               tal:content="allocation/Title"/>
                </td>
                <td class="field">
                    <a href="" tal:attributes="href defn/absolute_url"
                               tal:content="defn/title_or_id"/>
                </td>
                <td class="field" tal:content="python: allocation.issue_date.strftime('%Y/%m/%d')"/>
                <td class="field" align="right" tal:content="defn/face"/>
                <td class="field" align="right" tal:content="allocation/quantity"/>
                <td class="field" align="right" tal:content="allocation/nominal"/>
                <td class="field" align="right" tal:content="allocation/outstanding"/>
             </tal:block>
         </tr>
         <tr>
             <td colspan="8">
                <div tal:define="error errors/email|nothing;
                                 Email request/email | python: getattr(context.aq_inner, 'email', '')"
                     tal:attributes="class python:error and 'field error' or 'field'">

                    <div tal:content="error">Validation error output</div>

		    <select name="share">
                        <option tal:repeat="sharedef sharedefs"
                                tal:content="sharedef/Title"
                                tal:attributes="value sharedef/getId"/>
                    </select>

                    <input type="text" name="email" size="30" value=""
                           tal:attributes="value Email"/>

                    <input class="context"
                           type="submit"
                           name="form.button.EmailCert"
                           value="Email Certificate"
                           i18n:attributes="value" />

                 </div>
             </td>
         </tr>
      </table>
      
      <p tal:condition="not: allocations" class="formHelp">Shares are yet to be allocated to this
              shareholder.</p>

      <fieldset tal:condition="voting_classes">
           <legend>Voting Rights</legend>

           <tal:voters tal:condition="voters">
                <p class="formHelp">Shows which member(s) hold any voting rights associated with this stock</p>

                <table summary="" tal:on-error="string:">
                    <tal:voters tal:repeat="voter voters">
                       <tr tal:repeat="votes python: context.votesForVoter(voting_classes, voter,effective=effective)">
                          <td><img src="" tal:attributes="src string:${utool}/user.png" alt="member"/></td>
                          <td><a href="" tal:attributes="href string:${utool}/authors/${voter}" tal:content="voter"/></td>
                          <td tal:content="votes"/>
                       </tr>
                    </tal:voters>
                </table>

                <br/>
                <br/>
           </tal:voters>

           <p class="formHelp">Votes by class for this shareholder</p>

           <table summary="">
                <tr tal:repeat="vc voting_classes">
                    <td><div class="label" tal:content="vc"/></td>
                    <td align="right"
                        tal:on-error="string:"
                        tal:content="python: context.votesForAccount(vc, context.getId(), effective)"/>
                </tr>
           </table>
  
      </fieldset>

      <input type="hidden" name="form.submitted" value="1" />

     </form>

      <div tal:replace="structure provider:plone.belowcontentbody">
           Document actions (print, sendto etc)
      </div>

  </div>
 
</body>
</html>

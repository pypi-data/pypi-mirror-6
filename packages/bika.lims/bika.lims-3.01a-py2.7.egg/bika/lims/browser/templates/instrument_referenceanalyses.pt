<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:tal="http://xml.zope.org/namespaces/tal"
    xmlns:metal="http://xml.zope.org/namespaces/metal"
    xmlns:i18n="http://xml.zope.org/namespaces/i18n"
    metal:use-macro="here/main_template/macros/master"
    i18n:domain="bika">

<metal:slot fill-slot="head_slot">
    <style>
        #chart { text-align:center; white-space:nowrap; overflow:auto;height:300px;}
        .chart-options {
            background: none repeat scroll 0 0 #EFEFEF;
            border: 1px solid #DEDEDE;
            border-radius: 5px 5px 5px 5px;
            margin: 10px 0;
            padding: 10px 15px;
        }
        .domain {
          fill: none;
          stroke: #3d3d3d;
          stroke-width: 1.5;
        }
        tr.selected td {
            font-weight:bold;
        }
        div.bika-listing-table-container {
            display:none;
        }
    </style>
    <script>
        jQuery(function($){
            $(document).ready(function(){

                // Populate analyses selector
                var data = $.parseJSON($('#graphdata').val());
                var qcrec = false;
                $.map(data, function(value,key){
                    $('#selanalyses').append('<option value="'+key+'">'+key+'</option>');
                    if (qcrec == false) {
                        $.map(value, function(v, k) {
                            $('#selqcsample').append('<option value="'+k+'">'+k+'</option>');
                        });
                        qcrec = true;
                    }
                });

                // Draw the chart and filter rows
                filterRows();
                drawControlChart();

                $('#selanalyses').change(function(e) {
                    drawControlChart();
                    filterRows();
                });

                $('#selqcsample').change(function(e) {
                    drawControlChart();
                    filterRows();
                });

                $('#interpolation').change(function(e) {
                    drawControlChart();
                });

                $('.item-listing-tbody tr').mouseover(function(e) {
                    if ($(this).attr('uid') != '') {
                        $(this).addClass('selected');
                        var uid = $(this).attr('uid');
                        $('#chart svg g circle#'+uid).trigger('__onmouseover');
                    }
                });
                $('.item-listing-tbody tr').mouseout(function(e) {
                    $(this).removeClass('selected');
                    if ($(this).attr('uid') != '') {
                        var uid = $(this).attr('uid');
                        $('#chart svg g circle#'+uid).trigger('__onmouseout');
                    }
                });

                $('div.bika-listing-table-container').fadeIn();
            });
        });

        function filterRows() {
            var ankeyword = $('#selanalyses').val().split("(");
            ankeyword = ankeyword[ankeyword.length-1].slice(0,-1).trim();
            var idqc = $('#selqcsample').val();
            var count = 0;
            $('div.results-info').remove();
            $('.item-listing-tbody tr').each(function( index ) {
                if ($(this).attr('keyword') != ankeyword
                    || $(this).find('td.Partition a').html() != idqc) {
                    $(this).hide();
                } else {
                    $(this).fadeIn();
                    count+=1;
                }
            });
            $('.bika-listing-table').closest('div').before('<div class="results-info">'+count+' results found</div>');
        }

        function drawControlChart() {
            var analysiskey = $('#selanalyses').val();
            var reftype = $('#selqcsample').val();
            var interpolation = $('#interpolation').val()
            if ($("#chart svg").length > 0) {
                $("#chart").css('height', $("#chart").innerHeight());
                $("#chart").css('width', $("#chart").innerWidth());
            }
            $("#chart").html("");
            $("#chart").show();
            var data = $.parseJSON($('#graphdata').val());
            data = data[analysiskey]
            if (!(reftype in data) || data[reftype].length == 0) {
                // There is no results for this type of refsample
                $("#chart").hide();
                return;
            }
            data = data[reftype];
            var unit = data[data.length-1]['unit'];
            var upper = data[data.length-1]['upper'];
            var lower = data[data.length-1]['lower'];
            var target = data[data.length-1]['target'];
            var ylabel = "Result";
            if (unit == '' || typeof unit == 'undefined') {
                unit = "";
            } else {
                ylabel = unit;
            }

            var uppertxt = $.trim("UCL (" + upper+""+unit+")");
            var lowertxt = $.trim("LCL (" + lower+""+unit+")");
            var centrtxt = $.trim("CL ("+target+""+unit+")");
            chart = new ControlChart();
            chart.setData(data);
            chart.setInterpolation(interpolation);
            chart.setXColumn('date');
            chart.setYColumn('result');
            chart.setPointId('id');
            chart.setYLabel(ylabel);
            chart.setXLabel('Date');
            chart.setUpperLimitText(uppertxt);
            chart.setLowerLimitText(lowertxt);
            chart.setCenterLimitText(centrtxt);
            chart.setCenterLimit(target);
            chart.setUpperLimit(upper);
            chart.setLowerLimit(lower);
            chart.draw('#chart');
        }
    </script>
</metal:slot>

<body>
    <metal:content-title fill-slot="content-title">
    <h1>
        <img tal:condition="view/icon | nothing"
             src="" tal:attributes="src view/icon"/>
        <span class="documentFirstHeading"
              tal:content="context/title"></span>
    </h1>
    <h2 tal:content="view/title"></h2>
    </metal:content-title>

    <metal:content-description fill-slot="content-description">
    </metal:content-description>

    <metal:content-core fill-slot="content-core">

    <!-- Chart container -->
    <div class='chart-container'>
        <div class='chart-options'>
            <label for='selanalyses'>Analysis</label>
            <select id='selanalyses' name='selanalyses'>
            </select>&nbsp;&nbsp;
            <label for='selqcsample'>Reference Sample</label>
            <select id='selqcsample' name='selqcsample'>
            </select>&nbsp;&nbsp;
            <label for='interpolation'>Interpolation</label>
            <select id='interpolation' name='interpolation'>
                <option value='basis' selected>Basis</option>
                <option value='cardinal'>Cardinal</option>
                <option value='linear'>Linear</option>
            </select>
        </div>
        <div id='chart'></div>
    </div>

    <!-- Reference Analyses table -->
    <tal:analysestable>
    <tal:parts replace="structure view/get_analyses_table"/>
    <input type="hidden" id='graphdata' tal:attributes="value view/get_analyses_json"/>
    </tal:analysestable>

    </metal:content-core>
</body>
</html>



<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>zope.configuration.config &mdash; zope.configuration 4.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '4.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="zope.configuration 4.0 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">zope.configuration 4.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for zope.configuration.config</h1><div class="highlight"><pre>
<span class="c">##############################################################################</span>
<span class="c">#</span>
<span class="c"># Copyright (c) 2003 Zope Foundation and Contributors.</span>
<span class="c"># All Rights Reserved.</span>
<span class="c">#</span>
<span class="c"># This software is subject to the provisions of the Zope Public License,</span>
<span class="c"># Version 2.1 (ZPL).  A copy of the ZPL should accompany this distribution.</span>
<span class="c"># THIS SOFTWARE IS PROVIDED &quot;AS IS&quot; AND ANY AND ALL EXPRESS OR IMPLIED</span>
<span class="c"># WARRANTIES ARE DISCLAIMED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span>
<span class="c"># WARRANTIES OF TITLE, MERCHANTABILITY, AGAINST INFRINGEMENT, AND FITNESS</span>
<span class="c"># FOR A PARTICULAR PURPOSE.</span>
<span class="c">#</span>
<span class="c">##############################################################################</span>
<span class="sd">&quot;&quot;&quot;Configuration processor</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">keyword</span> <span class="kn">import</span> <span class="n">iskeyword</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">zope.interface.adapter</span> <span class="kn">import</span> <span class="n">AdapterRegistry</span>
<span class="kn">from</span> <span class="nn">zope.interface</span> <span class="kn">import</span> <span class="n">Interface</span>
<span class="kn">from</span> <span class="nn">zope.interface</span> <span class="kn">import</span> <span class="n">implementer</span>
<span class="kn">from</span> <span class="nn">zope.interface</span> <span class="kn">import</span> <span class="n">providedBy</span>
<span class="kn">from</span> <span class="nn">zope.schema</span> <span class="kn">import</span> <span class="n">TextLine</span>
<span class="kn">from</span> <span class="nn">zope.schema</span> <span class="kn">import</span> <span class="n">URI</span>
<span class="kn">from</span> <span class="nn">zope.schema</span> <span class="kn">import</span> <span class="n">ValidationError</span>

<span class="kn">from</span> <span class="nn">zope.configuration.exceptions</span> <span class="kn">import</span> <span class="n">ConfigurationError</span>
<span class="kn">from</span> <span class="nn">zope.configuration.interfaces</span> <span class="kn">import</span> <span class="n">IConfigurationContext</span>
<span class="kn">from</span> <span class="nn">zope.configuration.interfaces</span> <span class="kn">import</span> <span class="n">IGroupingContext</span>
<span class="kn">from</span> <span class="nn">zope.configuration.fields</span> <span class="kn">import</span> <span class="n">GlobalInterface</span>
<span class="kn">from</span> <span class="nn">zope.configuration.fields</span> <span class="kn">import</span> <span class="n">GlobalObject</span>
<span class="kn">from</span> <span class="nn">zope.configuration._compat</span> <span class="kn">import</span> <span class="n">builtins</span>
<span class="kn">from</span> <span class="nn">zope.configuration._compat</span> <span class="kn">import</span> <span class="n">reraise</span>
<span class="kn">from</span> <span class="nn">zope.configuration._compat</span> <span class="kn">import</span> <span class="n">string_types</span>
<span class="kn">from</span> <span class="nn">zope.configuration._compat</span> <span class="kn">import</span> <span class="n">text_type</span>
<span class="kn">from</span> <span class="nn">zope.configuration._compat</span> <span class="kn">import</span> <span class="n">u</span>


<span class="n">zopens</span> <span class="o">=</span> <span class="s">&#39;http://namespaces.zope.org/zope&#39;</span>
<span class="n">metans</span> <span class="o">=</span> <span class="s">&#39;http://namespaces.zope.org/meta&#39;</span>
<span class="n">testns</span> <span class="o">=</span> <span class="s">&#39;http://namespaces.zope.org/test&#39;</span>

<span class="n">_import_chickens</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">(</span><span class="s">&quot;*&quot;</span><span class="p">,)</span> <span class="c"># dead chickens needed by __import__</span>


<div class="viewcode-block" id="ConfigurationContext"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.ConfigurationContext">[docs]</a><span class="k">class</span> <span class="nc">ConfigurationContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Mix-in that implements IConfigurationContext</span>

<span class="sd">    Subclasses provide a ``package`` attribute and a ``basepath``</span>
<span class="sd">    attribute.  If the base path is not None, relative paths are</span>
<span class="sd">    converted to absolute paths using the the base path. If the</span>
<span class="sd">    package is not none, relative imports are performed relative to</span>
<span class="sd">    the package.</span>

<span class="sd">    In general, the basepath and package attributes should be</span>
<span class="sd">    consistent. When a package is provided, the base path should be</span>
<span class="sd">    set to the path of the package directory.</span>

<span class="sd">    Subclasses also provide an ``actions`` attribute, which is a list</span>
<span class="sd">    of actions, an ``includepath`` attribute, and an ``info``</span>
<span class="sd">    attribute.</span>

<span class="sd">    The include path is appended to each action and is used when</span>
<span class="sd">    resolving conflicts among actions.  Normally, only the a</span>
<span class="sd">    ConfigurationMachine provides the actions attribute. Decorators</span>
<span class="sd">    simply use the actions of the context they decorate. The</span>
<span class="sd">    ``includepath`` attribute is a tuple of names.  Each name is</span>
<span class="sd">    typically the name of an included configuration file.</span>

<span class="sd">    The ``info`` attribute contains descriptive information helpful</span>
<span class="sd">    when reporting errors.  If not set, it defaults to an empty string.</span>

<span class="sd">    The actions attribute is a sequence of dictionaries where each dictionary</span>
<span class="sd">    has the following keys:</span>

<span class="sd">      - ``discriminator``, a value that identifies the action. Two actions</span>
<span class="sd">        that have the same (non None) discriminator conflict.</span>

<span class="sd">      - ``callable``, an object that is called to execute the action,</span>

<span class="sd">      - ``args``, positional arguments for the action</span>

<span class="sd">      - ``kw``, keyword arguments for the action</span>

<span class="sd">      - ``includepath``, a tuple of include file names (defaults to ())</span>

<span class="sd">      - ``info``, an object that has descriptive information about</span>
<span class="sd">        the action (defaults to &#39;&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ConfigurationContext</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seen_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_features</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<div class="viewcode-block" id="ConfigurationContext.resolve"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.ConfigurationContext.resolve">[docs]</a>    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dottedname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resolve a dotted name to an object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">dottedname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;The given name is blank&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">package</span>

        <span class="n">names</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">names</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s">&quot;Trailing dots are no longer supported in dotted names&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c"># Check for built-in objects</span>
            <span class="n">marker</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">builtins</span><span class="p">,</span> <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">marker</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">obj</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="c"># Got a relative name. Convert it to abs using package info</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">package</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                    <span class="s">&quot;Can&#39;t use leading dots in dotted names, &quot;</span>
                    <span class="s">&quot;no package has been set.&quot;</span><span class="p">)</span>
            <span class="n">pnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">__name__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span>
            <span class="n">pnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">names</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">names</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pnames</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s">&quot;Invalid global name&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnames</span>

        <span class="c"># Now we should have an absolute dotted name</span>

        <span class="c"># Split off object name:</span>
        <span class="n">oname</span><span class="p">,</span> <span class="n">mname</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c"># Import the module</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mname</span><span class="p">:</span>
            <span class="c"># Just got a single name. Must me a module</span>
            <span class="n">mname</span> <span class="o">=</span> <span class="n">oname</span>
            <span class="n">oname</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">mname</span><span class="p">,</span> <span class="o">*</span><span class="n">_import_chickens</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">tb_next</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># ImportError was caused deeper</span>
                <span class="k">raise</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s">&quot;ImportError: Couldn&#39;t import </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mname</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">oname</span><span class="p">:</span>
            <span class="c"># see not mname case above</span>
            <span class="k">return</span> <span class="n">mod</span>


        <span class="k">try</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">oname</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">obj</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c"># No such name, maybe it&#39;s a module that we still need to import</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">mname</span><span class="o">+</span><span class="s">&#39;.&#39;</span><span class="o">+</span><span class="n">oname</span><span class="p">,</span> <span class="o">*</span><span class="n">_import_chickens</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">tb_next</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c"># ImportError was caused deeper</span>
                    <span class="k">raise</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                    <span class="s">&quot;ImportError: Module </span><span class="si">%s</span><span class="s"> has no global </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mname</span><span class="p">,</span> <span class="n">oname</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ConfigurationContext.path"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.ConfigurationContext.path">[docs]</a>    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compute package-relative paths.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">filename</span>

        <span class="c"># Got a relative path, combine with base path.</span>
        <span class="c"># If we have no basepath, compute the base path from the package</span>
        <span class="c"># path.</span>
        <span class="n">basepath</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;basepath&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">basepath</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">package</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">basepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package</span><span class="p">,</span> <span class="s">&#39;__path__&#39;</span><span class="p">):</span>
                    <span class="n">basepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">__path__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">basepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package</span><span class="o">.</span><span class="n">__file__</span><span class="p">)</span>
                <span class="n">basepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">basepath</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">basepath</span> <span class="o">=</span> <span class="n">basepath</span>

        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basepath</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ConfigurationContext.checkDuplicate"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.ConfigurationContext.checkDuplicate">[docs]</a>    <span class="k">def</span> <span class="nf">checkDuplicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check for duplicate imports of the same file.</span>

<span class="sd">        Raises an exception if this file had been processed before.  This</span>
<span class="sd">        is better than an unlimited number of conflict errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seen_files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%r</span><span class="s"> included more than once&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seen_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ConfigurationContext.processFile"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.ConfigurationContext.processFile">[docs]</a>    <span class="k">def</span> <span class="nf">processFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check whether a file needs to be processed.</span>

<span class="sd">        Return True if processing is needed and False otherwise. If</span>
<span class="sd">        the file needs to be processed, it will be marked as</span>
<span class="sd">        processed, assuming that the caller will procces the file if</span>
<span class="sd">        it needs to be procssed.</span>
<span class="sd">        &quot;&quot;&quot;</span> <span class="c">#&#39; &lt;-- bow to font-lock</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seen_files</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seen_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="ConfigurationContext.action"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.ConfigurationContext.action">[docs]</a>    <span class="k">def</span> <span class="nf">action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discriminator</span><span class="p">,</span> <span class="nb">callable</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">kw</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
               <span class="n">includepath</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">info</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add an action with the given discriminator, callable and arguments.</span>

<span class="sd">        For testing purposes, the callable and arguments may be omitted.</span>
<span class="sd">        In that case, a default noop callable is used.</span>

<span class="sd">        The discriminator must be given, but it can be None, to indicate that</span>
<span class="sd">        the action never conflicts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kw</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">kw</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">action</span> <span class="o">=</span> <span class="n">extra</span>

        <span class="k">if</span> <span class="n">info</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">info</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;info&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">includepath</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">includepath</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;includepath&#39;</span><span class="p">,</span> <span class="p">())</span>
            
        <span class="n">action</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="n">discriminator</span><span class="o">=</span><span class="n">discriminator</span><span class="p">,</span>
                <span class="nb">callable</span><span class="o">=</span><span class="nb">callable</span><span class="p">,</span>
                <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                <span class="n">kw</span><span class="o">=</span><span class="n">kw</span><span class="p">,</span>
                <span class="n">includepath</span><span class="o">=</span><span class="n">includepath</span><span class="p">,</span>
                <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
                <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ConfigurationContext.hasFeature"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.ConfigurationContext.hasFeature">[docs]</a>    <span class="k">def</span> <span class="nf">hasFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check whether a named feature has been provided.</span>

<span class="sd">        Initially no features are provided</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features</span>
</div>
<div class="viewcode-block" id="ConfigurationContext.provideFeature"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.ConfigurationContext.provideFeature">[docs]</a>    <span class="k">def</span> <span class="nf">provideFeature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Declare thata named feature has been provided.</span>

<span class="sd">        See :meth:`hasFeature` for examples.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_features</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="ConfigurationAdapterRegistry"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.ConfigurationAdapterRegistry">[docs]</a><span class="k">class</span> <span class="nc">ConfigurationAdapterRegistry</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple adapter registry that manages directives as adapters</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ConfigurationAdapterRegistry</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># Stores tuples of form:</span>
        <span class="c">#   (namespace, name), schema, usedIn, info, parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_docRegistry</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interface</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">factory</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">AdapterRegistry</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>

        <span class="n">r</span><span class="o">.</span><span class="n">register</span><span class="p">([</span><span class="n">interface</span><span class="p">],</span> <span class="n">Interface</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">factory</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">usedIn</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_docRegistry</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">usedIn</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">parent</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">factory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># Try namespace-independent name</span>
            <span class="n">ns</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">name</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s">&quot;Unknown directive&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lookup1</span><span class="p">(</span><span class="n">providedBy</span><span class="p">(</span><span class="n">context</span><span class="p">),</span> <span class="n">Interface</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span>
                <span class="s">&quot;The directive </span><span class="si">%s</span><span class="s"> cannot be used in this context&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">))</span>
        <span class="k">return</span> <span class="n">f</span>
</div>
<span class="nd">@implementer</span><span class="p">(</span><span class="n">IConfigurationContext</span><span class="p">)</span>
<div class="viewcode-block" id="ConfigurationMachine"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.ConfigurationMachine">[docs]</a><span class="k">class</span> <span class="nc">ConfigurationMachine</span><span class="p">(</span><span class="n">ConfigurationAdapterRegistry</span><span class="p">,</span> <span class="n">ConfigurationContext</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Configuration machine</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">package</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">basepath</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">includepath</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">info</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ConfigurationMachine</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="n">RootStackItem</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i18n_strings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">_bootstrap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="ConfigurationMachine.begin"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.ConfigurationMachine.begin">[docs]</a>    <span class="k">def</span> <span class="nf">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__name</span><span class="p">,</span> <span class="n">__data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">__info</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">__data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kw</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Can&#39;t provide a mapping object and keyword &quot;</span>
                                <span class="s">&quot;arguments&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">__data</span> <span class="o">=</span> <span class="n">kw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">contained</span><span class="p">(</span><span class="n">__name</span><span class="p">,</span> <span class="n">__data</span><span class="p">,</span> <span class="n">__info</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="ConfigurationMachine.end"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.ConfigurationMachine.end">[docs]</a>    <span class="k">def</span> <span class="nf">end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ConfigurationMachine.__call__"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.ConfigurationMachine.__call__">[docs]</a>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__name</span><span class="p">,</span> <span class="n">__info</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">__kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">__name</span><span class="p">,</span> <span class="n">__kw</span><span class="p">,</span> <span class="n">__info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ConfigurationMachine.getInfo"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.ConfigurationMachine.getInfo">[docs]</a>    <span class="k">def</span> <span class="nf">getInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">info</span>
</div>
<div class="viewcode-block" id="ConfigurationMachine.setInfo"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.ConfigurationMachine.setInfo">[docs]</a>    <span class="k">def</span> <span class="nf">setInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>
</div>
<div class="viewcode-block" id="ConfigurationMachine.execute_actions"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.ConfigurationMachine.execute_actions">[docs]</a>    <span class="k">def</span> <span class="nf">execute_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">testing</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute the configuration actions.</span>

<span class="sd">        This calls the action callables after resolving conflicts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">resolveConflicts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">):</span>
                <span class="nb">callable</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="s">&#39;callable&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">callable</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="s">&#39;args&#39;</span><span class="p">]</span>
                <span class="n">kw</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="s">&#39;kw&#39;</span><span class="p">]</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="s">&#39;info&#39;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">callable</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span> <span class="c">#pragma NO COVER</span>
                    <span class="k">raise</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">testing</span><span class="p">:</span>
                        <span class="k">raise</span>
                    <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">reraise</span><span class="p">(</span><span class="n">ConfigurationExecutionError</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">info</span><span class="p">),</span>
                                <span class="bp">None</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
                    <span class="k">finally</span><span class="p">:</span>
                       <span class="k">del</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">tb</span>
                
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">clear</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[:]</span>
        </div></div>
<div class="viewcode-block" id="ConfigurationExecutionError"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.ConfigurationExecutionError">[docs]</a><span class="k">class</span> <span class="nc">ConfigurationExecutionError</span><span class="p">(</span><span class="n">ConfigurationError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An error occurred during execution of a configuration action</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">etype</span><span class="p">,</span> <span class="n">evalue</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">etype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">evalue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">etype</span><span class="p">,</span> <span class="n">evalue</span><span class="p">,</span> <span class="n">info</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c">#pragma NO COVER</span>
        <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="se">\n</span><span class="s">  in:</span><span class="se">\n</span><span class="s">  </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">etype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">evalue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>

<span class="c">##############################################################################</span>
<span class="c"># Stack items</span>
</div>
<div class="viewcode-block" id="IStackItem"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.IStackItem">[docs]</a><span class="k">class</span> <span class="nc">IStackItem</span><span class="p">(</span><span class="n">Interface</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Configuration machine stack items</span>

<span class="sd">    Stack items are created when a directive is being processed.</span>

<span class="sd">    A stack item is created for each directive use.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="IStackItem.contained"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.IStackItem.contained">[docs]</a>    <span class="k">def</span> <span class="nf">contained</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Begin processing a contained directive</span>

<span class="sd">        The data are a dictionary of attribute names mapped to unicode</span>
<span class="sd">        strings.</span>

<span class="sd">        The info argument is an object that can be converted to a</span>
<span class="sd">        string and that contains information about the directive.</span>

<span class="sd">        The begin method returns the next item to be placed on the stack.</span>
<span class="sd">        &quot;&quot;&quot;</span>
</div>
<div class="viewcode-block" id="IStackItem.finish"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.IStackItem.finish">[docs]</a>    <span class="k">def</span> <span class="nf">finish</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;Finish processing a directive</span>
<span class="sd">        &quot;&quot;&quot;</span>
</div></div>
<span class="nd">@implementer</span><span class="p">(</span><span class="n">IStackItem</span><span class="p">)</span>
<div class="viewcode-block" id="SimpleStackItem"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.SimpleStackItem">[docs]</a><span class="k">class</span> <span class="nc">SimpleStackItem</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple stack item</span>

<span class="sd">    A simple stack item can&#39;t have anything added after it.  It can</span>
<span class="sd">    only be removed.  It is used for simple directives and</span>
<span class="sd">    subdirectives, which can&#39;t contain other directives.</span>

<span class="sd">    It also defers any computation until the end of the directive</span>
<span class="sd">    has been reached.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#XXX why this *argdata hack instead of schema, data?</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">*</span><span class="n">argdata</span><span class="p">):</span>
        <span class="n">newcontext</span> <span class="o">=</span> <span class="n">GroupingContextDecorator</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="n">newcontext</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">newcontext</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">argdata</span> <span class="o">=</span> <span class="n">argdata</span>

    <span class="k">def</span> <span class="nf">contained</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s">&quot;Invalid directive </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># We&#39;re going to use the context that was passed to us, which wasn&#39;t</span>
        <span class="c"># created for the directive.  We want to set it&#39;s info to the one</span>
        <span class="c"># passed to us while we make the call, so we&#39;ll save the old one</span>
        <span class="c"># and restore it.</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">toargs</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">argdata</span><span class="p">)</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">actions</span><span class="p">:</span>
            <span class="c"># we allow the handler to return nothing</span>
            <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">action</span> <span class="o">=</span> <span class="n">expand_action</span><span class="p">(</span><span class="o">*</span><span class="n">action</span><span class="p">)</span> <span class="c"># b/c</span>
                <span class="n">context</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="o">**</span><span class="n">action</span><span class="p">)</span>
</div>
<span class="nd">@implementer</span><span class="p">(</span><span class="n">IStackItem</span><span class="p">)</span>
<div class="viewcode-block" id="RootStackItem"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.RootStackItem">[docs]</a><span class="k">class</span> <span class="nc">RootStackItem</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>

<div class="viewcode-block" id="RootStackItem.contained"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.RootStackItem.contained">[docs]</a>    <span class="k">def</span> <span class="nf">contained</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle a contained directive</span>

<span class="sd">        We have to compute a new stack item by getting a named adapter</span>
<span class="sd">        for the current context object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">factory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">factory</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s">&quot;Invalid directive&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">adapter</span> <span class="o">=</span> <span class="n">factory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">adapter</span>
</div>
    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</div>
<span class="nd">@implementer</span><span class="p">(</span><span class="n">IStackItem</span><span class="p">)</span>
<div class="viewcode-block" id="GroupingStackItem"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.GroupingStackItem">[docs]</a><span class="k">class</span> <span class="nc">GroupingStackItem</span><span class="p">(</span><span class="n">RootStackItem</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stack item for a grouping directive</span>

<span class="sd">    A grouping stack item is in the stack when a grouping directive is</span>
<span class="sd">    being processed.  Grouping directives group other directives.</span>
<span class="sd">    Often, they just manage common data, but they may also take</span>
<span class="sd">    actions, either before or after contained directives are executed.</span>

<span class="sd">    A grouping stack item is created with a grouping directive</span>
<span class="sd">    definition, a configuration context, and directive data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GroupingStackItem</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__callBefore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">before</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">actions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">action</span> <span class="o">=</span> <span class="n">expand_action</span><span class="p">(</span><span class="o">*</span><span class="n">action</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="o">**</span><span class="n">action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__callBefore</span> <span class="o">=</span> <span class="n">noop</span>

    <span class="k">def</span> <span class="nf">contained</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__callBefore</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">RootStackItem</span><span class="o">.</span><span class="n">contained</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__callBefore</span><span class="p">()</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">after</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">actions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">action</span> <span class="o">=</span> <span class="n">expand_action</span><span class="p">(</span><span class="o">*</span><span class="n">action</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="o">**</span><span class="n">action</span><span class="p">)</span>
</div>
<span class="k">def</span> <span class="nf">noop</span><span class="p">():</span>
    <span class="k">pass</span>


<span class="nd">@implementer</span><span class="p">(</span><span class="n">IStackItem</span><span class="p">)</span>
<div class="viewcode-block" id="ComplexStackItem"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.ComplexStackItem">[docs]</a><span class="k">class</span> <span class="nc">ComplexStackItem</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Complex stack item</span>

<span class="sd">    A complex stack item is in the stack when a complex directive is</span>
<span class="sd">    being processed.  It only allows subdirectives to be used.</span>

<span class="sd">    A complex stack item is created with a complex directive</span>
<span class="sd">    definition (IComplexDirectiveContext), a configuration context,</span>
<span class="sd">    and directive data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="n">newcontext</span> <span class="o">=</span> <span class="n">GroupingContextDecorator</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="n">newcontext</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">newcontext</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta</span> <span class="o">=</span> <span class="n">meta</span>

        <span class="c"># Call the handler contructor</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">toargs</span><span class="p">(</span><span class="n">newcontext</span><span class="p">,</span> <span class="n">meta</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="n">newcontext</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>

<div class="viewcode-block" id="ComplexStackItem.contained"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.ComplexStackItem.contained">[docs]</a>    <span class="k">def</span> <span class="nf">contained</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle a subdirective</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Look up the subdirective meta data on our meta object</span>
        <span class="n">ns</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s">&quot;Invalid directive&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c"># strip off info</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SimpleStackItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># when we&#39;re done, we call the handler, which might return more actions</span>
        <span class="c"># Need to save and restore old info</span>
        <span class="c"># XXX why not just use callable()?</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;__call__&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="c"># noncallable</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="c"># non callable</span>

        <span class="k">if</span> <span class="n">actions</span><span class="p">:</span>
            <span class="c"># we allow the handler to return nothing</span>
            <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">action</span> <span class="o">=</span> <span class="n">expand_action</span><span class="p">(</span><span class="o">*</span><span class="n">action</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="o">**</span><span class="n">action</span><span class="p">)</span>


<span class="c">##############################################################################</span>
<span class="c"># Helper classes</span>
</div>
<span class="nd">@implementer</span><span class="p">(</span><span class="n">IConfigurationContext</span><span class="p">,</span> <span class="n">IGroupingContext</span><span class="p">)</span>
<div class="viewcode-block" id="GroupingContextDecorator"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.GroupingContextDecorator">[docs]</a><span class="k">class</span> <span class="nc">GroupingContextDecorator</span><span class="p">(</span><span class="n">ConfigurationContext</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper mix-in class for building grouping directives</span>

<span class="sd">    See the discussion (and test) in GroupingStackItem.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                    <span class="nb">getattr</span><span class="o">=</span><span class="nb">getattr</span><span class="p">,</span> <span class="nb">setattr</span><span class="o">=</span><span class="nb">setattr</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="c"># cache result in self</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">before</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">after</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<span class="c">##############################################################################</span>
<span class="c"># Directive-definition</span>
</div>
<div class="viewcode-block" id="DirectiveSchema"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.DirectiveSchema">[docs]</a><span class="k">class</span> <span class="nc">DirectiveSchema</span><span class="p">(</span><span class="n">GlobalInterface</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A field that contains a global variable value that must be a schema</span>
<span class="sd">    &quot;&quot;&quot;</span>
</div>
<div class="viewcode-block" id="IDirectivesInfo"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.IDirectivesInfo">[docs]</a><span class="k">class</span> <span class="nc">IDirectivesInfo</span><span class="p">(</span><span class="n">Interface</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Schema for the ``directives`` directive</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">namespace</span> <span class="o">=</span> <span class="n">URI</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="n">u</span><span class="p">(</span><span class="s">&quot;Namespace&quot;</span><span class="p">),</span>
        <span class="n">description</span><span class="o">=</span><span class="n">u</span><span class="p">(</span><span class="s">&quot;The namespace in which directives&#39; names &quot;</span>
                      <span class="s">&quot;will be defined&quot;</span><span class="p">),</span>
        <span class="p">)</span>

</div>
<div class="viewcode-block" id="IDirectivesContext"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.IDirectivesContext">[docs]</a><span class="k">class</span> <span class="nc">IDirectivesContext</span><span class="p">(</span><span class="n">IDirectivesInfo</span><span class="p">,</span> <span class="n">IConfigurationContext</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<span class="nd">@implementer</span><span class="p">(</span><span class="n">IDirectivesContext</span><span class="p">)</span>
<div class="viewcode-block" id="DirectivesHandler"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.DirectivesHandler">[docs]</a><span class="k">class</span> <span class="nc">DirectivesHandler</span><span class="p">(</span><span class="n">GroupingContextDecorator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handler for the directives directive</span>

<span class="sd">    This is just a grouping directive that adds a namespace attribute</span>
<span class="sd">    to the normal directive context.</span>

<span class="sd">    &quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="IDirectiveInfo"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.IDirectiveInfo">[docs]</a><span class="k">class</span> <span class="nc">IDirectiveInfo</span><span class="p">(</span><span class="n">Interface</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Information common to all directive definitions have</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">TextLine</span><span class="p">(</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">u</span><span class="p">(</span><span class="s">&quot;Directive name&quot;</span><span class="p">),</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">u</span><span class="p">(</span><span class="s">&quot;The name of the directive being defined&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="n">schema</span> <span class="o">=</span> <span class="n">DirectiveSchema</span><span class="p">(</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">u</span><span class="p">(</span><span class="s">&quot;Directive handler&quot;</span><span class="p">),</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">u</span><span class="p">(</span><span class="s">&quot;The dotted name of the directive handler&quot;</span><span class="p">),</span>
        <span class="p">)</span>
</div>
<div class="viewcode-block" id="IFullInfo"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.IFullInfo">[docs]</a><span class="k">class</span> <span class="nc">IFullInfo</span><span class="p">(</span><span class="n">IDirectiveInfo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Information that all top-level directives (not subdirectives) have</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">handler</span> <span class="o">=</span> <span class="n">GlobalObject</span><span class="p">(</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">u</span><span class="p">(</span><span class="s">&quot;Directive handler&quot;</span><span class="p">),</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">u</span><span class="p">(</span><span class="s">&quot;The dotted name of the directive handler&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="n">usedIn</span> <span class="o">=</span> <span class="n">GlobalInterface</span><span class="p">(</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">u</span><span class="p">(</span><span class="s">&quot;The directive types the directive can be used in&quot;</span><span class="p">),</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">u</span><span class="p">(</span><span class="s">&quot;The interface of the directives that can contain &quot;</span>
                        <span class="s">&quot;the directive&quot;</span>
                       <span class="p">),</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">IConfigurationContext</span><span class="p">,</span>
        <span class="p">)</span>
</div>
<div class="viewcode-block" id="IStandaloneDirectiveInfo"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.IStandaloneDirectiveInfo">[docs]</a><span class="k">class</span> <span class="nc">IStandaloneDirectiveInfo</span><span class="p">(</span><span class="n">IDirectivesInfo</span><span class="p">,</span> <span class="n">IFullInfo</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Info for full directives defined outside a directives directives</span>
<span class="sd">    &quot;&quot;&quot;</span>
</div>
<div class="viewcode-block" id="defineSimpleDirective"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.defineSimpleDirective">[docs]</a><span class="k">def</span> <span class="nf">defineSimpleDirective</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span>
                          <span class="n">namespace</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">usedIn</span><span class="o">=</span><span class="n">IConfigurationContext</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Define a simple directive</span>

<span class="sd">    Define and register a factory that invokes the simple directive</span>
<span class="sd">    and returns a new stack item, which is always the same simple stack item.</span>

<span class="sd">    If the namespace is &#39;*&#39;, the directive is registered for all namespaces.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="n">namespace</span> <span class="ow">or</span> <span class="n">context</span><span class="o">.</span><span class="n">namespace</span>
    <span class="k">if</span> <span class="n">namespace</span> <span class="o">!=</span> <span class="s">&#39;*&#39;</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">factory</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SimpleStackItem</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">factory</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span>

    <span class="n">context</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">usedIn</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">factory</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">document</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">usedIn</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="defineGroupingDirective"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.defineGroupingDirective">[docs]</a><span class="k">def</span> <span class="nf">defineGroupingDirective</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span>
                            <span class="n">namespace</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">usedIn</span><span class="o">=</span><span class="n">IConfigurationContext</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Define a grouping directive</span>

<span class="sd">    Define and register a factory that sets up a grouping directive.</span>

<span class="sd">    If the namespace is &#39;*&#39;, the directive is registered for all namespaces.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">namespace</span> <span class="o">=</span> <span class="n">namespace</span> <span class="ow">or</span> <span class="n">context</span><span class="o">.</span><span class="n">namespace</span>
    <span class="k">if</span> <span class="n">namespace</span> <span class="o">!=</span> <span class="s">&#39;*&#39;</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">factory</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">toargs</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">newcontext</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="n">newcontext</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>
        <span class="k">return</span> <span class="n">GroupingStackItem</span><span class="p">(</span><span class="n">newcontext</span><span class="p">)</span>
    <span class="n">factory</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span>

    <span class="n">context</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">usedIn</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">factory</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">document</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">usedIn</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="IComplexDirectiveContext"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.IComplexDirectiveContext">[docs]</a><span class="k">class</span> <span class="nc">IComplexDirectiveContext</span><span class="p">(</span><span class="n">IFullInfo</span><span class="p">,</span> <span class="n">IConfigurationContext</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<span class="nd">@implementer</span><span class="p">(</span><span class="n">IComplexDirectiveContext</span><span class="p">)</span>
<div class="viewcode-block" id="ComplexDirectiveDefinition"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.ComplexDirectiveDefinition">[docs]</a><span class="k">class</span> <span class="nc">ComplexDirectiveDefinition</span><span class="p">(</span><span class="n">GroupingContextDecorator</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handler for defining complex directives</span>

<span class="sd">    See the description and tests for ComplexStackItem.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">before</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">factory</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ComplexStackItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
        <span class="n">factory</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">usedIn</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">factory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">usedIn</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="subdirective"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.subdirective">[docs]</a><span class="k">def</span> <span class="nf">subdirective</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
    <span class="n">context</span><span class="o">.</span><span class="n">document</span><span class="p">((</span><span class="n">context</span><span class="o">.</span><span class="n">namespace</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span> <span class="n">schema</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">usedIn</span><span class="p">,</span>
                     <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">handler</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">handler</span><span class="p">),</span>
                     <span class="n">context</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">schema</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">info</span>

<span class="c">##############################################################################</span>
<span class="c"># Features</span>
</div>
<div class="viewcode-block" id="IProvidesDirectiveInfo"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.IProvidesDirectiveInfo">[docs]</a><span class="k">class</span> <span class="nc">IProvidesDirectiveInfo</span><span class="p">(</span><span class="n">Interface</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Information for a &lt;meta:provides&gt; directive&quot;&quot;&quot;</span>

    <span class="n">feature</span> <span class="o">=</span> <span class="n">TextLine</span><span class="p">(</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">u</span><span class="p">(</span><span class="s">&quot;Feature name&quot;</span><span class="p">),</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">u</span><span class="p">(</span><span class="s">&quot;&quot;&quot;The name of the feature being provided</span>

<span class="s">        You can test available features with zcml:condition=&quot;have featurename&quot;.</span>
<span class="s">        &quot;&quot;&quot;</span><span class="p">),</span>
        <span class="p">)</span>
</div>
<div class="viewcode-block" id="provides"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.provides">[docs]</a><span class="k">def</span> <span class="nf">provides</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">feature</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Declare that a feature is provided in context.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Only one feature name allowed&quot;</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">provideFeature</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>


<span class="c">##############################################################################</span>
<span class="c"># Argument conversion</span>
</div>
<div class="viewcode-block" id="toargs"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.toargs">[docs]</a><span class="k">def</span> <span class="nf">toargs</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Marshal data to an argument dictionary using a schema</span>

<span class="sd">    Names that are python keywords have an underscore added as a</span>
<span class="sd">    suffix in the schema and in the argument list, but are used</span>
<span class="sd">    without the underscore in the data.</span>

<span class="sd">    The fields in the schema must all implement IFromUnicode.</span>

<span class="sd">    All of the items in the data must have corresponding fields in the</span>
<span class="sd">    schema unless the schema has a true tagged value named</span>
<span class="sd">    &#39;keyword_arguments&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">schema</span><span class="o">.</span><span class="n">namesAndDescriptions</span><span class="p">(</span><span class="bp">True</span><span class="p">):</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">iskeyword</span><span class="p">(</span><span class="n">n</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">text_type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">fromUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">reraise</span><span class="p">(</span><span class="n">ConfigurationError</span><span class="p">(</span><span class="s">&quot;Invalid value for&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)),</span>
                        <span class="bp">None</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">required</span><span class="p">:</span>
            <span class="c"># if the default is valid, we can use that:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">field</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ValidationError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s">&quot;Missing parameter:&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">args</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="n">default</span>

    <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
        <span class="c"># we had data left over</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">keyword_arguments</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">getTaggedValue</span><span class="p">(</span><span class="s">&#39;keyword_arguments&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">keyword_arguments</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keyword_arguments</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ConfigurationError</span><span class="p">(</span><span class="s">&quot;Unrecognized parameters:&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">args</span>

<span class="c">##############################################################################</span>
<span class="c"># Conflict resolution</span>
</div>
<div class="viewcode-block" id="expand_action"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.expand_action">[docs]</a><span class="k">def</span> <span class="nf">expand_action</span><span class="p">(</span><span class="n">discriminator</span><span class="p">,</span> <span class="nb">callable</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">kw</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">includepath</span><span class="o">=</span><span class="p">(),</span> <span class="n">info</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">kw</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">extra</span>
    <span class="n">action</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="nb">dict</span><span class="p">(</span>
            <span class="n">discriminator</span><span class="o">=</span><span class="n">discriminator</span><span class="p">,</span>
            <span class="nb">callable</span><span class="o">=</span><span class="nb">callable</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
            <span class="n">kw</span><span class="o">=</span><span class="n">kw</span><span class="p">,</span>
            <span class="n">includepath</span><span class="o">=</span><span class="n">includepath</span><span class="p">,</span>
            <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
            <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">action</span>
</div>
<div class="viewcode-block" id="resolveConflicts"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.resolveConflicts">[docs]</a><span class="k">def</span> <span class="nf">resolveConflicts</span><span class="p">(</span><span class="n">actions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Resolve conflicting actions</span>

<span class="sd">    Given an actions list, identify and try to resolve conflicting actions.</span>
<span class="sd">    Actions conflict if they have the same non-None discriminator.</span>
<span class="sd">    Conflicting actions can be resolved if the include path of one of</span>
<span class="sd">    the actions is a prefix of the includepaths of the other</span>
<span class="sd">    conflicting actions and is unequal to the include paths in the</span>
<span class="sd">    other conflicting actions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># organize actions by discriminators</span>
    <span class="n">unique</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">action</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">actions</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c"># old-style tuple action</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">expand_action</span><span class="p">(</span><span class="o">*</span><span class="n">action</span><span class="p">)</span>

        <span class="c"># &quot;order&quot; is an integer grouping. Actions in a lower order will be</span>
        <span class="c"># executed before actions in a higher order.  Within an order,</span>
        <span class="c"># actions are executed sequentially based on original action ordering</span>
        <span class="c"># (&quot;i&quot;).</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="s">&#39;order&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span>
        <span class="n">discriminator</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="s">&#39;discriminator&#39;</span><span class="p">]</span>

        <span class="c"># &quot;ainfo&quot; is a tuple of (order, i, action) where &quot;order&quot; is a</span>
        <span class="c"># user-supplied grouping, &quot;i&quot; is an integer expressing the relative</span>
        <span class="c"># position of this action in the action list being resolved, and</span>
        <span class="c"># &quot;action&quot; is an action dictionary.  The purpose of an ainfo is to</span>
        <span class="c"># associate an &quot;order&quot; and an &quot;i&quot; with a particular action; &quot;order&quot;</span>
        <span class="c"># and &quot;i&quot; exist for sorting purposes after conflict resolution.</span>
        <span class="n">ainfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">discriminator</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># The discriminator is None, so this action can never conflict.</span>
            <span class="c"># We can add it directly to the result.</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ainfo</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">L</span> <span class="o">=</span> <span class="n">unique</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">discriminator</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">L</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ainfo</span><span class="p">)</span>

    <span class="c"># Check for conflicts</span>
    <span class="n">conflicts</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">discriminator</span><span class="p">,</span> <span class="n">ainfos</span> <span class="ow">in</span> <span class="n">unique</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="c"># We use (includepath, order, i) as a sort key because we need to</span>
        <span class="c"># sort the actions by the paths so that the shortest path with a</span>
        <span class="c"># given prefix comes first.  The &quot;first&quot; action is the one with the</span>
        <span class="c"># shortest include path.  We break sorting ties using &quot;order&quot;, then</span>
        <span class="c"># &quot;i&quot;.</span>
        <span class="k">def</span> <span class="nf">bypath</span><span class="p">(</span><span class="n">ainfo</span><span class="p">):</span>
            <span class="n">path</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">ainfo</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s">&#39;includepath&#39;</span><span class="p">],</span> <span class="n">ainfo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ainfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">path</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">i</span>

        <span class="n">ainfos</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">bypath</span><span class="p">)</span>
        <span class="n">ainfo</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">ainfos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ainfos</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ainfo</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">action</span> <span class="o">=</span> <span class="n">ainfo</span>
        <span class="n">basepath</span><span class="p">,</span> <span class="n">baseinfo</span><span class="p">,</span> <span class="n">discriminator</span> <span class="o">=</span> <span class="p">(</span><span class="n">action</span><span class="p">[</span><span class="s">&#39;includepath&#39;</span><span class="p">],</span>
                                             <span class="n">action</span><span class="p">[</span><span class="s">&#39;info&#39;</span><span class="p">],</span>
                                             <span class="n">action</span><span class="p">[</span><span class="s">&#39;discriminator&#39;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">rest</span><span class="p">:</span>
            <span class="n">includepath</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="s">&#39;includepath&#39;</span><span class="p">]</span>
            <span class="c"># Test whether path is a prefix of opath</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">includepath</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">basepath</span><span class="p">)]</span> <span class="o">!=</span> <span class="n">basepath</span> <span class="c"># not a prefix</span>
                <span class="ow">or</span> <span class="n">includepath</span> <span class="o">==</span> <span class="n">basepath</span><span class="p">):</span>
                <span class="n">L</span> <span class="o">=</span> <span class="n">conflicts</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">discriminator</span><span class="p">,</span> <span class="p">[</span><span class="n">baseinfo</span><span class="p">])</span>
                <span class="n">L</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="p">[</span><span class="s">&#39;info&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">conflicts</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ConfigurationConflictError</span><span class="p">(</span><span class="n">conflicts</span><span class="p">)</span>

    <span class="c"># Sort conflict-resolved actions by (order, i) and return them.</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))]</span>

</div>
<div class="viewcode-block" id="ConfigurationConflictError"><a class="viewcode-back" href="../../../api/config.html#zope.configuration.config.ConfigurationConflictError">[docs]</a><span class="k">class</span> <span class="nc">ConfigurationConflictError</span><span class="p">(</span><span class="n">ConfigurationError</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conflicts</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conflicts</span> <span class="o">=</span> <span class="n">conflicts</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c">#pragma NO COVER</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;Conflicting configuration actions&quot;</span><span class="p">]</span>
        <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_conflicts</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="n">items</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">discriminator</span><span class="p">,</span> <span class="n">infos</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;  For: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">discriminator</span><span class="p">,</span> <span class="p">))</span>
            <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">infos</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text_type</span><span class="p">(</span><span class="n">info</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">u</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)):</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="p">(</span><span class="s">&quot;    &quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>

        <span class="k">return</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>


<span class="c">##############################################################################</span>
<span class="c"># Bootstap code</span>

</div>
<span class="k">def</span> <span class="nf">_bootstrap</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>

    <span class="c"># Set enough machinery to register other directives</span>

    <span class="c"># Define the directive (simple directive) directive by calling it&#39;s</span>
    <span class="c"># handler directly</span>

    <span class="n">info</span> <span class="o">=</span> <span class="s">&#39;Manually registered in zope/configuration/config.py&#39;</span>

    <span class="n">context</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">info</span>
    <span class="n">defineSimpleDirective</span><span class="p">(</span>
        <span class="n">context</span><span class="p">,</span>
        <span class="n">namespace</span><span class="o">=</span><span class="n">metans</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;directive&#39;</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">=</span><span class="n">IStandaloneDirectiveInfo</span><span class="p">,</span>
        <span class="n">handler</span><span class="o">=</span><span class="n">defineSimpleDirective</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="c"># OK, now that we have that, we can use the machine to define the</span>
    <span class="c"># other directives. This isn&#39;t the easiest way to proceed, but it lets</span>
    <span class="c"># us eat our own dogfood. :)</span>

    <span class="c"># Standalone groupingDirective</span>
    <span class="n">context</span><span class="p">((</span><span class="n">metans</span><span class="p">,</span> <span class="s">&#39;directive&#39;</span><span class="p">),</span>
            <span class="n">info</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s">&#39;groupingDirective&#39;</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="n">metans</span><span class="p">,</span>
            <span class="n">handler</span><span class="o">=</span><span class="s">&quot;zope.configuration.config.defineGroupingDirective&quot;</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="s">&quot;zope.configuration.config.IStandaloneDirectiveInfo&quot;</span>
            <span class="p">)</span>

    <span class="c"># Now we can use the grouping directive to define the directives directive</span>
    <span class="n">context</span><span class="p">((</span><span class="n">metans</span><span class="p">,</span> <span class="s">&#39;groupingDirective&#39;</span><span class="p">),</span>
            <span class="n">info</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s">&#39;directives&#39;</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="n">metans</span><span class="p">,</span>
            <span class="n">handler</span><span class="o">=</span><span class="s">&quot;zope.configuration.config.DirectivesHandler&quot;</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="s">&quot;zope.configuration.config.IDirectivesInfo&quot;</span>
            <span class="p">)</span>

    <span class="c"># directive and groupingDirective inside directives</span>
    <span class="n">context</span><span class="p">((</span><span class="n">metans</span><span class="p">,</span> <span class="s">&#39;directive&#39;</span><span class="p">),</span>
            <span class="n">info</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s">&#39;directive&#39;</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="n">metans</span><span class="p">,</span>
            <span class="n">usedIn</span><span class="o">=</span><span class="s">&quot;zope.configuration.config.IDirectivesContext&quot;</span><span class="p">,</span>
            <span class="n">handler</span><span class="o">=</span><span class="s">&quot;zope.configuration.config.defineSimpleDirective&quot;</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="s">&quot;zope.configuration.config.IFullInfo&quot;</span>
            <span class="p">)</span>
    <span class="n">context</span><span class="p">((</span><span class="n">metans</span><span class="p">,</span> <span class="s">&#39;directive&#39;</span><span class="p">),</span>
            <span class="n">info</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s">&#39;groupingDirective&#39;</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="n">metans</span><span class="p">,</span>
            <span class="n">usedIn</span><span class="o">=</span><span class="s">&quot;zope.configuration.config.IDirectivesContext&quot;</span><span class="p">,</span>
            <span class="n">handler</span><span class="o">=</span><span class="s">&quot;zope.configuration.config.defineGroupingDirective&quot;</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="s">&quot;zope.configuration.config.IFullInfo&quot;</span>
            <span class="p">)</span>

    <span class="c"># Setup complex directive directive, both standalone, and in</span>
    <span class="c"># directives directive</span>
    <span class="n">context</span><span class="p">((</span><span class="n">metans</span><span class="p">,</span> <span class="s">&#39;groupingDirective&#39;</span><span class="p">),</span>
            <span class="n">info</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s">&#39;complexDirective&#39;</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="n">metans</span><span class="p">,</span>
            <span class="n">handler</span><span class="o">=</span><span class="s">&quot;zope.configuration.config.ComplexDirectiveDefinition&quot;</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="s">&quot;zope.configuration.config.IStandaloneDirectiveInfo&quot;</span>
            <span class="p">)</span>
    <span class="n">context</span><span class="p">((</span><span class="n">metans</span><span class="p">,</span> <span class="s">&#39;groupingDirective&#39;</span><span class="p">),</span>
            <span class="n">info</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s">&#39;complexDirective&#39;</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="n">metans</span><span class="p">,</span>
            <span class="n">usedIn</span><span class="o">=</span><span class="s">&quot;zope.configuration.config.IDirectivesContext&quot;</span><span class="p">,</span>
            <span class="n">handler</span><span class="o">=</span><span class="s">&quot;zope.configuration.config.ComplexDirectiveDefinition&quot;</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="s">&quot;zope.configuration.config.IFullInfo&quot;</span>
            <span class="p">)</span>

    <span class="c"># Finally, setup subdirective directive</span>
    <span class="n">context</span><span class="p">((</span><span class="n">metans</span><span class="p">,</span> <span class="s">&#39;directive&#39;</span><span class="p">),</span>
            <span class="n">info</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s">&#39;subdirective&#39;</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="n">metans</span><span class="p">,</span>
            <span class="n">usedIn</span><span class="o">=</span><span class="s">&quot;zope.configuration.config.IComplexDirectiveContext&quot;</span><span class="p">,</span>
            <span class="n">handler</span><span class="o">=</span><span class="s">&quot;zope.configuration.config.subdirective&quot;</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="s">&quot;zope.configuration.config.IDirectiveInfo&quot;</span>
            <span class="p">)</span>

    <span class="c"># meta:provides</span>
    <span class="n">context</span><span class="p">((</span><span class="n">metans</span><span class="p">,</span> <span class="s">&#39;directive&#39;</span><span class="p">),</span>
            <span class="n">info</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s">&#39;provides&#39;</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="n">metans</span><span class="p">,</span>
            <span class="n">handler</span><span class="o">=</span><span class="s">&quot;zope.configuration.config.provides&quot;</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="s">&quot;zope.configuration.config.IProvidesDirectiveInfo&quot;</span>
            <span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">zope.configuration 4.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Zope Foundation Contributors.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>